// ============================================================================
// üîí CADEADO DE CONTRATO - AUTH ROUTES (Sistema de Autentica√ß√£o)
// ============================================================================
// ‚ö†Ô∏è CONTRATO ESTABELECIDO - N√ÉO MODIFICAR SEM ATUALIZAR CONTRATO
// 
// ESTA FUNCIONALIDADE EST√Å FUNCIONANDO EM PRODU√á√ÉO
// 
// CONTRATO DA API (O QUE A C√ÅPSULA ESPERA):
// 
// INPUT (Request):
// - POST /rendizy-server/auth/login
//   Body: { username: string, password: string }
//   Headers: { apikey: string }
// 
// - GET /rendizy-server/auth/me
//   Headers: { Authorization: "Bearer <token>", apikey: string }
// 
// - POST /rendizy-server/auth/logout
//   Headers: { Authorization: "Bearer <token>", apikey: string }
// 
// - POST /rendizy-server/auth/refresh
//   Body: { refresh_token: string }
//   Headers: { apikey: string }
// 
// OUTPUT (Response):
// - Success: { success: true, data: { token: string, user: User, organization?: Organization } }
// - Error: { success: false, error: string }
// 
// DEPEND√äNCIAS FRONTEND (QUEM USA ESTE CONTRATO):
// - AuthContext.tsx ‚Üí authServiceLogin(), authServiceLogout(), getCurrentUser()
// - ProtectedRoute.tsx ‚Üí Verifica token via AuthContext
// - MainSidebar.tsx ‚Üí Usa AuthContext para exibir user/organization
// 
// ENTRELACEAMENTOS DOCUMENTADOS (OK - Sistemas se comunicam):
// - ‚úÖ Todas as c√°psulas ‚Üí Dependem de AuthContext para autentica√ß√£o
// - ‚úÖ ProtectedRoute ‚Üí Usa AuthContext para proteger rotas
// - ‚úÖ MainSidebar ‚Üí Usa AuthContext para exibir informa√ß√µes do usu√°rio
// 
// ‚ö†Ô∏è SE MODIFICAR CONTRATO:
// 1. ‚úÖ Criar vers√£o v2 da rota (manter v1 funcionando)
// 2. ‚úÖ Atualizar frontend gradualmente
// 3. ‚úÖ S√≥ remover v1 quando TODOS migrarem
// 4. ‚úÖ Executar: npm run test:auth-contract
// 
// VALIDA√á√ÉO DO CONTRATO:
// - Executar: npm run test:auth
// - Verificar: scripts/check-auth-contract.js
// 
// ‚ö†Ô∏è NUNCA REMOVER ROTAS SEM CRIAR VERS√ÉO ALTERNATIVA
// ============================================================================

import { Hono } from 'npm:hono';
import { createHash } from 'node:crypto';
// ‚úÖ ARQUITETURA SQL: Importar Supabase Client
import { createClient } from 'jsr:@supabase/supabase-js@2.49.8';
// ‚úÖ Usar getSessionFromToken que j√° funciona em outras rotas
import { getSessionFromToken } from './utils-session.ts';
import { SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY, SUPABASE_URL } from './utils-env.ts';

// Helper: Obter cliente Supabase
// ‚úÖ DESABILITADO JWT VALIDATION - Usar SERVICE_ROLE_KEY que bypassa JWT
function getSupabaseClient() {
  const supabaseUrl = SUPABASE_URL;
  const serviceRoleKey = SUPABASE_SERVICE_ROLE_KEY;
  
  // ‚úÖ SOLU√á√ÉO: SERVICE_ROLE_KEY bypassa completamente valida√ß√£o JWT
  // N√£o precisa de configura√ß√µes especiais - SERVICE_ROLE_KEY j√° ignora JWT
  return createClient(supabaseUrl, serviceRoleKey);
}

const app = new Hono();

// Tipos
interface SuperAdmin {
  id: string;
  username: string;
  passwordHash: string;
  name: string;
  email: string;
  type: 'superadmin';
  status: 'active' | 'suspended';
  createdAt: string;
  lastLogin?: string;
}

interface UsuarioImobiliaria {
  id: string;
  imobiliariaId: string;
  username: string;
  passwordHash: string;
  name: string;
  email: string;
  role: 'admin' | 'manager' | 'staff' | 'readonly';
  type: 'imobiliaria';
  status: 'active' | 'invited' | 'suspended';
  createdAt: string;
  lastLogin?: string;
  permissions?: string[];
}

interface Session {
  id: string;
  userId: string;
  username: string;
  type: 'superadmin' | 'imobiliaria';
  imobiliariaId?: string;
  createdAt: string;
  expiresAt: string;
  lastActivity: string;
}

// Helper: Gerar hash de senha
function hashPassword(password: string): string {
  return createHash('sha256').update(password).digest('hex');
}

// Helper: Verificar senha
function verifyPassword(password: string, hash: string): boolean {
  return hashPassword(password) === hash;
}

// Helper: Gerar ID de sess√£o
// ‚úÖ Usa randomUUID para evitar colis√µes previs√≠veis e seguir boas pr√°ticas de gera√ß√£o de IDs
function generateSessionId(): string {
  return `session_${crypto.randomUUID()}`;
}

// Helper: Gerar token de sess√£o
// ‚ùó Importante: tokens precisam ser longos, imprevis√≠veis e resilientes a reuso em m√∫ltiplas abas
//  - 64 bytes rand√¥micos ‚Üí 128 caracteres hexadecimais (~10^154 combina√ß√µes)
//  - Usa crypto.getRandomValues (dispon√≠vel no runtime do Supabase Edge)
//  - Resolve problema de token curto (31 caracteres) identificado no relat√≥rio de login
function generateToken(bytes = 64): string {
  const randomBytes = new Uint8Array(bytes);
  crypto.getRandomValues(randomBytes);
  return Array.from(randomBytes)
    .map((b) => b.toString(16).padStart(2, '0'))
    .join('');
}

// ‚ùå REMOVIDO: initializeSuperAdmin() - SuperAdmins agora s√£o criados na migration SQL
// Ver: supabase/migrations/20241120_create_users_table.sql

// POST /auth/login - Login
app.post('/login', async (c) => {
  try {
    console.log('üîê ============================================');
    console.log('üîê POST /auth/login - Tentativa de login');
    console.log('üîê URL:', c.req.url);
    console.log('üîê Path:', c.req.path);
    console.log('üîê Method:', c.req.method);
    console.log('üîê ============================================');
    
    let body;
    try {
      body = await c.req.json();
      console.log('üîê Body recebido:', { username: body.username, hasPassword: !!body.password });
    } catch (e) {
      console.error('‚ùå Erro ao parsear JSON:', e);
      return c.json({
        success: false,
        error: 'Erro ao processar requisi√ß√£o'
      }, 400);
    }
    
    const { username, password } = body;

    if (!username || !password) {
      return c.json({
        success: false,
        error: 'Usu√°rio e senha s√£o obrigat√≥rios'
      }, 400);
    }

    console.log('üë§ Login attempt:', { username });
    // MODO LOCAL: sem PostgREST/DB, retorna usu√°rio admin fake
    if (Deno.env.get('LOCAL_MODE') === 'true') {
      const token = generateToken(32);
      return c.json({
        success: true,
        data: {
          token,
          refresh_token: generateToken(32),
          user: {
            id: 'local-admin',
            username: 'admin',
            type: 'superadmin',
            organization: null
          }
        }
      });
    }


    // ‚úÖ ARQUITETURA SQL: Buscar usu√°rio da tabela SQL ao inv√©s de KV Store
    const supabase = getSupabaseClient();
    
    // Verificar se tabela users existe (debug)
    const { data: allUsers, error: checkError } = await supabase
      .from('users')
      .select('id, username, type')
      .limit(5);
    
    if (checkError) {
      console.error('‚ùå ERRO CR√çTICO: Tabela users n√£o existe ou erro de acesso:', checkError);
      return c.json({
        success: false,
        error: `Erro ao acessar tabela users: ${checkError.message}`,
        details: checkError.code || 'UNKNOWN_ERROR'
      }, 500);
    }
    
    console.log('‚úÖ Tabela users acess√≠vel. Usu√°rios encontrados:', allUsers?.length || 0);
    
    // Buscar usu√°rio na tabela SQL
    const { data: user, error: userError } = await supabase
      .from('users')
      .select('*')
      .eq('username', username)
      .maybeSingle();
    
    if (userError) {
      console.error('‚ùå Erro ao buscar usu√°rio:', userError);
      return c.json({
        success: false,
        error: `Erro ao buscar usu√°rio: ${userError.message}`,
        details: userError.code || 'QUERY_ERROR'
      }, 500);
    }
    
    // Se n√£o encontrou usu√°rio, retornar erro
    if (!user) {
      console.log('‚ùå Usu√°rio n√£o encontrado:', username);
      console.log('üìã Usu√°rios dispon√≠veis na tabela:', allUsers?.map(u => u.username) || []);
      return c.json({
        success: false,
        error: 'Usu√°rio ou senha incorretos'
      }, 401);
    }
    
    console.log('‚úÖ Usu√°rio encontrado na tabela SQL:', { id: user.id, username: user.username, type: user.type });
    
    // 1. Verificar se √© SuperAdmin ou usu√°rio de organiza√ß√£o
    if (user.type === 'superadmin' || user.type === 'imobiliaria' || user.type === 'staff') {
      // ‚úÖ ARQUITETURA SQL: Verificar senha usando hash do banco
      const computedHash = hashPassword(password);
      console.log('üîç Verificando senha:', { 
        username, 
        passwordProvided: password ? 'SIM' : 'N√ÉO',
        passwordLength: password?.length,
        passwordHashLength: user.password_hash?.length,
        passwordHashPrefix: user.password_hash?.substring(0, 20),
        computedHash: computedHash,
        storedHash: user.password_hash,
        hashesMatch: computedHash === user.password_hash
      });
      
      const passwordValid = verifyPassword(password, user.password_hash);
      console.log('üîç Resultado da verifica√ß√£o de senha:', passwordValid);
      
