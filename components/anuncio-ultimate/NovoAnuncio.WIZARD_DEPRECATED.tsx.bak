/**
 * RENDIZY - Novo An√∫ncio Ultimate (Wizard)
 * 
 * Wizard de cria√ß√£o de an√∫ncio campo-por-campo com persist√™ncia SQL garantida
 * Design baseado no Properties V1 mas com l√≥gica totalmente reescrita
 * 
 * @version 1.0.103.332
 * @date 2025-12-13
 */

// ‚úÖ LOG DE CARREGAMENTO DO M√ìDULO - FOR√áA RELOAD
console.log('üî• NovoAnuncio.tsx CARREGADO - V1.0.103.332 - ' + new Date().toISOString());

import { useState, useEffect, useRef } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import { ArrowLeft, Check, Clock, AlertCircle, Save, Loader2, Car, MapPin, Image as ImageIcon, Wifi, Plus, Trash2, X, Star, Eye, Search, Cable, CheckSquare, ChevronDown, CheckCircle2, Calendar as CalendarIcon } from 'lucide-react';
import { Button } from '../ui/button';
import { Input } from '../ui/input';
import { Label } from '../ui/label';
import { Textarea } from '../ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../ui/select';
import { Checkbox } from '../ui/checkbox';
import { RadioGroup, RadioGroupItem } from '../ui/radio-group';
import { Badge } from '../ui/badge';
import { Card, CardContent } from '../ui/card';
import { ScrollArea } from '../ui/scroll-area';
import { Separator } from '../ui/separator';
import { Calendar } from '../ui/calendar';
import { Popover, PopoverContent, PopoverTrigger } from '../ui/popover';
import { toast } from 'sonner';
import { cn } from '../ui/utils';
import { LOCATION_AMENITIES, LISTING_AMENITIES } from '../../utils/amenities-categories';
import { format } from 'date-fns';
import { ptBR } from 'date-fns/locale';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

// ============================================================================
// CONSTANTS - TIPOS DE CAMAS (AIRBNB/BOOKING)
// ============================================================================

const BED_TYPES = [
  { id: 'cama-casal-1p', name: 'Cama 1p de Casal', icon: 'üõèÔ∏è', capacity: 2 },
  { id: 'cama-solteiro-2p', name: 'Cama 2p de Solteiro', icon: 'üõèÔ∏è', capacity: 2 },
  { id: 'cama-queen-1p', name: 'Cama 1p de Queen', icon: 'üõèÔ∏è', capacity: 2 },
  { id: 'cama-king-1p', name: 'Cama Dupla (King)', icon: 'üõèÔ∏è', capacity: 2 },
  { id: 'beliche-1p-2pessoas', name: 'Cama 1p de Beliche (2 pessoas)', icon: 'üõèÔ∏è', capacity: 2 },
  { id: 'berco-baby', name: 'Cama Ber√ßo (Ber√ßo/Baby)', icon: 'üë∂', capacity: 1 },
  { id: 'futon-casal', name: 'Colch√£o (Futon Casal)', icon: 'üõãÔ∏è', capacity: 2 },
  { id: 'sofa-cama-casal', name: 'Sof√°-cama (p/ Casal)', icon: 'üõãÔ∏è', capacity: 2 },
];

// ============================================================================
// CONSTANTS - TIPOS DE C√îMODO
// ============================================================================

const ROOM_TYPES = [
  { id: 'suite', name: 'Su√≠te', icon: 'üõèÔ∏è', category: 'bedroom', hasBathroom: true },
  { id: 'quarto-duplo', name: 'Quarto Duplo/Std/Eco', icon: 'üõèÔ∏è', category: 'bedroom' },
  { id: 'quarto-individual', name: 'Individual', icon: 'üõèÔ∏è', category: 'bedroom' },
  { id: 'estudio', name: 'Est√∫dio', icon: 'üè†', category: 'bedroom' },
  { id: 'sala-comum', name: 'Sala/Estar Comum', icon: 'üè†', category: 'living' },
  { id: 'area-comum', name: '√°rea/√Årea Comum', icon: 'üè†', category: 'living' },
  { id: 'banheiro', name: 'Banheiro', icon: 'üöø', category: 'bathroom' },
  { id: 'meio-banheiro', name: '1/2 Banheiro', icon: 'üöΩ', category: 'bathroom' },
  { id: 'balcao', name: 'Balc√£o', icon: 'üå≥', category: 'outdoor' },
  { id: 'sotao', name: 'Sot√£o', icon: 'üèöÔ∏è', category: 'other' },
  { id: 'subarea', name: 'Sub√°rea', icon: 'üèóÔ∏è', category: 'other' },
  { id: 'outras', name: 'Outras Depend√™ncias', icon: 'üö™', category: 'other' },
];

// ============================================================================
// CONSTANTS - NOMES PERSONALIZADOS PARA "OUTRAS DEPEND√äNCIAS"
// ============================================================================

const CUSTOM_SPACE_NAMES = [
  'Academia', 'Adega', '√Årea Comum Externa', '√Årea de Lazer', '√Årea de Servi√ßo',
  'Ateli√™', 'Banheiro Externo', 'Biblioteca', 'Brinquedoteca', 'Chal√©',
  'Churrasqueira', 'Closet', 'Cobertura', 'Corredor', 'Cozinha',
  'Cozinha Gourmet', 'Deck', 'Depend√™ncia de Empregada', 'Dep√≥sito', 'Despensa',
  'Elevador', 'Entrada', 'Espa√ßo Externo', 'Espa√ßo Gourmet', 'Escrit√≥rio',
  'Estacionamento', 'Garagem', 'Gazebo', 'Hall', 'Hidromassagem',
  'Home Office', 'Home Theater', 'Jacuzzi', 'Jardim', 'Jardim de Inverno',
  'Laborat√≥rio', 'Lavabo', 'Lavanderia', 'Mirante', 'P√°tio',
  'Pergolado', 'Piscina', 'Playground', 'Quadra Esportiva', 'Quiosque',
  'Sala de Estar', 'Sala de Jantar', 'Sala de Jogos', 'Sala de TV',
  'Sal√£o de Festas', 'Sauna', 'Sol√°rio', 'Spa', 'Terra√ßo',
  'Varanda', 'Varanda Gourmet', 'Vesti√°rio', 'Outro (especificar)',
].sort();

// ============================================================================
// CONSTANTS - TAGS DE FOTOS
// ============================================================================

const PHOTO_TAGS = [
  'Academia / Espa√ßo Fitness', 'Alimentos e Bebidas', 'Almo√ßo', 'Animais', 'Animais de Estima√ß√£o',
  '√Årea de Compras', '√Årea de estar', '√Årea e instala√ß√µes', '√Årea para caf√© / ch√°',
  'Arredores', 'Atividades', 'Banheira/jacuzzi', 'Banheiro', 'Banheiro compartilhado',
  'Caf√© da manh√£', 'Cama', 'Centro de neg√≥cios', 'Cozinha', 'Entrada', 'Escrit√≥rio',
  'Espa√ßo de trabalho', 'Estacionamento', 'Fachada', 'Jardim', 'Lavanderia',
  'Lobby', 'Piscina', 'Quarto', 'Recep√ß√£o', 'Restaurante', 'Sala de estar',
  'Terra√ßo', 'Varanda', 'Vista exterior', 'Vista interior',
  // Tags de SEO para Airbnb/Booking
  'Vista do Mar', 'Vista para Montanha', 'Vista Panor√¢mica', 'Vista da Cidade',
  'Vista do Jardim', 'Vista da Piscina', 'Vista do Lago', 'Vista do Rio',
  'Sacada', 'Churrasqueira', '√Årea Gourmet', 'Hidromassagem', 'Sauna',
  'Sala de Jogos', 'Home Theater', 'Ar Condicionado', 'Aquecimento',
  'Lareira', 'Mesa de Bilhar', 'Mesa de Ping Pong', 'Lavabo',
  'Closet', 'Suite Master', 'Varanda com Rede', 'Deck',
  'Gazebo', 'Quadra Esportiva', 'Playground', 'Espa√ßo Pet',
];

interface Step {
  id: number;
  title: string;
  required: boolean;
  status: 'pending' | 'processing' | 'completed';
}

const STEPS: Step[] = [
  { id: 1, title: 'Tipo e Identifica√ß√£o', required: true, status: 'processing' },
  { id: 2, title: 'Localiza√ß√£o', required: true, status: 'pending' },
  { id: 3, title: 'C√¥modos e Fotos', required: true, status: 'pending' },
  { id: 4, title: 'Tour Virtual', required: false, status: 'pending' },
  { id: 5, title: 'Amenidades do Local', required: false, status: 'pending' },
  { id: 6, title: 'Amenidades da Acomoda√ß√£o', required: false, status: 'pending' },
  { id: 7, title: 'Descri√ß√£o', required: true, status: 'pending' },
  { id: 8, title: 'Configura√ß√£o de Relacionamento', required: true, status: 'pending' },
  { id: 9, title: 'Pre√ßos Loca√ß√£o e Venda', required: false, status: 'pending' },
  { id: 10, title: 'Configura√ß√£o de Pre√ßo Temporada', required: false, status: 'pending' },
  { id: 11, title: 'Precifica√ß√£o Individual', required: false, status: 'pending' },
  { id: 12, title: 'Pre√ßos Derivados', required: false, status: 'pending' },
];

export const NovoAnuncio = () => {
  const navigate = useNavigate();
  const { id } = useParams();
  
  const [currentStep, setCurrentStep] = useState(1);
  const [anuncioId, setAnuncioId] = useState<string | null>(id || null);
  const [steps, setSteps] = useState<Step[]>(STEPS);
  const [isLoading, setIsLoading] = useState(false);

  // Helpers: safe string and whitelists for selects
  const asString = (val: unknown, fallback = ''): string => {
    if (val === null || val === undefined) return fallback;
    return typeof val === 'string' ? val : String(val);
  };

  const allowedTipoLocal = new Set([
    'acomodacao_movel','albergue','apartamento','apartamento_residencial','bangalo','barco','barco_beira','boutique','cabana','cama_cafe','camping','casa','casa_movel','castelo','chale','chale_camping','condominio','estalagem','fazenda','hotel','hotel_boutique','hostel','iate','industrial','motel','pousada','residencia','resort','treehouse','villa'
  ]);
  const allowedTipoAcomodacao = new Set([
    'apartamento','bangalo','cabana','camping','capsula','casa','casa_dormitorios','chale','condominio','dormitorio','estudio','holiday_home','hostel','hotel','iate','industrial','loft','quarto_compartilhado','quarto_inteiro','quarto_privado','suite','treehouse','villa'
  ]);
  const allowedSubtype = new Set(['entire_place','private_room','shared_room']);

  // Step 1 - Tipo e Identifica√ß√£o
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [tipoLocal, setTipoLocal] = useState(''); // Tipo de local
  const [tipoAcomodacao, setTipoAcomodacao] = useState(''); // Tipo de acomoda√ß√£o
  const [subtype, setSubtype] = useState('');
  const [modalidades, setModalidades] = useState<string[]>([]);
  const [estrutura, setEstrutura] = useState<'individual' | 'vinculado'>('individual');
  
  // Step 2 - Localiza√ß√£o
  const [pais, setPais] = useState('Brasil');
  const [estado, setEstado] = useState('');
  const [siglaEstado, setSiglaEstado] = useState('');
  const [cep, setCep] = useState('');
  const [cidade, setCidade] = useState('');
  const [bairro, setBairro] = useState('');
  const [rua, setRua] = useState('');
  const [numero, setNumero] = useState('');
  const [complemento, setComplemento] = useState('');
  const [mostrarNumero, setMostrarNumero] = useState(true);
  const [tipoAcesso, setTipoAcesso] = useState('portaria');
  const [instrucoesAcesso, setInstrucoesAcesso] = useState('');
  const [possuiElevador, setPossuiElevador] = useState(false);
  const [estacionamento, setEstacionamento] = useState(false);
  const [tipoEstacionamento, setTipoEstacionamento] = useState('');
  const [internetCabo, setInternetCabo] = useState(false);
  const [internetWifi, setInternetWifi] = useState(false);
  
  // Step 3 - C√¥modos e Distribui√ß√£o (Sistema Completo)
  interface BedCount {
    [bedTypeId: string]: number;
  }

  interface Photo {
    id: string;
    url: string;
    path?: string;
    tags: string[];
    order: number;
  }

  interface Room {
    id: string;
    type: string;
    typeName: string;
    customName?: string;
    isShared: boolean;
    beds: BedCount;
    photos: Photo[];
  }

  const [rooms, setRooms] = useState<Room[]>([]);
  const [selectedRoomIndex, setSelectedRoomIndex] = useState<number>(0);
  const [selectedPhotos, setSelectedPhotos] = useState<string[]>([]);
  const [showTagsModal, setShowTagsModal] = useState(false);
  const [draggedPhotoId, setDraggedPhotoId] = useState<string | null>(null);
  const [uploadingPhotos, setUploadingPhotos] = useState(false);
  const uploadInProgressRef = useRef(false); // üõ°Ô∏è Prote√ß√£o adicional contra race conditions
  
  // Step 4 - Tour Virtual (Galeria)
  const [coverPhotoId, setCoverPhotoId] = useState<string | null>(null);
  const [selectedPhotoPreview, setSelectedPhotoPreview] = useState<Photo | null>(null);
  const [filterRoom, setFilterRoom] = useState<string>('all'); // 'all' ou roomId
  
  // Step 5 - Amenidades do Local
  const [locationAmenities, setLocationAmenities] = useState<string[]>([]);
  const [searchAmenities, setSearchAmenities] = useState('');
  const [checkInCheckout, setCheckInCheckout] = useState({ enabled: false, details: '' });
  const [parking, setParking] = useState({ enabled: false, type: '', details: '' });
  const [cableInternet, setCableInternet] = useState({ enabled: false });
  const [wifiInternet, setWifiInternet] = useState({ enabled: false });
  const [reception24h, setReception24h] = useState({ enabled: false, details: '' });
  const [collapsedCategories, setCollapsedCategories] = useState<Record<string, boolean>>({});

  // Step 6 - Amenidades da Acomoda√ß√£o
  const [listingAmenities, setListingAmenities] = useState<string[]>([]);
  const [searchListingAmenities, setSearchListingAmenities] = useState('');
  const [collapsedListingCategories, setCollapsedListingCategories] = useState<Record<string, boolean>>({});
  const [areaM2, setAreaM2] = useState({ enabled: false, value: '' });
  const [garagemGratuita, setGaragemGratuita] = useState({ enabled: false, quantity: '' });

  // Step 7 - Descri√ß√£o
  const [descricaoTitulo, setDescricaoTitulo] = useState({ pt: '', en: '', es: '' });
  const [notasGerais, setNotasGerais] = useState({ pt: '', en: '', es: '' });
  const [sobreEspaco, setSobreEspaco] = useState({ pt: '', en: '', es: '' });
  const [sobreAcesso, setSobreAcesso] = useState({ pt: '', en: '', es: '' });
  const [sobreAnfitriao, setSobreAnfitriao] = useState({ pt: '', en: '', es: '' });
  const [descricaoBairro, setDescricaoBairro] = useState({ pt: '', en: '', es: '' });
  const [infoLocomocao, setInfoLocomocao] = useState({ pt: '', en: '', es: '' });
  const [activeDescTab, setActiveDescTab] = useState<'pt' | 'en' | 'es'>('pt');

  // Step 8 - Configura√ß√£o de Relacionamento
  const [titularImovel, setTitularImovel] = useState('');
  const [administradorImovel, setAdministradorImovel] = useState('');
  const [dataCadastro, setDataCadastro] = useState<Date | undefined>(undefined);
  const [isSublocacao, setIsSublocacao] = useState(false);
  const [isExclusivo, setIsExclusivo] = useState(false);
  const [dataInicioContrato, setDataInicioContrato] = useState<Date | undefined>(undefined);
  const [dataFimContrato, setDataFimContrato] = useState<Date | undefined>(undefined);
  const [bloquearCalendarioAposFim, setBloquearCalendarioAposFim] = useState(false);
  const [modeloComissao, setModeloComissao] = useState<'global' | 'individual'>('global');
  const [tipoComissao, setTipoComissao] = useState<'percentage' | 'fixed_monthly'>('percentage');
  const [percentualComissao, setPercentualComissao] = useState(0);
  const [baseCalculoComissao, setBaseCalculoComissao] = useState<'accommodation_source' | 'total_daily' | 'gross_daily'>('gross_daily');
  const [considerarTaxasCanais, setConsiderarTaxasCanais] = useState(false);
  const [deduzirTaxasCanais, setDeduzirTaxasCanais] = useState(false);
  const [permitirTransferenciaExclusiva, setPermitirTransferenciaExclusiva] = useState(false);
  const [modoCobrancaEnergia, setModoCobrancaEnergia] = useState<'global' | 'individual'>('global');

  // Step 09 - Pre√ßos Loca√ß√£o e Venda
  const [tipoNegocio, setTipoNegocio] = useState<'aluguel' | 'venda' | 'ambos'>('aluguel');
  const [valorAluguel, setValorAluguel] = useState(0);
  const [valorIptu, setValorIptu] = useState(0);
  const [valorCondominio, setValorCondominio] = useState(0);
  const [taxaServico, setTaxaServico] = useState(0);
  const [valorVenda, setValorVenda] = useState(0);
  const [iptuAnual, setIptuAnual] = useState(0);
  const [aceitaFinanciamento, setAceitaFinanciamento] = useState(false);
  const [aceitaPermuta, setAceitaPermuta] = useState(false);

  // Step 10 - Configura√ß√£o de Pre√ßo Temporada
  const [modoConfigPreco, setModoConfigPreco] = useState<'global' | 'individual'>('global');
  const [regiao, setRegiao] = useState('BR');
  const [moeda, setMoeda] = useState('BRL');
  const [descontoLongaEstadia, setDescontoLongaEstadia] = useState(0);
  const [descontoSemanal, setDescontoSemanal] = useState(0);
  const [descontoMensal, setDescontoMensal] = useState(0);
  const [valorDeposito, setValorDeposito] = useState(0);
  const [usarPrecificacaoDinamica, setUsarPrecificacaoDinamica] = useState(false);
  const [taxaLimpeza, setTaxaLimpeza] = useState(0);
  const [taxaPet, setTaxaPet] = useState(0);
  const [taxaServicosExtras, setTaxaServicosExtras] = useState(0);

  // Step 11 - Precifica√ß√£o Individual
  const [precoBaseNoite, setPrecoBaseNoite] = useState(0);
  const [descontoPermanencia2Noites, setDescontoPermanencia2Noites] = useState(0);
  const [descontoPermanencia7Noites, setDescontoPermanencia7Noites] = useState(0);
  const [descontoPermanencia30Noites, setDescontoPermanencia30Noites] = useState(0);
  const [periodosSazonais, setPeriodosSazonais] = useState<any[]>([]);
  const [precosDiaSemana, setPrecosDiaSemana] = useState<any>({});
  const [datasEspeciais, setDatasEspeciais] = useState<any[]>([]);

  // Step 12 - Pre√ßos Derivados
  const [variacaoPorHospedes, setVariacaoPorHospedes] = useState(0);
  const [taxaHospedeExtra, setTaxaHospedeExtra] = useState(0);
  const [cobrarCriancas, setCobrarCriancas] = useState(false);
  const [idadeMinimaCrianca, setIdadeMinimaCrianca] = useState(0);
  const [idadeMaximaCrianca, setIdadeMaximaCrianca] = useState(12);
  const [descontoCrianca, setDescontoCrianca] = useState(0);
  
  // Estado para rastrear mudan√ßas n√£o salvas e salvamento em progresso
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  // Carregar dados existentes se estiver editando
  useEffect(() => {
    if (anuncioId) {
      setIsLoading(true);
      loadAnuncio(anuncioId);
    }
  }, [anuncioId]);

  const loadAnuncio = async (id: string) => {
    try {
      console.log('üì• [LOAD] Carregando an√∫ncio:', id);
      console.log('üì• [LOAD] URL:', `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/${id}`);
      
      const res = await fetch(`${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/${id}`, {
        headers: { 
          'Authorization': `Bearer ${ANON_KEY}`
        }
      });

      console.log('üì• [LOAD] Status:', res.status);

      // Se 404, redirecionar para lista
      if (res.status === 404) {
        console.warn('‚ö†Ô∏è [LOAD] An√∫ncio n√£o encontrado (404)');
        toast.error('An√∫ncio n√£o encontrado');
        setIsLoading(false);
        // N√ÉO redirecionar - deixar usu√°rio testar salvamento
        return;
      }

      if (!res.ok) {
        console.error('‚ùå [LOAD] HTTP Error:', res.status, res.statusText);
        throw new Error(`HTTP ${res.status}`);
      }

      const data = await res.json();
      console.log('üì• [LOAD] Data recebida:', data);
      const anuncio = data.anuncio;

      // Preencher campos do Step 1
      if (anuncio?.data) {
        setTitle(asString(anuncio.data.title, ''));
        setDescription(asString(anuncio.data.description, ''));
        const tl = asString(anuncio.data.tipo_local, '');
        setTipoLocal(allowedTipoLocal.has(tl) ? tl : '');
        const ta = asString(anuncio.data.tipo_acomodacao, '');
        setTipoAcomodacao(allowedTipoAcomodacao.has(ta) ? ta : '');
        const st = asString(anuncio.data.subtype, '');
        setSubtype(allowedSubtype.has(st) ? st : '');
        
        // Modalidades: pode vir como array ou string JSON
        let loadedModalidades: string[] = [];
        if (Array.isArray(anuncio.data.modalidades)) {
          loadedModalidades = anuncio.data.modalidades;
        } else if (typeof anuncio.data.modalidades === 'string') {
          try {
            loadedModalidades = JSON.parse(anuncio.data.modalidades);
          } catch {
            loadedModalidades = [];
          }
        }
        setModalidades(loadedModalidades);
        
        const est = asString(anuncio.data.estrutura, 'individual');
        setEstrutura(est === 'vinculado' ? 'vinculado' : 'individual');

        // Preencher campos do Step 2 (Localiza√ß√£o)
        setPais(asString(anuncio.data.pais, 'Brasil'));
        setEstado(asString(anuncio.data.estado, ''));
        setSiglaEstado(asString(anuncio.data.sigla_estado, ''));
        setCep(asString(anuncio.data.cep, ''));
        setCidade(asString(anuncio.data.cidade, ''));
        setBairro(asString(anuncio.data.bairro, ''));
        setRua(asString(anuncio.data.rua, ''));
        setNumero(asString(anuncio.data.numero, ''));
        setComplemento(asString(anuncio.data.complemento, ''));
        setMostrarNumero(anuncio.data.mostrar_numero !== false); // default true
        setTipoAcesso(asString(anuncio.data.tipo_acesso, 'portaria'));
        setInstrucoesAcesso(asString(anuncio.data.instrucoes_acesso, ''));
        
        // Campos booleanos - parse robusto (pode vir como boolean, string ou undefined)
        setPossuiElevador(anuncio.data.possui_elevador === true || anuncio.data.possui_elevador === 'true');
        setEstacionamento(anuncio.data.estacionamento === true || anuncio.data.estacionamento === 'true');
        setTipoEstacionamento(asString(anuncio.data.tipo_estacionamento, ''));
        setInternetCabo(anuncio.data.internet_cabo === true || anuncio.data.internet_cabo === 'true');
        setInternetWifi(anuncio.data.internet_wifi === true || anuncio.data.internet_wifi === 'true');
        
        console.log('üìä [LOAD] Caracter√≠sticas carregadas:', {
          possuiElevador: anuncio.data.possui_elevador,
          estacionamento: anuncio.data.estacionamento,
          internetCabo: anuncio.data.internet_cabo,
          internetWifi: anuncio.data.internet_wifi
        });

        // Preencher campos do Step 3 (C√¥modos - Sistema Completo)
        console.log('üè† [LOAD] Campo rooms no banco:', anuncio.data.rooms);
        console.log('üè† [LOAD] Tipo do campo rooms:', typeof anuncio.data.rooms);
        
        let loadedRooms: Room[] = [];
        if (anuncio.data.rooms) {
          if (typeof anuncio.data.rooms === 'string') {
            try {
              console.log('üè† [LOAD] Parseando string JSON...');
              loadedRooms = JSON.parse(anuncio.data.rooms);
              console.log('‚úÖ [LOAD] JSON parseado com sucesso:', loadedRooms);
            } catch (err) {
              console.error('‚ùå [LOAD] Erro ao parsear JSON:', err);
              loadedRooms = [];
            }
          } else if (Array.isArray(anuncio.data.rooms)) {
            console.log('‚úÖ [LOAD] Rooms j√° √© um array');
            loadedRooms = anuncio.data.rooms;
          } else {
            console.warn('‚ö†Ô∏è [LOAD] Tipo inesperado para rooms:', typeof anuncio.data.rooms);
          }
        } else {
          console.log('‚ÑπÔ∏è [LOAD] Campo rooms est√° vazio/null no banco');
        }

        // üßπ LIMPEZA: Remover blob URLs inv√°lidas (de uploads antigos)
        if (loadedRooms.length > 0) {
          let hasInvalidBlobs = false;
          loadedRooms = loadedRooms.map(room => {
            const validPhotos = room.photos.filter(photo => {
              const isBlob = photo.url.startsWith('blob:');
              if (isBlob) {
                console.warn('üßπ [CLEANUP] Removendo blob URL inv√°lida:', photo.url);
                hasInvalidBlobs = true;
              }
              return !isBlob; // Manter apenas URLs n√£o-blob
            });
            return { ...room, photos: validPhotos };
          });
          
          if (hasInvalidBlobs) {
            console.log('‚úÖ [CLEANUP] Blob URLs removidas. C√¥modos limpos:', loadedRooms.length);
          }
        }
        
        console.log('üìä [LOAD] C√¥modos carregados:', {
          rooms: loadedRooms,
          totalRooms: loadedRooms.length,
          detalhes: loadedRooms.map(r => ({ id: r.id, type: r.type, typeName: r.typeName, photos: r.photos.length }))
        });
        
        setRooms(loadedRooms);

        // Preencher campos do Step 5 (Amenidades do Local)
        if (anuncio.data.location_amenities) {
          try {
            let amenitiesData;
            if (typeof anuncio.data.location_amenities === 'string') {
              amenitiesData = JSON.parse(anuncio.data.location_amenities);
            } else {
              amenitiesData = anuncio.data.location_amenities;
            }
            
            console.log('üè® [LOAD] Amenidades do local carregadas:', amenitiesData);
            
            if (amenitiesData.tickableAmenities && Array.isArray(amenitiesData.tickableAmenities)) {
              setLocationAmenities(amenitiesData.tickableAmenities);
            }
            if (amenitiesData.checkInCheckout) {
              setCheckInCheckout(amenitiesData.checkInCheckout);
            }
            if (amenitiesData.parking) {
              setParking(amenitiesData.parking);
            }
            if (amenitiesData.cableInternet) {
              setCableInternet(amenitiesData.cableInternet);
            }
            if (amenitiesData.wifiInternet) {
              setWifiInternet(amenitiesData.wifiInternet);
            }
            if (amenitiesData.reception24h) {
              setReception24h(amenitiesData.reception24h);
            }
          } catch (err) {
            console.error('‚ùå [LOAD] Erro ao parsear location_amenities:', err);
          }
        }

        // Preencher campos do Step 6 (Amenidades da Acomoda√ß√£o)
        if (anuncio.data.listing_amenities) {
          try {
            let listingData;
            if (typeof anuncio.data.listing_amenities === 'string') {
              listingData = JSON.parse(anuncio.data.listing_amenities);
            } else {
              listingData = anuncio.data.listing_amenities;
            }
            
            console.log('üè† [LOAD] Amenidades da acomoda√ß√£o carregadas:', listingData);
            
            if (listingData.amenities && Array.isArray(listingData.amenities)) {
              setListingAmenities(listingData.amenities);
            } else if (Array.isArray(listingData)) {
              // Backward compatibility
              setListingAmenities(listingData);
            }
            if (listingData.areaM2) {
              setAreaM2(listingData.areaM2);
            }
            if (listingData.garagemGratuita) {
              setGaragemGratuita(listingData.garagemGratuita);
            }
          } catch (err) {
            console.error('‚ùå [LOAD] Erro ao parsear listing_amenities:', err);
          }
        }

        // Preencher campos do Step 7 (Descri√ß√£o)
        if (anuncio.data.descricao_titulo) {
          try {
            const titulo = typeof anuncio.data.descricao_titulo === 'string' 
              ? JSON.parse(anuncio.data.descricao_titulo) 
              : anuncio.data.descricao_titulo;
            setDescricaoTitulo(titulo);
          } catch (err) {
            console.error('‚ùå [LOAD] Erro ao parsear descricao_titulo:', err);
          }
        }
        if (anuncio.data.notas_gerais) {
          try {
            const notas = typeof anuncio.data.notas_gerais === 'string' 
              ? JSON.parse(anuncio.data.notas_gerais) 
              : anuncio.data.notas_gerais;
            setNotasGerais(notas);
          } catch (err) {
            console.error('‚ùå [LOAD] Erro ao parsear notas_gerais:', err);
          }
        }
        if (anuncio.data.sobre_espaco) {
          try {
            const espaco = typeof anuncio.data.sobre_espaco === 'string' 
              ? JSON.parse(anuncio.data.sobre_espaco) 
              : anuncio.data.sobre_espaco;
            setSobreEspaco(espaco);
          } catch (err) {
            console.error('‚ùå [LOAD] Erro ao parsear sobre_espaco:', err);
          }
        }
        if (anuncio.data.sobre_acesso) {
          try {
            const acesso = typeof anuncio.data.sobre_acesso === 'string' 
              ? JSON.parse(anuncio.data.sobre_acesso) 
              : anuncio.data.sobre_acesso;
            setSobreAcesso(acesso);
          } catch (err) {
            console.error('‚ùå [LOAD] Erro ao parsear sobre_acesso:', err);
          }
        }
        if (anuncio.data.sobre_anfitriao) {
          try {
            const anfitriao = typeof anuncio.data.sobre_anfitriao === 'string' 
              ? JSON.parse(anuncio.data.sobre_anfitriao) 
              : anuncio.data.sobre_anfitriao;
            setSobreAnfitriao(anfitriao);
          } catch (err) {
            console.error('‚ùå [LOAD] Erro ao parsear sobre_anfitriao:', err);
          }
        }
        if (anuncio.data.descricao_bairro) {
          try {
            const bairro = typeof anuncio.data.descricao_bairro === 'string' 
              ? JSON.parse(anuncio.data.descricao_bairro) 
              : anuncio.data.descricao_bairro;
            setDescricaoBairro(bairro);
          } catch (err) {
            console.error('‚ùå [LOAD] Erro ao parsear descricao_bairro:', err);
          }
        }
        if (anuncio.data.info_locomocao) {
          try {
            const locomocao = typeof anuncio.data.info_locomocao === 'string' 
              ? JSON.parse(anuncio.data.info_locomocao) 
              : anuncio.data.info_locomocao;
            setInfoLocomocao(locomocao);
          } catch (err) {
            console.error('‚ùå [LOAD] Erro ao parsear info_locomocao:', err);
          }
        }

        // Preencher campos do Step 8 (Configura√ß√£o de Relacionamento)
        setTitularImovel(asString(anuncio.data.titular_imovel, ''));
        setAdministradorImovel(asString(anuncio.data.administrador_imovel, ''));
        if (anuncio.data.data_cadastro) {
          setDataCadastro(new Date(anuncio.data.data_cadastro));
        }
        setIsSublocacao(anuncio.data.is_sublocacao === true);
        setIsExclusivo(anuncio.data.is_exclusivo === true);
        if (anuncio.data.data_inicio_contrato) {
          setDataInicioContrato(new Date(anuncio.data.data_inicio_contrato));
        }
        if (anuncio.data.data_fim_contrato) {
          setDataFimContrato(new Date(anuncio.data.data_fim_contrato));
        }
        setBloquearCalendarioAposFim(anuncio.data.bloquear_calendario_apos_fim === true);
        setModeloComissao((anuncio.data.modelo_comissao as 'global' | 'individual') || 'global');
        setTipoComissao((anuncio.data.tipo_comissao as 'percentage' | 'fixed_monthly') || 'percentage');
        setPercentualComissao(Number(anuncio.data.percentual_comissao) || 0);
        setBaseCalculoComissao((anuncio.data.base_calculo_comissao as any) || 'gross_daily');
        setConsiderarTaxasCanais(anuncio.data.considerar_taxas_canais === true);
        setDeduzirTaxasCanais(anuncio.data.deduzir_taxas_canais === true);
        setPermitirTransferenciaExclusiva(anuncio.data.permitir_transferencia_exclusiva === true);
        setModoCobrancaEnergia((anuncio.data.modo_cobranca_energia as 'global' | 'individual') || 'global');

        // Preencher campos do Step 9 (Pre√ßos Loca√ß√£o e Venda)
        setTipoNegocio((anuncio.data.tipo_negocio as any) || 'aluguel');
        setValorAluguel(Number(anuncio.data.valor_aluguel) || 0);
        setValorIptu(Number(anuncio.data.valor_iptu) || 0);
        setValorCondominio(Number(anuncio.data.valor_condominio) || 0);
        setTaxaServico(Number(anuncio.data.taxa_servico) || 0);
        setValorVenda(Number(anuncio.data.valor_venda) || 0);
        setIptuAnual(Number(anuncio.data.iptu_anual) || 0);
        setAceitaFinanciamento(anuncio.data.aceita_financiamento === true);
        setAceitaPermuta(anuncio.data.aceita_permuta === true);

        // Preencher campos do Step 10 (Configura√ß√£o de Pre√ßo Temporada)
        setModoConfigPreco((anuncio.data.modo_config_preco as any) || 'global');
        setRegiao(asString(anuncio.data.regiao, 'BR'));
        setMoeda(asString(anuncio.data.moeda, 'BRL'));
        setDescontoLongaEstadia(Number(anuncio.data.desconto_longa_estadia) || 0);
        setDescontoSemanal(Number(anuncio.data.desconto_semanal) || 0);
        setDescontoMensal(Number(anuncio.data.desconto_mensal) || 0);
        setValorDeposito(Number(anuncio.data.valor_deposito) || 0);
        setUsarPrecificacaoDinamica(anuncio.data.usar_precificacao_dinamica === true);
        setTaxaLimpeza(Number(anuncio.data.taxa_limpeza) || 0);
        setTaxaPet(Number(anuncio.data.taxa_pet) || 0);
        setTaxaServicosExtras(Number(anuncio.data.taxa_servicos_extras) || 0);

        // Preencher campos do Step 11 (Precifica√ß√£o Individual)
        setPrecoBaseNoite(Number(anuncio.data.preco_base_noite) || 0);
        setDescontoPermanencia2Noites(Number(anuncio.data.desconto_permanencia_2_noites) || 0);
        setDescontoPermanencia7Noites(Number(anuncio.data.desconto_permanencia_7_noites) || 0);
        setDescontoPermanencia30Noites(Number(anuncio.data.desconto_permanencia_30_noites) || 0);
        setPeriodosSazonais(anuncio.data.periodos_sazonais || []);
        setPrecosDiaSemana(anuncio.data.precos_dia_semana || {});
        setDatasEspeciais(anuncio.data.datas_especiais || []);

        // Preencher campos do Step 12 (Pre√ßos Derivados)
        setVariacaoPorHospedes(Number(anuncio.data.variacao_por_hospedes) || 0);
        setTaxaHospedeExtra(Number(anuncio.data.taxa_hospede_extra) || 0);
        setCobrarCriancas(anuncio.data.cobrar_criancas === true);
        setIdadeMinimaCrianca(Number(anuncio.data.idade_minima_crianca) || 0);
        setIdadeMaximaCrianca(Number(anuncio.data.idade_maxima_crianca) || 12);
        setDescontoCrianca(Number(anuncio.data.desconto_crianca) || 0);
      }

      console.log('‚úÖ [LOAD] An√∫ncio carregado com sucesso');
      setIsLoading(false);
    } catch (error) {
      console.error('‚ùå [LOAD] ERRO ao carregar an√∫ncio:', error);
      console.error('‚ùå [LOAD] Tipo do erro:', error instanceof Error ? error.message : String(error));
      setIsLoading(false);
      
      // ‚ö†Ô∏è N√ÉO redirecionar - permitir que usu√°rio continue mesmo com erro de carregamento
      toast.error('Erro ao carregar dados - voc√™ pode continuar editando');
    }
  };

  // ============================================================================
  // ‚úÖ SALVAMENTO COMPLETO - 5 CAMPOS: T√çTULO + TIPO LOCAL + TIPO ACOMODA√á√ÉO + SUBTIPO + MODALIDADES
  // V1.0.103.334 - ADICIONADO SUBTIPO E MODALIDADES
  // ============================================================================
  const saveAllStep1Fields = async () => {
    console.log('üö®üö®üö® BOT√ÉO SALVAR CLICADO - V1.0.103.334 üö®üö®üö®');
    
    try {
      console.log('üìä Estado atual:', { anuncioId, title, tipoLocal, tipoAcomodacao, subtype, modalidades });
      
      // Valida√ß√£o 1: ID existe?
      if (!anuncioId) {
        console.error('‚ùå Checkpoint 1 FALHOU: ID ausente');
        toast.error('‚ùå Erro: An√∫ncio sem ID');
        return false;
      }
      console.log('‚úÖ Checkpoint 1 OK: ID =', anuncioId);

      // Valida√ß√£o 2: T√≠tulo n√£o est√° vazio?
      if (!title || !title.trim()) {
        console.error('‚ùå Checkpoint 2 FALHOU: T√≠tulo vazio');
        toast.error('‚ùå Digite um nome antes de salvar');
        return false;
      }
      console.log('‚úÖ Checkpoint 2 OK: T√≠tulo =', title.trim());

      // Valida√ß√£o 3: Tipo de Local selecionado?
      if (!tipoLocal || !tipoLocal.trim()) {
        console.error('‚ùå Checkpoint 3 FALHOU: Tipo de Local n√£o selecionado');
        toast.error('‚ùå Selecione o Tipo de Local antes de salvar');
        return false;
      }
      console.log('‚úÖ Checkpoint 3 OK: Tipo de Local =', tipoLocal);

      // Valida√ß√£o 4: Tipo de Local √© v√°lido?
      if (!allowedTipoLocal.has(tipoLocal)) {
        console.error('‚ùå Checkpoint 4 FALHOU: Tipo de Local inv√°lido:', tipoLocal);
        console.error('‚ùå Whitelist:', Array.from(allowedTipoLocal));
        toast.error('‚ùå Tipo de Local inv√°lido');
        return false;
      }
      console.log('‚úÖ Checkpoint 4 OK: Tipo na whitelist');

      // Valida√ß√£o 5: Tipo de Acomoda√ß√£o selecionado?
      if (!tipoAcomodacao || !tipoAcomodacao.trim()) {
        console.error('‚ùå Checkpoint 5 FALHOU: Tipo de Acomoda√ß√£o n√£o selecionado');
        toast.error('‚ùå Selecione o Tipo de Acomoda√ß√£o antes de salvar');
        return false;
      }
      console.log('‚úÖ Checkpoint 5 OK: Tipo de Acomoda√ß√£o =', tipoAcomodacao);

      // Valida√ß√£o 6: Tipo de Acomoda√ß√£o √© v√°lido?
      if (!allowedTipoAcomodacao.has(tipoAcomodacao)) {
        console.error('‚ùå Checkpoint 6 FALHOU: Tipo de Acomoda√ß√£o inv√°lido:', tipoAcomodacao);
        console.error('‚ùå Whitelist:', Array.from(allowedTipoAcomodacao));
        toast.error('‚ùå Tipo de Acomoda√ß√£o inv√°lido');
        return false;
      }
      console.log('‚úÖ Checkpoint 6 OK: Tipo de Acomoda√ß√£o na whitelist');

      // Valida√ß√£o 7: Subtipo selecionado?
      if (!subtype || !subtype.trim()) {
        console.error('‚ùå Checkpoint 7 FALHOU: Subtipo n√£o selecionado');
        toast.error('‚ùå Selecione o Subtipo antes de salvar');
        return false;
      }
      console.log('‚úÖ Checkpoint 7 OK: Subtipo =', subtype);

      // Valida√ß√£o 8: Subtipo √© v√°lido?
      if (!allowedSubtype.has(subtype)) {
        console.error('‚ùå Checkpoint 8 FALHOU: Subtipo inv√°lido:', subtype);
        console.error('‚ùå Whitelist:', Array.from(allowedSubtype));
        toast.error('‚ùå Subtipo inv√°lido');
        return false;
      }
      console.log('‚úÖ Checkpoint 8 OK: Subtipo na whitelist');

      // Valida√ß√£o 9: Pelo menos uma modalidade selecionada?
      if (!modalidades || modalidades.length === 0) {
        console.error('‚ùå Checkpoint 9 FALHOU: Nenhuma modalidade selecionada');
        toast.error('‚ùå Selecione pelo menos uma modalidade');
        return false;
      }
      console.log('‚úÖ Checkpoint 9 OK: Modalidades =', modalidades);

      console.log('üéØ TODAS AS VALIDA√á√ïES PASSARAM!');
      
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      
      // CAMPO 1: T√çTULO
      console.log('üìù Salvando campo 1: title');
      const payload1 = {
        anuncio_id: anuncioId,
        field: 'title',
        value: title.trim()
      };
      
      const res1 = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${ANON_KEY}`
        },
        body: JSON.stringify(payload1)
      });

      const data1 = await res1.json();
      
      if (!res1.ok) {
        console.error('‚ùå Erro ao salvar t√≠tulo:', data1.error);
        throw new Error(data1.error || `HTTP ${res1.status}`);
      }

      console.log('‚úÖ T√≠tulo salvo!');

      // CAMPO 1.5: INTERNAL ID (duplicado do t√≠tulo para exibi√ß√£o no card)
      console.log('üè∑Ô∏è Salvando campo 1.5: internalId');
      const payloadInternalId = {
        anuncio_id: anuncioId,
        field: 'internalId',
        value: title.trim()
      };
      
      const resInternalId = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${ANON_KEY}`
        },
        body: JSON.stringify(payloadInternalId)
      });

      const dataInternalId = await resInternalId.json();
      
      if (!resInternalId.ok) {
        console.error('‚ùå Erro ao salvar internalId:', dataInternalId.error);
        throw new Error(dataInternalId.error || `HTTP ${resInternalId.status}`);
      }

      console.log('‚úÖ InternalId salvo!');

      // CAMPO 2: TIPO DE LOCAL
      console.log('üè† Salvando campo 2: tipo_local');
      const payload2 = {
        anuncio_id: anuncioId,
        field: 'tipo_local',
        value: tipoLocal
      };
      
      const res2 = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${ANON_KEY}`
        },
        body: JSON.stringify(payload2)
      });

      const data2 = await res2.json();
      
      if (!res2.ok) {
        console.error('‚ùå Erro ao salvar tipo de local:', data2.error);
        throw new Error(data2.error || `HTTP ${res2.status}`);
      }

      console.log('‚úÖ Tipo de Local salvo!');

      // CAMPO 3: TIPO DE ACOMODA√á√ÉO
      console.log('üõèÔ∏è Salvando campo 3: tipo_acomodacao');
      const payload3 = {
        anuncio_id: anuncioId,
        field: 'tipo_acomodacao',
        value: tipoAcomodacao
      };
      
      const res3 = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${ANON_KEY}`
        },
        body: JSON.stringify(payload3)
      });

      const data3 = await res3.json();
      
      if (!res3.ok) {
        console.error('‚ùå Erro ao salvar tipo de acomoda√ß√£o:', data3.error);
        throw new Error(data3.error || `HTTP ${res3.status}`);
      }

      console.log('‚úÖ Tipo de Acomoda√ß√£o salvo!');

      // CAMPO 4: SUBTIPO
      console.log('üè∑Ô∏è Salvando campo 4: subtype');
      const payload4 = {
        anuncio_id: anuncioId,
        field: 'subtype',
        value: subtype
      };
      
      const res4 = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${ANON_KEY}`
        },
        body: JSON.stringify(payload4)
      });

      const data4 = await res4.json();
      
      if (!res4.ok) {
        console.error('‚ùå Erro ao salvar subtipo:', data4.error);
        throw new Error(data4.error || `HTTP ${res4.status}`);
      }

      console.log('‚úÖ Subtipo salvo!');

      // CAMPO 5: MODALIDADES (array)
      console.log('üìã Salvando campo 5: modalidades');
      const payload5 = {
        anuncio_id: anuncioId,
        field: 'modalidades',
        value: JSON.stringify(modalidades) // Converte array para string JSON
      };
      
      const res5 = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${ANON_KEY}`
        },
        body: JSON.stringify(payload5)
      });

      const data5 = await res5.json();
      
      if (!res5.ok) {
        console.error('‚ùå Erro ao salvar modalidades:', data5.error);
        throw new Error(data5.error || `HTTP ${res5.status}`);
      }

      console.log('‚úÖ Modalidades salvas!');

      // FINALIZA√á√ÉO
      console.log('‚úÖ‚úÖ‚úÖ TODOS OS 5 CAMPOS SALVOS COM SUCESSO! ‚úÖ‚úÖ‚úÖ');
      
      setHasUnsavedChanges(false);
      
      // Marcar Step 1 como completo (sem avan√ßar automaticamente)
      setSteps(prev => prev.map(s => 
        s.id === 1 ? { ...s, status: 'completed' } : s
      ));
      
      toast.success('‚úÖ Dados do Step 1 salvos com sucesso!');
      
      return true;
      
    } catch (error) {
      console.error('‚ùå‚ùå‚ùå ERRO FATAL ‚ùå‚ùå‚ùå');
      console.error('Erro:', error);
      console.error('‚ùå [SAVE] Stack trace:', (error as Error).stack);
      console.log('========================================');
      console.log('');
      toast.error(`‚ùå Erro ao salvar: ${(error as Error).message}`, {
        duration: 5000
      });
      return false;
    }
  };

  // ============================================================================
  // üîç BUSCA DE CEP VIA VIACEP API
  // ============================================================================
  const buscarCep = async (cepValue: string) => {
    try {
      // Limpar formata√ß√£o (remove h√≠fens, pontos, espa√ßos)
      const cepLimpo = cepValue.replace(/\D/g, '');
      
      // Validar tamanho
      if (cepLimpo.length !== 8) {
        console.warn('‚ö†Ô∏è CEP inv√°lido (precisa ter 8 d√≠gitos):', cepLimpo);
        return;
      }
      
      console.log('üîç Buscando CEP:', cepLimpo);
      
      const res = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
      const data = await res.json();
      
      if (data.erro) {
        toast.error('‚ùå CEP n√£o encontrado');
        return;
      }
      
      // Auto-preencher campos
      setRua(data.logradouro || '');
      setBairro(data.bairro || '');
      setCidade(data.localidade || '');
      setSiglaEstado(data.uf || '');
      
      // Mapear sigla para nome completo do estado
      const estadosMap: Record<string, string> = {
        'AC': 'Acre', 'AL': 'Alagoas', 'AP': 'Amap√°', 'AM': 'Amazonas',
        'BA': 'Bahia', 'CE': 'Cear√°', 'DF': 'Distrito Federal', 'ES': 'Esp√≠rito Santo',
        'GO': 'Goi√°s', 'MA': 'Maranh√£o', 'MT': 'Mato Grosso', 'MS': 'Mato Grosso do Sul',
        'MG': 'Minas Gerais', 'PA': 'Par√°', 'PB': 'Para√≠ba', 'PR': 'Paran√°',
        'PE': 'Pernambuco', 'PI': 'Piau√≠', 'RJ': 'Rio de Janeiro', 'RN': 'Rio Grande do Norte',
        'RS': 'Rio Grande do Sul', 'RO': 'Rond√¥nia', 'RR': 'Roraima', 'SC': 'Santa Catarina',
        'SP': 'S√£o Paulo', 'SE': 'Sergipe', 'TO': 'Tocantins'
      };
      setEstado(estadosMap[data.uf] || data.uf);
      
      setHasUnsavedChanges(true);
      toast.success('‚úÖ Endere√ßo encontrado!');
      
      console.log('‚úÖ CEP encontrado:', data);
    } catch (error) {
      console.error('‚ùå Erro ao buscar CEP:', error);
      toast.error('‚ùå Erro ao buscar CEP. Verifique sua conex√£o.');
    }
  };

  // Formata√ß√£o autom√°tica de CEP ao digitar
  const formatarCep = (value: string): string => {
    const numeros = value.replace(/\D/g, '');
    if (numeros.length <= 5) return numeros;
    return `${numeros.slice(0, 5)}-${numeros.slice(5, 8)}`;
  };

  // ============================================================================
  // üíæ SALVAMENTO STEP 2 - LOCALIZA√á√ÉO (15 CAMPOS)
  // V1.0.103.337 - COM PROTE√á√ÉO ANTI-LOOP
  // ============================================================================
  const saveAllStep2Fields = async () => {
    console.log('üö®üö®üö® BOT√ÉO SALVAR STEP 2 CLICADO - V1.0.103.337 üö®üö®üö®');
    
    // PROTE√á√ÉO: Bloquear se j√° est√° salvando
    if (isSaving) {
      console.log('‚ö†Ô∏è Salvamento j√° em andamento, abortando duplicata');
      return false;
    }
    
    setIsSaving(true);
    
    try {
      console.log('üìä Estado atual Step 2:', {
        anuncioId, pais, estado, siglaEstado, cep, cidade, bairro,
        rua, numero, complemento, mostrarNumero, tipoAcesso,
        instrucoesAcesso, possuiElevador, estacionamento, tipoEstacionamento,
        internetCabo, internetWifi
      });
      
      // Valida√ß√£o 1: ID existe?
      if (!anuncioId) {
        console.error('‚ùå Checkpoint 1 FALHOU: ID ausente');
        toast.error('‚ùå Erro: An√∫ncio sem ID');
        setIsSaving(false);
        return false;
      }
      console.log('‚úÖ Checkpoint 1 OK: ID =', anuncioId);

      // Valida√ß√£o 2: CEP preenchido?
      if (!cep || !cep.trim()) {
        console.error('‚ùå Checkpoint 2 FALHOU: CEP vazio');
        toast.error('‚ùå Preencha o CEP antes de salvar');
        setIsSaving(false);
        return false;
      }
      console.log('‚úÖ Checkpoint 2 OK: CEP =', cep);

      // Valida√ß√£o 3: Rua preenchida?
      if (!rua || !rua.trim()) {
        console.error('‚ùå Checkpoint 3 FALHOU: Rua vazia');
        toast.error('‚ùå Preencha a Rua antes de salvar');
        setIsSaving(false);
        return false;
      }
      console.log('‚úÖ Checkpoint 3 OK: Rua =', rua);

      // Valida√ß√£o 4: N√∫mero preenchido?
      if (!numero || !numero.trim()) {
        console.error('‚ùå Checkpoint 4 FALHOU: N√∫mero vazio');
        toast.error('‚ùå Preencha o N√∫mero antes de salvar');
        setIsSaving(false);
        return false;
      }
      console.log('‚úÖ Checkpoint 4 OK: N√∫mero =', numero);

      // Valida√ß√£o 5: Cidade preenchida?
      if (!cidade || !cidade.trim()) {
        console.error('‚ùå Checkpoint 5 FALHOU: Cidade vazia');
        toast.error('‚ùå Preencha a Cidade antes de salvar');
        setIsSaving(false);
        return false;
      }
      console.log('‚úÖ Checkpoint 5 OK: Cidade =', cidade);

      // Valida√ß√£o 6: Estado preenchido?
      if (!siglaEstado || !siglaEstado.trim()) {
        console.error('‚ùå Checkpoint 6 FALHOU: Estado vazio');
        toast.error('‚ùå Preencha o Estado antes de salvar');
        setIsSaving(false);
        return false;
      }
      console.log('‚úÖ Checkpoint 6 OK: Estado =', siglaEstado);

      console.log('üéØ TODAS AS VALIDA√á√ïES PASSARAM!');
      
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      
      // CAMPO 1: PA√çS
      console.log('üåç Salvando campo 1: pais');
      const res1 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'pais', value: pais })
      });
      const data1 = await res1.json();
      if (!res1.ok) {
        console.error('‚ùå Erro ao salvar pa√≠s:', data1.error);
        throw new Error(data1.error || `HTTP ${res1.status}`);
      }
      console.log('‚úÖ Pa√≠s salvo!');

      // CAMPO 2: ESTADO
      console.log('üó∫Ô∏è Salvando campo 2: estado');
      const res2 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'estado', value: estado })
      });
      const data2 = await res2.json();
      if (!res2.ok) {
        console.error('‚ùå Erro ao salvar estado:', data2.error);
        throw new Error(data2.error || `HTTP ${res2.status}`);
      }
      console.log('‚úÖ Estado salvo!');

      // CAMPO 3: SIGLA ESTADO
      console.log('üî§ Salvando campo 3: sigla_estado');
      const res3 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'sigla_estado', value: siglaEstado })
      });
      const data3 = await res3.json();
      if (!res3.ok) {
        console.error('‚ùå Erro ao salvar sigla estado:', data3.error);
        throw new Error(data3.error || `HTTP ${res3.status}`);
      }
      console.log('‚úÖ Sigla Estado salva!');

      // CAMPO 4: CEP
      console.log('üìÆ Salvando campo 4: cep');
      const res4 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'cep', value: cep })
      });
      const data4 = await res4.json();
      if (!res4.ok) {
        console.error('‚ùå Erro ao salvar cep:', data4.error);
        throw new Error(data4.error || `HTTP ${res4.status}`);
      }
      console.log('‚úÖ CEP salvo!');

      // CAMPO 5: CIDADE
      console.log('üèôÔ∏è Salvando campo 5: cidade');
      const res5 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'cidade', value: cidade })
      });
      const data5 = await res5.json();
      if (!res5.ok) {
        console.error('‚ùå Erro ao salvar cidade:', data5.error);
        throw new Error(data5.error || `HTTP ${res5.status}`);
      }
      console.log('‚úÖ Cidade salva!');

      // CAMPO 6: BAIRRO
      console.log('üèòÔ∏è Salvando campo 6: bairro');
      const res6 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'bairro', value: bairro })
      });
      const data6 = await res6.json();
      if (!res6.ok) {
        console.error('‚ùå Erro ao salvar bairro:', data6.error);
        throw new Error(data6.error || `HTTP ${res6.status}`);
      }
      console.log('‚úÖ Bairro salvo!');

      // CAMPO 7: RUA
      console.log('üõ£Ô∏è Salvando campo 7: rua');
      const res7 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'rua', value: rua })
      });
      const data7 = await res7.json();
      if (!res7.ok) {
        console.error('‚ùå Erro ao salvar rua:', data7.error);
        throw new Error(data7.error || `HTTP ${res7.status}`);
      }
      console.log('‚úÖ Rua salva!');

      // CAMPO 8: N√öMERO
      console.log('üî¢ Salvando campo 8: numero');
      const res8 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'numero', value: numero })
      });
      const data8 = await res8.json();
      if (!res8.ok) {
        console.error('‚ùå Erro ao salvar n√∫mero:', data8.error);
        throw new Error(data8.error || `HTTP ${res8.status}`);
      }
      console.log('‚úÖ N√∫mero salvo!');

      // CAMPO 9: COMPLEMENTO
      console.log('üìù Salvando campo 9: complemento');
      const res9 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'complemento', value: complemento })
      });
      const data9 = await res9.json();
      if (!res9.ok) {
        console.error('‚ùå Erro ao salvar complemento:', data9.error);
        throw new Error(data9.error || `HTTP ${res9.status}`);
      }
      console.log('‚úÖ Complemento salvo!');

      // CAMPO 10: MOSTRAR N√öMERO
      console.log('üëÅÔ∏è Salvando campo 10: mostrar_numero');
      const res10 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'mostrar_numero', value: mostrarNumero })
      });
      const data10 = await res10.json();
      if (!res10.ok) {
        console.error('‚ùå Erro ao salvar mostrar_numero:', data10.error);
        throw new Error(data10.error || `HTTP ${res10.status}`);
      }
      console.log('‚úÖ Mostrar N√∫mero salvo!');

      // CAMPO 11: TIPO ACESSO
      console.log('üö™ Salvando campo 11: tipo_acesso');
      const res11 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'tipo_acesso', value: tipoAcesso })
      });
      const data11 = await res11.json();
      if (!res11.ok) {
        console.error('‚ùå Erro ao salvar tipo_acesso:', data11.error);
        throw new Error(data11.error || `HTTP ${res11.status}`);
      }
      console.log('‚úÖ Tipo Acesso salvo!');

      // CAMPO 12: INSTRU√á√ïES ACESSO
      console.log('üìã Salvando campo 12: instrucoes_acesso');
      const res12 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'instrucoes_acesso', value: instrucoesAcesso })
      });
      const data12 = await res12.json();
      if (!res12.ok) {
        console.error('‚ùå Erro ao salvar instrucoes_acesso:', data12.error);
        throw new Error(data12.error || `HTTP ${res12.status}`);
      }
      console.log('‚úÖ Instru√ß√µes Acesso salvas!');

      // CAMPO 13: POSSUI ELEVADOR
      console.log('üõó Salvando campo 13: possui_elevador');
      const res13 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'possui_elevador', value: possuiElevador })
      });
      const data13 = await res13.json();
      if (!res13.ok) {
        console.error('‚ùå Erro ao salvar possui_elevador:', data13.error);
        throw new Error(data13.error || `HTTP ${res13.status}`);
      }
      console.log('‚úÖ Possui Elevador salvo!');

      // CAMPO 14: ESTACIONAMENTO
      console.log('üÖøÔ∏è Salvando campo 14: estacionamento');
      const res14 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'estacionamento', value: estacionamento })
      });
      const data14 = await res14.json();
      if (!res14.ok) {
        console.error('‚ùå Erro ao salvar estacionamento:', data14.error);
        throw new Error(data14.error || `HTTP ${res14.status}`);
      }
      console.log('‚úÖ Estacionamento salvo!');

      // CAMPO 15: TIPO ESTACIONAMENTO
      console.log('üöó Salvando campo 15: tipo_estacionamento');
      const res15 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'tipo_estacionamento', value: tipoEstacionamento })
      });
      const data15 = await res15.json();
      if (!res15.ok) {
        console.error('‚ùå Erro ao salvar tipo_estacionamento:', data15.error);
        throw new Error(data15.error || `HTTP ${res15.status}`);
      }
      console.log('‚úÖ Tipo Estacionamento salvo!');

      // CAMPO 16: INTERNET CABO
      console.log('üì° Salvando campo 16: internet_cabo');
      const res16 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'internet_cabo', value: internetCabo })
      });
      const data16 = await res16.json();
      if (!res16.ok) {
        console.error('‚ùå Erro ao salvar internet_cabo:', data16.error);
        throw new Error(data16.error || `HTTP ${res16.status}`);
      }
      console.log('‚úÖ Internet Cabo salva!');

      // CAMPO 17: INTERNET WIFI
      console.log('üì∂ Salvando campo 17: internet_wifi');
      const res17 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'internet_wifi', value: internetWifi })
      });
      const data17 = await res17.json();
      if (!res17.ok) {
        console.error('‚ùå Erro ao salvar internet_wifi:', data17.error);
        throw new Error(data17.error || `HTTP ${res17.status}`);
      }
      console.log('‚úÖ Internet Wi-Fi salva!');

      // CAMPO 18: ADDRESS OBJECT (objeto unificado para exibi√ß√£o no card)
      console.log('üè† Salvando campo 18: address (objeto unificado)');
      const addressObject = {
        street: rua || '',
        number: numero || '',
        complement: complemento || '',
        neighborhood: bairro || '',
        city: cidade || '',
        state: estado || '',
        zipCode: cep || '',
        country: pais || ''
      };
      
      const resAddress = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'address', value: addressObject })
      });
      const dataAddress = await resAddress.json();
      if (!resAddress.ok) {
        console.error('‚ùå Erro ao salvar address:', dataAddress.error);
        throw new Error(dataAddress.error || `HTTP ${resAddress.status}`);
      }
      console.log('‚úÖ Address Object salvo!');

      // FINALIZA√á√ÉO
      console.log('‚úÖ‚úÖ‚úÖ TODOS OS 18 CAMPOS DO STEP 2 SALVOS COM SUCESSO! ‚úÖ‚úÖ‚úÖ');
      
      // Atualizar estados SEM causar re-render
      setHasUnsavedChanges(false);
      
      // Toast simples sem op√ß√µes (evita re-renders)
      toast.success('Step 2 salvo!');
      
      // IMPORTANTE: Desabilitar isSaving no final para liberar bot√£o
      setTimeout(() => setIsSaving(false), 500);
      
      return true;
      
    } catch (error) {
      console.error('‚ùå‚ùå‚ùå ERRO FATAL NO STEP 2 ‚ùå‚ùå‚ùå');
      console.error('Erro:', error);
      
      toast.error('Erro ao salvar Step 2');
      
      // Liberar bot√£o mesmo em caso de erro
      setTimeout(() => setIsSaving(false), 500);
      
      return false;
    }
  };

  // ============================================================================
  // üíæ SAVE ENDERE√áO - CAMPOS 1-9 (Se√ß√£o Superior)
  // ============================================================================
  const saveAddressFields = async () => {
    console.log('üè† SALVANDO ENDERE√áO (9 campos)');
    
    // Valida√ß√µes b√°sicas ANTES de travar o bot√£o
    if (!anuncioId) {
      console.error('‚ùå An√∫ncio sem ID');
      toast.error('‚ùå Erro: An√∫ncio sem ID');
      return false;
    }
    
    if (!cep?.trim()) {
      console.error('‚ùå CEP vazio');
      toast.error('‚ùå Preencha o CEP');
      return false;
    }
    
    if (!rua?.trim()) {
      console.error('‚ùå Rua vazia');
      toast.error('‚ùå Preencha a Rua');
      return false;
    }
    
    if (!numero?.trim()) {
      console.error('‚ùå N√∫mero vazio');
      toast.error('‚ùå Preencha o N√∫mero');
      return false;
    }
    
    console.log('‚úÖ Todas valida√ß√µes OK, iniciando save...');
    
    try {
      
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      
      // CAMPO 1: PA√çS
      const res1 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'pais', value: pais })
      });
      const data1 = await res1.json();
      if (!res1.ok) throw new Error(data1.error || `HTTP ${res1.status}`);
      
      // CAMPO 2: ESTADO
      const res2 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'estado', value: estado })
      });
      const data2 = await res2.json();
      if (!res2.ok) throw new Error(data2.error || `HTTP ${res2.status}`);
      
      // CAMPO 3: SIGLA ESTADO
      const res3 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'sigla_estado', value: siglaEstado })
      });
      const data3 = await res3.json();
      if (!res3.ok) throw new Error(data3.error || `HTTP ${res3.status}`);
      
      // CAMPO 4: CEP
      const res4 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'cep', value: cep })
      });
      const data4 = await res4.json();
      if (!res4.ok) throw new Error(data4.error || `HTTP ${res4.status}`);
      
      // CAMPO 5: CIDADE
      const res5 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'cidade', value: cidade })
      });
      const data5 = await res5.json();
      if (!res5.ok) throw new Error(data5.error || `HTTP ${res5.status}`);
      
      // CAMPO 6: BAIRRO
      const res6 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'bairro', value: bairro })
      });
      const data6 = await res6.json();
      if (!res6.ok) throw new Error(data6.error || `HTTP ${res6.status}`);
      
      // CAMPO 7: RUA
      const res7 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'rua', value: rua })
      });
      const data7 = await res7.json();
      if (!res7.ok) throw new Error(data7.error || `HTTP ${res7.status}`);
      
      // CAMPO 8: NUMERO
      const res8 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'numero', value: numero })
      });
      const data8 = await res8.json();
      if (!res8.ok) throw new Error(data8.error || `HTTP ${res8.status}`);
      
      // CAMPO 9: COMPLEMENTO
      const res9 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'complemento', value: complemento })
      });
      const data9 = await res9.json();
      if (!res9.ok) throw new Error(data9.error || `HTTP ${res9.status}`);
      
      console.log('‚úÖ Endere√ßo salvo com sucesso!');
      setHasUnsavedChanges(false);
      
      // Toast em microtask separada para evitar DOM conflicts
      setTimeout(() => toast.success('‚úÖ Endere√ßo salvo!'), 0);
      return true;
      
    } catch (error) {
      console.error('‚ùå Erro ao salvar endere√ßo:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar endere√ßo'), 0);
      return false;
    }
  };

  // ============================================================================
  // üíæ SAVE CARACTER√çSTICAS - CAMPOS 10-17 (Se√ß√£o Inferior)
  // ============================================================================
  const saveCharacteristicsFields = async () => {
    console.log('üè° SALVANDO CARACTER√çSTICAS (8 campos)');
    
    // Valida√ß√£o ANTES de travar bot√£o
    if (!anuncioId) {
      console.error('‚ùå An√∫ncio sem ID');
      toast.error('‚ùå Erro: An√∫ncio sem ID');
      return false;
    }
    
    console.log('‚úÖ Valida√ß√£o OK, iniciando save...');
    
    try {
      
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      
      // CAMPO 10: MOSTRAR NUMERO
      const res10 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'mostrar_numero', value: mostrarNumero })
      });
      const data10 = await res10.json();
      if (!res10.ok) throw new Error(data10.error || `HTTP ${res10.status}`);
      
      // CAMPO 11: TIPO ACESSO
      const res11 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'tipo_acesso', value: tipoAcesso })
      });
      const data11 = await res11.json();
      if (!res11.ok) throw new Error(data11.error || `HTTP ${res11.status}`);
      
      // CAMPO 12: INSTRUCOES ACESSO
      const res12 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'instrucoes_acesso', value: instrucoesAcesso })
      });
      const data12 = await res12.json();
      if (!res12.ok) throw new Error(data12.error || `HTTP ${res12.status}`);
      
      // CAMPO 13: POSSUI ELEVADOR
      const res13 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'possui_elevador', value: possuiElevador })
      });
      const data13 = await res13.json();
      if (!res13.ok) throw new Error(data13.error || `HTTP ${res13.status}`);
      
      // CAMPO 14: ESTACIONAMENTO
      const res14 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'estacionamento', value: estacionamento })
      });
      const data14 = await res14.json();
      if (!res14.ok) throw new Error(data14.error || `HTTP ${res14.status}`);
      
      // CAMPO 15: TIPO ESTACIONAMENTO
      const res15 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'tipo_estacionamento', value: tipoEstacionamento })
      });
      const data15 = await res15.json();
      if (!res15.ok) throw new Error(data15.error || `HTTP ${res15.status}`);
      
      // CAMPO 16: INTERNET CABO
      const res16 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'internet_cabo', value: internetCabo })
      });
      const data16 = await res16.json();
      if (!res16.ok) throw new Error(data16.error || `HTTP ${res16.status}`);
      
      // CAMPO 17: INTERNET WIFI
      const res17 = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'internet_wifi', value: internetWifi })
      });
      const data17 = await res17.json();
      if (!res17.ok) throw new Error(data17.error || `HTTP ${res17.status}`);
      
      console.log('‚úÖ Caracter√≠sticas salvas com sucesso!');
      setHasUnsavedChanges(false);
      
      // Toast em microtask separada para evitar DOM conflicts
      setTimeout(() => toast.success('‚úÖ Caracter√≠sticas salvas!'), 0);
      return true;
      
    } catch (error) {
      console.error('‚ùå Erro ao salvar caracter√≠sticas:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar caracter√≠sticas'), 0);
      return false;
    }
  };

  // ============================================================================
  // üè† ROOM MANAGEMENT - STEP 03
  // ============================================================================
  
  const addRoom = () => {
    const newRoom: Room = {
      id: `room-${Date.now()}`,
      type: '',
      typeName: '',
      isShared: false,
      beds: {},
      photos: [],
    };

    setRooms([...rooms, newRoom]);
    setSelectedRoomIndex(rooms.length);
    setHasUnsavedChanges(true);
  };

  const removeRoom = (index: number) => {
    const newRooms = rooms.filter((_, i) => i !== index);
    setRooms(newRooms);

    if (selectedRoomIndex >= newRooms.length) {
      setSelectedRoomIndex(Math.max(0, newRooms.length - 1));
    }
    setHasUnsavedChanges(true);
  };

  const updateRoom = (index: number, updates: Partial<Room>) => {
    try {
      console.log('üîÑ [UPDATE ROOM] Index:', index, 'Updates:', updates);
      console.log('üîÑ [UPDATE ROOM] C√¥modos antes:', rooms);
      console.log('üîÑ [UPDATE ROOM] Total de c√¥modos:', rooms.length);
      
      if (index < 0 || index >= rooms.length) {
        console.error('‚ùå [UPDATE ROOM] √çndice inv√°lido:', index, 'Total:', rooms.length);
        toast.error(`Erro: √çndice de c√¥modo inv√°lido (${index})`);
        return;
      }
      
      const newRooms = [...rooms];
      newRooms[index] = { ...newRooms[index], ...updates };
      
      console.log('üîÑ [UPDATE ROOM] C√¥modos depois:', newRooms);
      console.log('üîÑ [UPDATE ROOM] C√¥modo atualizado:', newRooms[index]);
      
      setRooms(newRooms);
      setHasUnsavedChanges(true);
    } catch (error) {
      console.error('‚ùå [UPDATE ROOM] Erro ao atualizar c√¥modo:', error);
      toast.error('Erro ao atualizar c√¥modo. Veja o console.');
    }
  };

  // ============================================================================
  // üõèÔ∏è BED MANAGEMENT - STEP 03
  // ============================================================================
  
  const updateBedCount = (roomIndex: number, bedTypeId: string, delta: number) => {
    const room = rooms[roomIndex];
    const currentCount = room.beds[bedTypeId] || 0;
    const newCount = Math.max(0, currentCount + delta);

    const newBeds = { ...room.beds };
    if (newCount === 0) {
      delete newBeds[bedTypeId];
    } else {
      newBeds[bedTypeId] = newCount;
    }

    updateRoom(roomIndex, { beds: newBeds });
  };

  // ============================================================================
  // üì∏ PHOTO MANAGEMENT - STEP 03
  // ============================================================================
  
  const handlePhotoUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    console.log('üéØ [HANDLER] handlePhotoUpload chamado!');
    console.log('üéØ [HANDLER] anuncioId:', anuncioId);
    console.log('üéØ [HANDLER] selectedRoomIndex:', selectedRoomIndex);
    console.log('üéØ [HANDLER] uploadingPhotos:', uploadingPhotos);
    console.log('üéØ [HANDLER] uploadInProgressRef.current:', uploadInProgressRef.current);
    
    const files = event.target.files;
    if (!files || selectedRoomIndex === -1) return;

    const room = rooms[selectedRoomIndex];
    
    console.log('üéØ [HANDLER] Room:', room.type, 'Files count:', files.length);

    // Se n√£o temos anuncioId, usar preview local
    if (!anuncioId) {
      console.log('‚ö†Ô∏è [HANDLER] ATEN√á√ÉO: anuncioId n√£o existe! Usando blob URLs...');
      console.log('‚ö†Ô∏è [HANDLER] Isso N√ÉO far√° upload real para Supabase!');

      const newPhotos: Photo[] = [];
      Array.from(files).forEach((file, index) => {
        const url = URL.createObjectURL(file);
        newPhotos.push({
          id: `photo-${Date.now()}-${index}`,
          url,
          tags: [],
          order: room.photos.length + index,
        });
      });

      updateRoom(selectedRoomIndex, {
        photos: [...room.photos, ...newPhotos],
      });
      toast.success(`${files.length} foto(s) adicionada(s)!`);
      return;
    }

    // Upload REAL para Supabase Storage
    // üõ°Ô∏è Prote√ß√£o dupla contra uploads simult√¢neos (state + ref)
    if (uploadingPhotos || uploadInProgressRef.current) {
      toast.error('Aguarde o upload anterior terminar');
      return;
    }
    
    console.log('üì∏ [UPLOAD] Iniciando upload de', files.length, 'fotos para o an√∫ncio:', anuncioId);
    console.log('üì∏ [UPLOAD] Room type:', room.type, 'Room index:', selectedRoomIndex);
    
    uploadInProgressRef.current = true;
    setUploadingPhotos(true);
    const newPhotos: Photo[] = [];
    
    try {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        console.log(`üì∏ [UPLOAD] Processando foto ${i + 1}/${files.length}:`, file.name);
        
        toast.loading(`Fazendo upload da foto ${i + 1}/${files.length}...`, {
          id: 'photo-upload',
        });

        // Upload para Supabase Storage
        const formData = new FormData();
        formData.append('file', file);
        formData.append('propertyId', anuncioId);
        formData.append('room', room.type || 'other');

        console.log('üì∏ [UPLOAD] Enviando requisi√ß√£o para:', `${SUPABASE_URL}/functions/v1/rendizy-server/photos/upload`);
        
        const response = await fetch(`${SUPABASE_URL}/functions/v1/rendizy-server/photos/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${ANON_KEY}`,
          },
          body: formData,
        });
        
        console.log('üì∏ [UPLOAD] Resposta HTTP:', response.status, response.statusText);

        if (!response.ok) {
          throw new Error(`Upload failed: ${response.statusText}`);
        }

        const result = await response.json();
        
        newPhotos.push({
          id: result.photo.id,
          url: result.photo.url,
          path: result.photo.path,
          tags: [],
          order: room.photos.length + i,
        });
      }

      // ‚ö° Atualizar room usando setTimeout para evitar conflitos DOM
      setTimeout(() => {
        updateRoom(selectedRoomIndex, {
          photos: [...room.photos, ...newPhotos],
        });
        
        toast.success(`${files.length} foto(s) enviada(s) com sucesso!`, {
          id: 'photo-upload',
        });
      }, 0);
    } catch (error) {
      console.error('‚ùå [UPLOAD] Erro ao fazer upload:', error);
      toast.error('Erro ao fazer upload das fotos', {
        id: 'photo-upload',
      });
    } finally {
      // üßπ Limpar ambas as prote√ß√µes
      uploadInProgressRef.current = false;
      setUploadingPhotos(false);
    }
  };

  const togglePhotoSelection = (photoId: string) => {
    setSelectedPhotos((prev) =>
      prev.includes(photoId)
        ? prev.filter((id) => id !== photoId)
        : [...prev, photoId]
    );
  };

  const selectAllPhotos = () => {
    if (selectedRoomIndex === -1) return;
    const room = rooms[selectedRoomIndex];
    setSelectedPhotos(room.photos.map((p) => p.id));
  };

  const deselectAllPhotos = () => {
    setSelectedPhotos([]);
  };

  const applyTagsToSelected = (tags: string[]) => {
    if (selectedRoomIndex === -1) return;

    const room = rooms[selectedRoomIndex];
    const updatedPhotos = room.photos.map((photo) => {
      if (selectedPhotos.includes(photo.id)) {
        return { ...photo, tags: [...new Set([...photo.tags, ...tags])] };
      }
      return photo;
    });

    updateRoom(selectedRoomIndex, { photos: updatedPhotos });
    setShowTagsModal(false);
    setSelectedPhotos([]);
    toast.success('Tags aplicadas!');
  };

  const removePhotoTag = (photoId: string, tag: string) => {
    if (selectedRoomIndex === -1) return;

    const room = rooms[selectedRoomIndex];
    const updatedPhotos = room.photos.map((photo) => {
      if (photo.id === photoId) {
        return { ...photo, tags: photo.tags.filter((t) => t !== tag) };
      }
      return photo;
    });

    updateRoom(selectedRoomIndex, { photos: updatedPhotos });
  };

  const deletePhoto = (photoId: string) => {
    if (selectedRoomIndex === -1) return;

    const room = rooms[selectedRoomIndex];
    const updatedPhotos = room.photos.filter((p) => p.id !== photoId);

    updateRoom(selectedRoomIndex, { photos: updatedPhotos });
    toast.success('Foto removida!');
  };

  // ============================================================================
  // üíæ SAVE STEP 03 - C√îMODOS COMPLETOS
  // ============================================================================
  const saveRoomsData = async () => {
    console.log('üè† [SAVE] SALVANDO C√îMODOS (Array completo)');
    console.log('üè† [SAVE] Total de c√¥modos:', rooms.length);
    console.log('üè† [SAVE] Dados dos c√¥modos:', JSON.stringify(rooms, null, 2));
    
    if (!anuncioId) {
      console.error('‚ùå [SAVE] An√∫ncio sem ID');
      toast.error('‚ùå Erro: An√∫ncio sem ID');
      return false;
    }
    
    // Valida√ß√£o: pelo menos 1 c√¥modo
    if (rooms.length === 0) {
      console.warn('‚ö†Ô∏è [SAVE] Nenhum c√¥modo para salvar');
      toast.error('‚ùå Adicione pelo menos 1 c√¥modo');
      return false;
    }
    
    // Valida√ß√£o: todos os c√¥modos devem ter tipo
    const invalidRooms = rooms.filter(r => !r.type);
    if (invalidRooms.length > 0) {
      console.error('‚ùå [SAVE] C√¥modos sem tipo:', invalidRooms);
      toast.error('‚ùå Todos os c√¥modos precisam ter um tipo selecionado');
      return false;
    }
    
    console.log('‚úÖ [SAVE] Valida√ß√µes OK, iniciando save...');
    
    try {
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      const roomsJson = JSON.stringify(rooms);
      
      console.log('üîó [SAVE] URL:', url);
      console.log('üì¶ [SAVE] Payload:', { anuncio_id: anuncioId, field: 'rooms', value_length: roomsJson.length });
      
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ anuncio_id: anuncioId, field: 'rooms', value: roomsJson })
      });
      
      console.log('üì° [SAVE] Status HTTP:', res.status);
      
      const data = await res.json();
      console.log('üì° [SAVE] Resposta do servidor:', data);
      
      if (!res.ok) {
        console.error('‚ùå [SAVE] Erro HTTP:', res.status, data);
        throw new Error(data.error || `HTTP ${res.status}`);
      }
      
      console.log('‚úÖ [SAVE] C√¥modos salvos com sucesso!');
      console.log('‚úÖ [SAVE] Total salvo:', rooms.length, 'c√¥modo(s)');
      
      // CALCULAR CONTADORES PARA O CARD
      console.log('üî¢ [SAVE] Calculando contadores para exibi√ß√£o no card...');
      
      const bedroomsCount = rooms.filter(r => r.type === 'bedroom').length;
      const bathroomsCount = rooms.filter(r => r.type === 'bathroom').length;
      
      // Total de camas = soma de todas as camas em todos os c√¥modos
      const bedsCount = rooms.reduce((total, room) => {
        return total + (room.beds?.reduce((sum, bed) => sum + (bed.quantity || 0), 0) || 0);
      }, 0);
      
      // Total de h√≥spedes = soma de capacidade de todas as camas
      const guestsCount = rooms.reduce((total, room) => {
        return total + (room.beds?.reduce((sum, bed) => {
          const capacity = bed.type === 'solteiro' ? 1 :
                          bed.type === 'casal' ? 2 :
                          bed.type === 'queen' ? 2 :
                          bed.type === 'king' ? 2 :
                          bed.type === 'beliche' ? 2 : 1;
          return sum + (capacity * (bed.quantity || 0));
        }, 0) || 0);
      }, 0);
      
      console.log('üî¢ [SAVE] Contadores calculados:', {
        bedrooms: bedroomsCount,
        bathrooms: bathroomsCount,
        beds: bedsCount,
        guests: guestsCount
      });
      
      // SALVAR CONTADORES
      const counters = [
        { field: 'bedrooms', value: bedroomsCount },
        { field: 'bathrooms', value: bathroomsCount },
        { field: 'beds', value: bedsCount },
        { field: 'guests', value: guestsCount }
      ];
      
      for (const counter of counters) {
        console.log(`üíæ [SAVE] Salvando ${counter.field}: ${counter.value}`);
        const resCounter = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
          body: JSON.stringify({ anuncio_id: anuncioId, field: counter.field, value: counter.value })
        });
        
        const dataCounter = await resCounter.json();
        if (!resCounter.ok) {
          console.error(`‚ùå [SAVE] Erro ao salvar ${counter.field}:`, dataCounter.error);
        } else {
          console.log(`‚úÖ [SAVE] ${counter.field} salvo: ${counter.value}`);
        }
      }
      
      setHasUnsavedChanges(false);
      
      setTimeout(() => toast.success(`‚úÖ ${rooms.length} c√¥modo(s) salvo(s)!`), 0);
      return true;
      
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO ao salvar c√¥modos:', error);
      console.error('‚ùå [SAVE] Tipo do erro:', error instanceof Error ? error.message : String(error));
      setTimeout(() => toast.error('‚ùå Erro ao salvar c√¥modos'), 0);
      return false;
    }
  };

  // ============================================================================
  // üíæ SAVE STEP 04 - TOUR VISUAL (FOTO DE CAPA)
  // ============================================================================
  const saveTourVisual = async () => {
    console.log('üñºÔ∏è [SAVE] SALVANDO TOUR VISUAL (foto de capa)');
    console.log('üñºÔ∏è [SAVE] Cover Photo ID:', coverPhotoId);
    
    if (!anuncioId) {
      console.error('‚ùå [SAVE] An√∫ncio sem ID');
      toast.error('‚ùå Erro: An√∫ncio sem ID');
      return false;
    }
    
    // Se n√£o h√° foto de capa selecionada, buscar a primeira foto dispon√≠vel
    let finalCoverPhotoId = coverPhotoId;
    if (!finalCoverPhotoId && rooms.length > 0) {
      for (const room of rooms) {
        if (room.photos.length > 0) {
          finalCoverPhotoId = room.photos[0].id;
          console.log('‚ÑπÔ∏è [SAVE] Usando primeira foto como capa:', finalCoverPhotoId);
          break;
        }
      }
    }
    
    console.log('‚úÖ [SAVE] Salvando coverPhotoId:', finalCoverPhotoId);
    
    try {
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ 
          anuncio_id: anuncioId, 
          field: 'cover_photo_id', 
          value: finalCoverPhotoId || null
        })
      });
      
      const data = await res.json();
      
      if (!res.ok) {
        console.error('‚ùå [SAVE] Erro HTTP:', res.status, data);
        throw new Error(data.error || `HTTP ${res.status}`);
      }
      
      console.log('‚úÖ [SAVE] Tour Visual salvo com sucesso!');
      setCoverPhotoId(finalCoverPhotoId); // Atualizar state
      setHasUnsavedChanges(false);
      
      setTimeout(() => toast.success('‚úÖ Foto de capa definida!'), 0);
      return true;
      
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO ao salvar tour visual:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar foto de capa'), 0);
      return false;
    }
  };

  // ============================================================================
  // üíæ SAVE STEP 05 - AMENIDADES DO LOCAL
  // ============================================================================
  const saveLocationAmenities = async () => {
    console.log('üè® [SAVE] SALVANDO AMENIDADES DO LOCAL');
    
    if (!anuncioId) {
      console.error('‚ùå [SAVE] An√∫ncio sem ID');
      toast.error('‚ùå Erro: An√∫ncio sem ID');
      return false;
    }
    
    const amenitiesData = {
      tickableAmenities: locationAmenities,
      checkInCheckout: checkInCheckout.enabled ? checkInCheckout : undefined,
      parking: parking.enabled ? parking : undefined,
      cableInternet: cableInternet.enabled ? cableInternet : undefined,
      wifiInternet: wifiInternet.enabled ? wifiInternet : undefined,
      reception24h: reception24h.enabled ? reception24h : undefined,
    };
    
    console.log('üì¶ [SAVE] Dados das amenidades:', amenitiesData);
    
    try {
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${ANON_KEY}` },
        body: JSON.stringify({ 
          anuncio_id: anuncioId, 
          field: 'location_amenities', 
          value: JSON.stringify(amenitiesData)
        })
      });
      
      const data = await res.json();
      
      if (!res.ok) {
        console.error('‚ùå [SAVE] Erro HTTP:', res.status, data);
        throw new Error(data.error || `HTTP ${res.status}`);
      }
      
      console.log('‚úÖ [SAVE] Amenidades salvas com sucesso!');
      setHasUnsavedChanges(false);
      
      setTimeout(() => toast.success('‚úÖ Amenidades do local salvas!'), 0);
      return true;
      
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO ao salvar amenidades:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar amenidades'), 0);
      return false;
    }
  };

  // ============================================================================
  // STEP 06 - AMENIDADES DA ACOMODA√á√ÉO
  // ============================================================================
  const saveListingAmenities = async () => {
    if (!anuncioId) {
      toast.error('ID do an√∫ncio n√£o encontrado');
      return false;
    }

    try {
      const listingData = {
        amenities: listingAmenities,
        areaM2: areaM2.enabled ? areaM2 : undefined,
        garagemGratuita: garagemGratuita.enabled ? garagemGratuita : undefined,
      };
      
      console.log('üíæ [SAVE] Salvando amenidades da acomoda√ß√£o:', listingData);

      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ANON_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          anuncio_id: anuncioId,
          field: 'listing_amenities',
          value: JSON.stringify(listingData)
        })
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }

      console.log('‚úÖ [SAVE] Amenidades da acomoda√ß√£o salvas com sucesso!');
      setHasUnsavedChanges(false);
      
      setTimeout(() => toast.success('‚úÖ Amenidades da acomoda√ß√£o salvas!'), 0);
      return true;
      
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO ao salvar amenidades da acomoda√ß√£o:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar amenidades'), 0);
      return false;
    }
  };

  // ============================================================================
  // STEP 07 - DESCRI√á√ÉO
  // ============================================================================
  const saveDescricao = async () => {
    if (!anuncioId) {
      toast.error('ID do an√∫ncio n√£o encontrado');
      return false;
    }

    try {
      console.log('üíæ [SAVE] Salvando descri√ß√£o...');

      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      
      // Salvar cada campo separadamente
      const fields = [
        { field: 'descricao_titulo', value: JSON.stringify(descricaoTitulo) },
        { field: 'notas_gerais', value: JSON.stringify(notasGerais) },
        { field: 'sobre_espaco', value: JSON.stringify(sobreEspaco) },
        { field: 'sobre_acesso', value: JSON.stringify(sobreAcesso) },
        { field: 'sobre_anfitriao', value: JSON.stringify(sobreAnfitriao) },
        { field: 'descricao_bairro', value: JSON.stringify(descricaoBairro) },
        { field: 'info_locomocao', value: JSON.stringify(infoLocomocao) },
      ];

      for (const { field, value } of fields) {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            anuncio_id: anuncioId,
            field,
            value
          })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status} ao salvar ${field}`);
        }
      }

      console.log('‚úÖ [SAVE] Descri√ß√£o salva com sucesso!');
      setHasUnsavedChanges(false);
      
      setTimeout(() => toast.success('‚úÖ Descri√ß√£o salva!'), 0);
      return true;
      
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO ao salvar descri√ß√£o:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar descri√ß√£o'), 0);
      return false;
    }
  };

  // ============================================================================
  // STEP 08 - CONFIGURA√á√ÉO DE RELACIONAMENTO
  // ============================================================================
  const saveRelacionamento = async () => {
    if (!anuncioId) {
      toast.error('ID do an√∫ncio n√£o encontrado');
      return false;
    }

    try {
      console.log('üíæ [SAVE] Salvando configura√ß√£o de relacionamento...');

      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      
      const fields = [
        { field: 'titular_imovel', value: titularImovel },
        { field: 'administrador_imovel', value: administradorImovel },
        { field: 'data_cadastro', value: dataCadastro?.toISOString() },
        { field: 'is_sublocacao', value: isSublocacao },
        { field: 'is_exclusivo', value: isExclusivo },
        { field: 'data_inicio_contrato', value: dataInicioContrato?.toISOString() },
        { field: 'data_fim_contrato', value: dataFimContrato?.toISOString() },
        { field: 'bloquear_calendario_apos_fim', value: bloquearCalendarioAposFim },
        { field: 'modelo_comissao', value: modeloComissao },
        { field: 'tipo_comissao', value: tipoComissao },
        { field: 'percentual_comissao', value: percentualComissao },
        { field: 'base_calculo_comissao', value: baseCalculoComissao },
        { field: 'considerar_taxas_canais', value: considerarTaxasCanais },
        { field: 'deduzir_taxas_canais', value: deduzirTaxasCanais },
        { field: 'permitir_transferencia_exclusiva', value: permitirTransferenciaExclusiva },
        { field: 'modo_cobranca_energia', value: modoCobrancaEnergia },
      ];

      for (const { field, value } of fields) {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            anuncio_id: anuncioId,
            field,
            value
          })
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status} ao salvar ${field}`);
        }
      }

      console.log('‚úÖ [SAVE] Configura√ß√£o de relacionamento salva!');
      setHasUnsavedChanges(false);
      
      setTimeout(() => toast.success('‚úÖ Configura√ß√£o salva!'), 0);
      return true;
      
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO ao salvar configura√ß√£o:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar configura√ß√£o'), 0);
      return false;
    }
  };

  // ============================================================================
  // STEP 09 - PRE√áOS LOCA√á√ÉO E VENDA
  // ============================================================================
  const savePrecosLocacaoVenda = async () => {
    if (!anuncioId) {
      toast.error('ID do an√∫ncio n√£o encontrado');
      return false;
    }

    try {
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      const fields = [
        { field: 'tipo_negocio', value: tipoNegocio },
        { field: 'valor_aluguel', value: valorAluguel },
        { field: 'valor_iptu', value: valorIptu },
        { field: 'valor_condominio', value: valorCondominio },
        { field: 'taxa_servico', value: taxaServico },
        { field: 'valor_venda', value: valorVenda },
        { field: 'iptu_anual', value: iptuAnual },
        { field: 'aceita_financiamento', value: aceitaFinanciamento },
        { field: 'aceita_permuta', value: aceitaPermuta },
      ];

      for (const { field, value } of fields) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${ANON_KEY}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ anuncio_id: anuncioId, field, value })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status} ao salvar ${field}`);
      }

      setHasUnsavedChanges(false);
      setTimeout(() => toast.success('‚úÖ Pre√ßos salvos!'), 0);
      return true;
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar pre√ßos'), 0);
      return false;
    }
  };

  // ============================================================================
  // STEP 10 - CONFIGURA√á√ÉO DE PRE√áO TEMPORADA
  // ============================================================================
  const saveConfigPrecoTemporada = async () => {
    if (!anuncioId) {
      toast.error('ID do an√∫ncio n√£o encontrado');
      return false;
    }

    try {
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      const fields = [
        { field: 'modo_config_preco', value: modoConfigPreco },
        { field: 'regiao', value: regiao },
        { field: 'moeda', value: moeda },
        { field: 'desconto_longa_estadia', value: descontoLongaEstadia },
        { field: 'desconto_semanal', value: descontoSemanal },
        { field: 'desconto_mensal', value: descontoMensal },
        { field: 'valor_deposito', value: valorDeposito },
        { field: 'usar_precificacao_dinamica', value: usarPrecificacaoDinamica },
        { field: 'taxa_limpeza', value: taxaLimpeza },
        { field: 'taxa_pet', value: taxaPet },
        { field: 'taxa_servicos_extras', value: taxaServicosExtras },
      ];

      for (const { field, value } of fields) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${ANON_KEY}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ anuncio_id: anuncioId, field, value })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status} ao salvar ${field}`);
      }

      setHasUnsavedChanges(false);
      setTimeout(() => toast.success('‚úÖ Configura√ß√£o salva!'), 0);
      return true;
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar configura√ß√£o'), 0);
      return false;
    }
  };

  // ============================================================================
  // STEP 11 - PRECIFICA√á√ÉO INDIVIDUAL
  // ============================================================================
  const savePrecificacaoIndividual = async () => {
    if (!anuncioId) {
      toast.error('ID do an√∫ncio n√£o encontrado');
      return false;
    }

    try {
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      const fields = [
        { field: 'preco_base_noite', value: precoBaseNoite },
        { field: 'desconto_permanencia_2_noites', value: descontoPermanencia2Noites },
        { field: 'desconto_permanencia_7_noites', value: descontoPermanencia7Noites },
        { field: 'desconto_permanencia_30_noites', value: descontoPermanencia30Noites },
        { field: 'periodos_sazonais', value: periodosSazonais },
        { field: 'precos_dia_semana', value: precosDiaSemana },
        { field: 'datas_especiais', value: datasEspeciais },
      ];

      for (const { field, value } of fields) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${ANON_KEY}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ anuncio_id: anuncioId, field, value })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status} ao salvar ${field}`);
      }

      setHasUnsavedChanges(false);
      setTimeout(() => toast.success('‚úÖ Precifica√ß√£o salva!'), 0);
      return true;
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar precifica√ß√£o'), 0);
      return false;
    }
  };

  // ============================================================================
  // STEP 12 - PRE√áOS DERIVADOS
  // ============================================================================
  const savePrecosDerviados = async () => {
    if (!anuncioId) {
      toast.error('ID do an√∫ncio n√£o encontrado');
      return false;
    }

    try {
      const url = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
      const fields = [
        { field: 'variacao_por_hospedes', value: variacaoPorHospedes },
        { field: 'taxa_hospede_extra', value: taxaHospedeExtra },
        { field: 'cobrar_criancas', value: cobrarCriancas },
        { field: 'idade_minima_crianca', value: idadeMinimaCrianca },
        { field: 'idade_maxima_crianca', value: idadeMaximaCrianca },
        { field: 'desconto_crianca', value: descontoCrianca },
      ];

      for (const { field, value } of fields) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${ANON_KEY}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ anuncio_id: anuncioId, field, value })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status} ao salvar ${field}`);
      }

      setHasUnsavedChanges(false);
      setTimeout(() => toast.success('‚úÖ Pre√ßos derivados salvos!'), 0);
      return true;
    } catch (error) {
      console.error('‚ùå [SAVE] ERRO:', error);
      setTimeout(() => toast.error('‚ùå Erro ao salvar pre√ßos derivados'), 0);
      return false;
    }
  };

  // Handlers simples - s√≥ atualiza estado, marca como n√£o salvo
  const handleTitleChange = (value: string) => {
    setTitle(asString(value, ''));
    setHasUnsavedChanges(true);
  };

  const handleDescriptionChange = (value: string) => {
    setDescription(asString(value, ''));
    setHasUnsavedChanges(true);
  };

  const handleTipoLocalChange = (value: string) => {
    console.log('üîÑ [CHANGE] handleTipoLocalChange chamado com:', value);
    const safe = asString(value, '');
    console.log('üîÑ [CHANGE] Valor ap√≥s asString:', safe);
    console.log('üîÑ [CHANGE] Est√° na whitelist?', allowedTipoLocal.has(safe));
    const finalValue = allowedTipoLocal.has(safe) ? safe : '';
    console.log('üîÑ [CHANGE] Valor final a setar:', finalValue);
    setTipoLocal(finalValue);
    setHasUnsavedChanges(true);
    console.log('üîÑ [CHANGE] hasUnsavedChanges setado para TRUE');
  };

  const handleTipoAcomodacaoChange = (value: string) => {
    const safe = asString(value, '');
    setTipoAcomodacao(allowedTipoAcomodacao.has(safe) ? safe : '');
    setHasUnsavedChanges(true);
  };

  const handleSubtypeChange = (value: string) => {
    const safe = asString(value, '');
    setSubtype(allowedSubtype.has(safe) ? safe : '');
    setHasUnsavedChanges(true);
  };

  const handleModalidadeToggle = (modalidade: string) => {
    const newModalidades = modalidades.includes(modalidade)
      ? modalidades.filter(m => m !== modalidade)
      : [...modalidades, modalidade];
    setModalidades(newModalidades);
    setHasUnsavedChanges(true);
  };

  const handleEstruturaChange = (value: string) => {
    const safe = value === 'vinculado' ? 'vinculado' : 'individual';
    setEstrutura(safe as any);
    setHasUnsavedChanges(true);
  };

  // Navega√ß√£o livre entre steps - sem valida√ß√£o de ordem

  const handleBack = () => {
    navigate('/anuncios-ultimate/lista');
  };

  const progress = Math.round((currentStep / STEPS.length) * 100);

  // üîÑ Loading inicial - aguardar carregar dados do banco
  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
        <div className="text-center space-y-4">
          <Loader2 className="w-12 h-12 animate-spin text-blue-600 mx-auto" />
          <div>
            <p className="text-lg font-medium text-gray-900 dark:text-gray-100">Carregando an√∫ncio...</p>
            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">Aguarde enquanto buscamos os dados</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
      {/* Header */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
        <div className="flex items-center justify-between max-w-7xl mx-auto">
          <div className="flex items-center gap-4">
            <Button
              variant="ghost"
              size="sm"
              onClick={handleBack}
              className="text-gray-600 dark:text-gray-400"
            >
              <ArrowLeft className="w-4 h-4 mr-2" />
              Voltar para Im√≥veis
            </Button>
            <div className="h-6 w-px bg-gray-300 dark:bg-gray-600"></div>
            <div>
              <h1 className="text-xl font-semibold text-gray-900 dark:text-gray-100">
                {anuncioId ? 'Editar An√∫ncio' : 'Novo An√∫ncio'}
              </h1>
              <p className="text-sm text-gray-500 dark:text-gray-400">
                {anuncioId ? 'An√∫ncio ID: ' + anuncioId.slice(0, 8) + '...' : 'Nova Propriedade - Complete os 7 passos para finalizar a configura√ß√£o'}
              </p>
            </div>
          </div>
          
          <div className="flex items-center gap-3">
            <span className="text-sm text-gray-600 dark:text-gray-400">
              0 de 17 passos
            </span>
          </div>
        </div>
      </div>

      {/* Progress Bar */}
      <div className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div className="h-2 bg-gray-200 dark:bg-gray-700">
          <div 
            className="h-full bg-blue-600 transition-all duration-300"
            style={{ width: `${progress}%` }}
          ></div>
        </div>
      </div>

      <div className="flex max-w-7xl mx-auto">
        {/* Sidebar - Steps */}
        <div className="w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 p-6 min-h-[calc(100vh-140px)]">
          <div className="space-y-1">
            {steps.map((step) => (
              <button
                key={step.id}
                onClick={() => setCurrentStep(step.id)}
                className={cn(
                  'w-full flex items-start gap-3 p-3 rounded-lg text-left transition-all',
                  currentStep === step.id 
                    ? 'bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800' 
                    : 'hover:bg-gray-50 dark:hover:bg-gray-700/50'
                )}
              >
                {/* Status Icon */}
                <div className={cn(
                  'flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center text-xs font-semibold',
                  step.status === 'completed' ? 'bg-green-500 text-white' :
                  step.status === 'processing' ? 'bg-blue-500 text-white' :
                  'bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400'
                )}>
                  {step.status === 'completed' ? (
                    <Check className="w-4 h-4" />
                  ) : step.status === 'processing' ? (
                    <Clock className="w-4 h-4" />
                  ) : (
                    step.id
                  )}
                </div>

                {/* Content */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className={cn(
                      'text-sm font-medium truncate',
                      currentStep === step.id 
                        ? 'text-gray-900 dark:text-gray-100' 
                        : 'text-gray-600 dark:text-gray-400'
                    )}>
                      {step.title}
                    </span>
                  </div>
                  <div className="flex items-center gap-1 mt-0.5">
                    {step.required && (
                      <span className="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">
                        Obrigat√≥rio
                      </span>
                    )}
                    {!step.required && (
                      <span className="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
                        Opcional
                      </span>
                    )}
                    {step.status === 'processing' && (
                      <span className="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">
                        Processando
                      </span>
                    )}
                  </div>
                </div>
              </button>
            ))}
          </div>
        </div>

        {/* Main Content */}
        <div className="flex-1 p-8">
          <div className="max-w-3xl">
            {currentStep === 1 && (
              <>
                <div className="mb-6">
                  <div className="flex items-center gap-2 mb-2">
                    <span className="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">
                      Passo 1 de 7
                    </span>
                    <span className="inline-flex items-center px-2 py-1 rounded text-xs font-semibold bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">
                      Obrigat√≥rio
                    </span>
                  </div>
                  <h2 className="text-2xl font-bold text-gray-900 dark:text-gray-100">
                    Tipo e Identifica√ß√£o
                  </h2>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    Que tipo de propriedade voc√™ est√° anunciando?
                  </p>
                </div>

                <div className="space-y-6 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
                  {/* Identifica√ß√£o Interna */}
                  <div>
                    <Label htmlFor="title" className="text-sm font-semibold text-gray-900 dark:text-gray-100">
                      Identifica√ß√£o Interna
                    </Label>
                    <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">
                      Nome para identificar este im√≥vel no painel administrativo (vis√≠vel apenas para voc√™)
                    </p>
                    <Input
                      id="title"
                      placeholder="Teste Antigonny Propriedade"
                      value={title}
                      onChange={(e) => handleTitleChange(e.target.value)}
                      className="w-full"
                    />
                    {title && (
                      <p className="text-xs text-blue-600 dark:text-blue-400 mt-1 flex items-center gap-1">
                        <Check className="w-3 h-3" />
                        Campo preenchido (n√£o salvo)
                      </p>
                    )}
                  </div>

                  {/* Tipo de Local - NATIVE SELECT */}
                  <div>
                    <Label htmlFor="tipoLocal" className="text-sm font-semibold text-gray-900 dark:text-gray-100">
                      Tipo de local
                    </Label>
                    <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">
                      Qual √© o tipo de local?
                    </p>
                    <select
                      id="tipoLocal"
                      value={tipoLocal}
                      onChange={(e) => handleTipoLocalChange(e.target.value)}
                      className="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-900 dark:text-gray-100"
                    >
                      <option value="">Selecione o tipo de local</option>
                      <option value="acomodacao_movel">Acomoda√ß√£o M√≥vel</option>
                      <option value="albergue">Albergue</option>
                      <option value="apartamento">Apartamento</option>
                      <option value="apartamento_residencial">Apartamento/Residencial</option>
                      <option value="bangalo">Bangal√¥</option>
                      <option value="barco">Barco</option>
                      <option value="barco_beira">Barco/Beira</option>
                      <option value="boutique">Boutique Hotel</option>
                      <option value="cabana">Cabana</option>
                      <option value="cama_cafe">Cama e Caf√© (B&B)</option>
                      <option value="camping">Camping</option>
                      <option value="casa">Casa</option>
                      <option value="casa_movel">Casa M√≥vel</option>
                      <option value="castelo">Castelo</option>
                      <option value="chale">Chal√©</option>
                      <option value="chale_camping">Chal√© (√Årea de Camping)</option>
                      <option value="condominio">Condom√≠nio</option>
                      <option value="estalagem">Estalagem</option>
                      <option value="fazenda">Fazenda para Viajantes</option>
                      <option value="hotel">Hotel</option>
                      <option value="hotel_boutique">Hotel Boutique</option>
                      <option value="hostel">Hostel</option>
                      <option value="iate">Iate</option>
                      <option value="industrial">Industrial</option>
                      <option value="motel">Motel/Carro</option>
                      <option value="pousada">Pousada Exclusiva</option>
                      <option value="residencia">Resid√™ncia</option>
                      <option value="resort">Resort</option>
                      <option value="treehouse">Treehouse (Casa na √Årvore)</option>
                      <option value="villa">Villa/Casa</option>
                    </select>
                    {tipoLocal && (
                      <p className="text-xs text-blue-600 dark:text-blue-400 mt-1 flex items-center gap-1">
                        <Check className="w-3 h-3" />
                        Campo preenchido (n√£o salvo)
                      </p>
                    )}
                  </div>

                  {/* Tipo de Acomoda√ß√£o - NATIVE SELECT */}
                  <div>
                    <Label htmlFor="tipoAcomodacao" className="text-sm font-semibold text-gray-900 dark:text-gray-100">
                      Tipo de acomoda√ß√£o
                    </Label>
                    <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">
                      Selecione o tipo de acomoda√ß√£o
                    </p>
                    <select
                      id="tipoAcomodacao"
                      value={tipoAcomodacao}
                      onChange={(e) => handleTipoAcomodacaoChange(e.target.value)}
                      className="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-900 dark:text-gray-100"
                    >
                      <option value="">Selecione</option>
                      <option value="apartamento">Apartamento</option>
                      <option value="bangalo">Bangal√¥</option>
                      <option value="cabana">Cabana</option>
                      <option value="camping">Camping</option>
                      <option value="capsula">C√°psula/Trailer/Casa M√≥vel</option>
                      <option value="casa">Casa</option>
                      <option value="casa_dormitorios">Casa em Dormit√≥rios</option>
                      <option value="chale">Chal√©</option>
                      <option value="condominio">Condom√≠nio</option>
                      <option value="dormitorio">Dormit√≥rio</option>
                      <option value="estudio">Est√∫dio</option>
                      <option value="holiday_home">Holiday Home</option>
                      <option value="hostel">Hostel</option>
                      <option value="hotel">Hotel</option>
                      <option value="iate">Iate</option>
                      <option value="industrial">Industrial</option>
                      <option value="loft">Loft</option>
                      <option value="quarto_compartilhado">Quarto Compartilhado</option>
                      <option value="quarto_inteiro">Quarto Inteiro</option>
                      <option value="quarto_privado">Quarto Privado</option>
                      <option value="suite">Su√≠te</option>
                      <option value="treehouse">Treehouse</option>
                      <option value="villa">Villa/Casa</option>
                    </select>
                    {tipoAcomodacao && (
                      <p className="text-xs text-green-600 dark:text-green-400 mt-1 flex items-center gap-1">
                        <Check className="w-3 h-3" />
                        Campo preenchido
                      </p>
                    )}
                  </div>

                  {/* Subtipo - NATIVE SELECT */}
                  <div>
                    <Label htmlFor="subtype" className="text-sm font-semibold text-gray-900 dark:text-gray-100">
                      Subtipo
                    </Label>
                    <p className="text-xs text-gray-500 dark:text-gray-400 mb-2">
                      Qual √© o subtipo desta acomoda√ß√£o?
                    </p>
                    <select
                      id="subtype"
                      value={subtype}
                      onChange={(e) => handleSubtypeChange(e.target.value)}
                      className="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 text-gray-900 dark:text-gray-100"
                    >
                      <option value="">Selecione o subtipo</option>
                      <option value="entire_place">Im√≥vel Inteiro</option>
                      <option value="private_room">Quarto Privativo</option>
                      <option value="shared_room">Quarto Compartilhado</option>
                    </select>
                    {subtype && (
                      <p className="text-xs text-green-600 dark:text-green-400 mt-1 flex items-center gap-1">
                        <Check className="w-3 h-3" />
                        Campo preenchido
                      </p>
                    )}
                  </div>

                  {/* Modalidade */}
                  <div>
                    <Label className="text-sm font-semibold text-gray-900 dark:text-gray-100">
                      Moda
                    </Label>
                    <p className="text-xs text-gray-500 dark:text-gray-400 mb-3">
                      Em quais modalidades essa unidade estar√° dispon√≠vel?
                    </p>
                    <div className="space-y-3">
                      <div className="flex items-center space-x-2">
                        <Checkbox
                          id="temporada"
                          checked={modalidades.includes('temporada')}
                          onCheckedChange={() => handleModalidadeToggle('temporada')}
                        />
                        <label
                          htmlFor="temporada"
                          className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-gray-700 dark:text-gray-300"
                        >
                          Aluguel por temporada
                        </label>
                      </div>
                      <div className="flex items-center space-x-2">
                        <Checkbox
                          id="compra-venda"
                          checked={modalidades.includes('compra-venda')}
                          onCheckedChange={() => handleModalidadeToggle('compra-venda')}
                        />
                        <label
                          htmlFor="compra-venda"
                          className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-gray-700 dark:text-gray-300"
                        >
                          Compra e venda
                        </label>
                      </div>
                      <div className="flex items-center space-x-2">
                        <Checkbox
                          id="locacao"
                          checked={modalidades.includes('locacao')}
                          onCheckedChange={() => handleModalidadeToggle('locacao')}
                        />
                        <label
                          htmlFor="locacao"
                          className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 text-gray-700 dark:text-gray-300"
                        >
                          Loca√ß√£o residencial
                        </label>
                      </div>
                    </div>
                    {modalidades.length > 0 && (
                      <p className="text-xs text-blue-600 dark:text-blue-400 mt-2 flex items-center gap-1">
                        <Check className="w-3 h-3" />
                        {modalidades.length} modalidade(s) selecionada(s) (n√£o salvo)
                      </p>
                    )}
                  </div>

                  {/* Estrutura do An√∫ncio */}
                  <div>
                    <Label className="text-sm font-semibold text-gray-900 dark:text-gray-100 mb-3 block">
                      Estrutura do An√∫ncio
                    </Label>
                    <p className="text-xs text-gray-500 dark:text-gray-400 mb-3">
                      Selecione para as unidades do local serem gerenciadas individualmente
                    </p>
                    <RadioGroup value={estrutura} onValueChange={handleEstruturaChange}>
                      <div className="grid grid-cols-2 gap-4">
                        {/* An√∫ncio Individual */}
                        <div
                          className={cn(
                            'relative rounded-lg border-2 p-4 cursor-pointer transition-all',
                            estrutura === 'individual'
                              ? 'border-blue-600 bg-blue-50 dark:bg-blue-900/20'
                              : 'border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500'
                          )}
                        >
                          <RadioGroupItem value="individual" id="individual" className="sr-only" />
                          <label htmlFor="individual" className="cursor-pointer">
                            <div className="flex items-start gap-3">
                              <div className={cn(
                                'w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-0.5',
                                estrutura === 'individual'
                                  ? 'border-blue-600 bg-blue-600'
                                  : 'border-gray-300 dark:border-gray-600'
                              )}>
                                {estrutura === 'individual' && (
                                  <div className="w-2 h-2 rounded-full bg-white"></div>
                                )}
                              </div>
                              <div className="flex-1">
                                <p className="font-medium text-sm text-gray-900 dark:text-gray-100 mb-1">
                                  An√∫ncio Individual
                                </p>
                                <p className="text-xs text-gray-500 dark:text-gray-400">
                                  Casa, apartamento sem pr√©dio, etc
                                </p>
                                <div className="mt-3 space-y-1">
                                  <div className="flex items-center gap-1.5 text-xs">
                                    <div className="w-2 h-2 rounded-full bg-green-500"></div>
                                    <span className="text-gray-600 dark:text-gray-400">
                                      Anunciado no local: <strong className="text-gray-900 dark:text-gray-100">Edificado</strong>
                                    </span>
                                  </div>
                                  <div className="flex items-center gap-1.5 text-xs">
                                    <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                                    <span className="text-gray-600 dark:text-gray-400">
                                      Previsibilidade de acomoda√ß√£o: <strong className="text-gray-900 dark:text-gray-100">Edit√°veis</strong>
                                    </span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </label>
                        </div>

                        {/* An√∫ncio Vinculado */}
                        <div
                          className={cn(
                            'relative rounded-lg border-2 p-4 cursor-pointer transition-all',
                            estrutura === 'vinculado'
                              ? 'border-blue-600 bg-blue-50 dark:bg-blue-900/20'
                              : 'border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500'
                          )}
                        >
                          <RadioGroupItem value="vinculado" id="vinculado" className="sr-only" />
                          <label htmlFor="vinculado" className="cursor-pointer">
                            <div className="flex items-start gap-3">
                              <div className={cn(
                                'w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-0.5',
                                estrutura === 'vinculado'
                                  ? 'border-blue-600 bg-blue-600'
                                  : 'border-gray-300 dark:border-gray-600'
                              )}>
                                {estrutura === 'vinculado' && (
                                  <div className="w-2 h-2 rounded-full bg-white"></div>
                                )}
                              </div>
                              <div className="flex-1">
                                <p className="font-medium text-sm text-gray-900 dark:text-gray-100 mb-1">
                                  An√∫ncio Vinculado
                                </p>
                                <p className="text-xs text-gray-500 dark:text-gray-400">
                                  Apartamento em pr√©dio, quarto em hotel, etc
                                </p>
                                <div className="mt-3 space-y-1">
                                  <div className="flex items-center gap-1.5 text-xs">
                                    <div className="w-2 h-2 rounded-full bg-orange-500"></div>
                                    <span className="text-gray-600 dark:text-gray-400">
                                      Anunciado no local: <strong className="text-gray-900 dark:text-gray-100">Herdados</strong>
                                    </span>
                                  </div>
                                  <div className="flex items-center gap-1.5 text-xs">
                                    <div className="w-2 h-2 rounded-full bg-blue-500"></div>
                                    <span className="text-gray-600 dark:text-gray-400">
                                      Previsibilidade de acomoda√ß√£o: <strong className="text-gray-900 dark:text-gray-100">Edit√°veis</strong>
                                    </span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </RadioGroup>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button
                    variant="outline"
                    onClick={handleBack}
                  >
                    Cancelar
                  </Button>
                  
                  <div className="flex items-center gap-3">
                    {hasUnsavedChanges && (
                      <p className="text-sm text-orange-600 dark:text-orange-400 font-semibold flex items-center gap-2">
                        <AlertCircle className="w-4 h-4" />
                        Mudan√ßas n√£o salvas
                      </p>
                    )}
                    <Button
                      onClick={saveAllStep1Fields}
                      className={cn(
                        "font-bold",
                        hasUnsavedChanges 
                          ? "bg-orange-600 hover:bg-orange-700 text-white animate-pulse" 
                          : "bg-green-600 hover:bg-green-700 text-white"
                      )}
                    >
                      <Save className="w-4 h-4 mr-2" />
                      {hasUnsavedChanges ? 'SALVAR AGORA!' : 'SALVAR'}
                    </Button>
                  </div>
                </div>
              </>
            )}

            {currentStep === 2 && (
              <>
                <div className="space-y-6">
                  {/* Novo endere√ßo / Vincular a existente */}
                  <div className="flex gap-3 mb-6">
                    <Button variant="default" size="sm">Novo endere√ßo</Button>
                    <Button variant="outline" size="sm">Vincular a existente</Button>
                  </div>

                  {/* Grid: Formul√°rio + Mapa */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Formul√°rio de Endere√ßo */}
                    <div className="space-y-4">
                      {/* Pa√≠s */}
                      <div>
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                          Pa√≠s
                        </label>
                        <select
                          value={pais}
                          onChange={(e) => { setPais(e.target.value); setHasUnsavedChanges(true); }}
                          className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                        >
                          <option value="Brasil">Brasil (BR)</option>
                        </select>
                      </div>

                      {/* Estado + Sigla */}
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                            Estado
                          </label>
                          <input
                            type="text"
                            value={estado}
                            onChange={(e) => { setEstado(e.target.value); setHasUnsavedChanges(true); }}
                            placeholder="Rio de Janeiro"
                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                          />
                          {estado && (
                            <p className="text-xs text-blue-600 dark:text-blue-400 mt-1 flex items-center gap-1">
                              <Check className="w-3 h-3" />
                              Campo preenchido (n√£o salvo)
                            </p>
                          )}
                        </div>
                        <div>
                          <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                            Sigla do estado
                          </label>
                          <input
                            type="text"
                            value={siglaEstado}
                            onChange={(e) => { setSiglaEstado(e.target.value.toUpperCase()); setHasUnsavedChanges(true); }}
                            placeholder="RJ"
                            maxLength={2}
                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                          />
                          {siglaEstado && (
                            <p className="text-xs text-blue-600 dark:text-blue-400 mt-1 flex items-center gap-1">
                              <Check className="w-3 h-3" />
                              Campo preenchido (n√£o salvo)
                            </p>
                          )}
                        </div>
                      </div>

                      {/* CEP */}
                      <div>
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                          CEP
                        </label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={cep}
                            onChange={(e) => { setCep(e.target.value); setHasUnsavedChanges(true); }}
                            placeholder="28960-000"
                            className="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                          />
                          <Button
                            type="button"
                            variant="outline"
                            onClick={() => buscarCep(cep)}
                            disabled={!cep || cep.replace(/\D/g, '').length !== 8}
                          >
                            Buscar
                          </Button>
                        </div>
                        {cep && (
                          <p className="text-xs text-blue-600 dark:text-blue-400 mt-1 flex items-center gap-1">
                            <Check className="w-3 h-3" />
                            Campo preenchido (n√£o salvo)
                          </p>
                        )}
                      </div>

                      {/* Cidade */}
                      <div>
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                          Cidade
                        </label>
                        <input
                          type="text"
                          value={cidade}
                          onChange={(e) => { setCidade(e.target.value); setHasUnsavedChanges(true); }}
                          placeholder="Arma√ß√£o dos B√∫zios"
                          className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                        />
                        {cidade && (
                          <p className="text-xs text-blue-600 dark:text-blue-400 mt-1 flex items-center gap-1">
                            <Check className="w-3 h-3" />
                            Campo preenchido (n√£o salvo)
                          </p>
                        )}
                      </div>

                      {/* Bairro */}
                      <div>
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                          Bairro
                        </label>
                        <input
                          type="text"
                          value={bairro}
                          onChange={(e) => { setBairro(e.target.value); setHasUnsavedChanges(true); }}
                          placeholder="Praia Rasa"
                          className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                        />
                      </div>

                      {/* Rua + N√∫mero */}
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                            Rua
                          </label>
                          <input
                            type="text"
                            value={rua}
                            onChange={(e) => { setRua(e.target.value); setHasUnsavedChanges(true); }}
                            placeholder="Rua do Conteiro"
                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                          />
                          {rua && (
                            <p className="text-xs text-blue-600 dark:text-blue-400 mt-1 flex items-center gap-1">
                              <Check className="w-3 h-3" />
                              Campo preenchido (n√£o salvo)
                            </p>
                          )}
                        </div>
                        <div>
                          <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                            N√∫mero
                          </label>
                          <input
                            type="text"
                            value={numero}
                            onChange={(e) => { setNumero(e.target.value); setHasUnsavedChanges(true); }}
                            placeholder="N 156-a"
                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                          />
                          {numero && (
                            <p className="text-xs text-blue-600 dark:text-blue-400 mt-1 flex items-center gap-1">
                              <Check className="w-3 h-3" />
                              Campo preenchido (n√£o salvo)
                            </p>
                          )}
                        </div>
                      </div>

                      {/* Complemento */}
                      <div>
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                          Complemento
                        </label>
                        <input
                          type="text"
                          value={complemento}
                          onChange={(e) => { setComplemento(e.target.value); setHasUnsavedChanges(true); }}
                          placeholder="Piscada Recanto das Palmeiras"
                          className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"
                        />
                      </div>

                      {/* ‚ú® BOT√ÉO SALVAR ENDERE√áO ‚ú® */}
                      <div className="col-span-2 flex justify-end pt-4 pb-6 border-b-2 border-gray-200 dark:border-gray-700">
                        <Button
                          type="button"
                          onClick={saveAddressFields}
                          className="bg-blue-600 hover:bg-blue-700 text-white font-bold px-8"
                        >
                          <Save className="w-4 h-4 mr-2" /> Salvar Endere√ßo
                        </Button>
                      </div>

                      {/* Mostrar n√∫mero do pr√©dio */}
                      <div className="space-y-2">
                        <p className="text-sm font-medium text-gray-700 dark:text-gray-300">
                          Mostrar o n√∫mero do pr√©dio aos usu√°rios?
                        </p>
                        <p className="text-xs text-gray-500 dark:text-gray-400">
                          Ocultar esse n√∫mero d√° mais privacidade. Evita visitas fora de hor√°rio da propr.
                        </p>
                        <div className="flex gap-3">
                          <Button
                            type="button"
                            variant={mostrarNumero ? "default" : "outline"}
                            size="sm"
                            onClick={() => { setMostrarNumero(false); setHasUnsavedChanges(true); }}
                          >
                            Ocultar
                          </Button>
                          <Button
                            type="button"
                            variant={!mostrarNumero ? "default" : "outline"}
                            size="sm"
                            onClick={() => { setMostrarNumero(true); setHasUnsavedChanges(true); }}
                          >
                            Individual
                          </Button>
                        </div>
                      </div>
                    </div>

                    {/* Tipo de Acesso */}
                    <div>
                      <Label htmlFor="tipoAcesso">Tipo de Acesso ao Pr√©dio</Label>
                      <Select value={tipoAcesso} onValueChange={(value) => { setTipoAcesso(value); setHasUnsavedChanges(true); }}>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecione o tipo de acesso" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="portaria">Portaria 24h</SelectItem>
                          <SelectItem value="codigo">C√≥digo de acesso</SelectItem>
                          <SelectItem value="livre">Livre acesso</SelectItem>
                          <SelectItem value="outro">Outro</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    {/* Instru√ß√µes de Acesso */}
                    <div>
                      <Label htmlFor="instrucoesAcesso">Instru√ß√µes de Acesso (opcional)</Label>
                      <Textarea
                        id="instrucoesAcesso"
                        placeholder="Ex: Informar ao porteiro o nome do propriet√°rio. C√≥digo da porta √© 1234#"
                        value={instrucoesAcesso}
                        onChange={(e) => { setInstrucoesAcesso(e.target.value); setHasUnsavedChanges(true); }}
                        rows={3}
                      />
                    </div>

                    {/* Mapa */}
                    <div className="bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center p-8 min-h-[400px]">
                      <div className="text-center text-gray-500 dark:text-gray-400">
                        <MapPin className="w-12 h-12 mx-auto mb-3 text-gray-400" />
                        <p className="text-sm">Preencha o CEP para visualizar o mapa</p>
                      </div>
                    </div>
                  </div>

                  {/* Caracter√≠sticas do Local */}
                  <div className="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">
                      Caracter√≠sticas do Local
                    </h3>
                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                      Informa√ß√µes que os usu√°rios v√™em ao escolher as modalidades
                    </p>

                    <div className="space-y-3">
                      {/* Estacionamento */}
                      <div className="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div className="flex items-center gap-3">
                          <Car className="w-5 h-5 text-gray-600 dark:text-gray-400" />
                          <div>
                            <p className="font-medium text-sm text-gray-900 dark:text-gray-100">Estacionamento</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">Ex: Beco - Interno de garagem</p>
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <Button
                            type="button"
                            variant={estacionamento ? "default" : "outline"}
                            size="sm"
                            onClick={() => { setEstacionamento(true); setHasUnsavedChanges(true); }}
                          >
                            Sim
                          </Button>
                          <Button
                            type="button"
                            variant={!estacionamento ? "default" : "outline"}
                            size="sm"
                            onClick={() => { setEstacionamento(false); setHasUnsavedChanges(true); }}
                          >
                            N√£o
                          </Button>
                        </div>
                      </div>

                      {/* Internet a Cabo */}
                      <div className="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div className="flex items-center gap-3">
                          <Wifi className="w-5 h-5 text-gray-600 dark:text-gray-400" />
                          <div>
                            <p className="font-medium text-sm text-gray-900 dark:text-gray-100">Internet a Cabo</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">Ex: Banda - Fibra √≥ptica</p>
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <Button
                            type="button"
                            variant={internetCabo ? "default" : "outline"}
                            size="sm"
                            onClick={() => { setInternetCabo(true); setHasUnsavedChanges(true); }}
                          >
                            Sim
                          </Button>
                          <Button
                            type="button"
                            variant={!internetCabo ? "default" : "outline"}
                            size="sm"
                            onClick={() => { setInternetCabo(false); setHasUnsavedChanges(true); }}
                          >
                            N√£o
                          </Button>
                        </div>
                      </div>

                      {/* Internet Wi-Fi */}
                      <div className="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div className="flex items-center gap-3">
                          <Wifi className="w-5 h-5 text-gray-600 dark:text-gray-400" />
                          <div>
                            <p className="font-medium text-sm text-gray-900 dark:text-gray-100">Internet Wi-Fi</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">Ex: Banda - Fibra √≥ptica</p>
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <Button
                            type="button"
                            variant={internetWifi ? "default" : "outline"}
                            size="sm"
                            onClick={() => { setInternetWifi(true); setHasUnsavedChanges(true); }}
                          >
                            Sim
                          </Button>
                          <Button
                            type="button"
                            variant={!internetWifi ? "default" : "outline"}
                            size="sm"
                            onClick={() => { setInternetWifi(false); setHasUnsavedChanges(true); }}
                          >
                            N√£o
                          </Button>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Fotos do endere√ßo */}
                  <div className="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">
                      Fotos relacionadas ao endere√ßo
                    </h3>
                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                      Adicione fotos do entorno, fachada e √°reas sociais do endere√ßo. Arraste para reordenar
                    </p>
                    <div className="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center">
                      <ImageIcon className="w-12 h-12 mx-auto mb-3 text-gray-400" />
                      <p className="text-sm text-gray-500 dark:text-gray-400 mb-2">
                        Arraste suas imagens aqui ou clique para selecionar
                      </p>
                      <Button variant="outline" size="sm">
                        Selecionar imagens
                      </Button>
                    </div>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button
                    variant="outline"
                    onClick={() => setCurrentStep(1)}
                  >
                    Anterior
                  </Button>
                  
                  <div className="flex items-center gap-3">
                    {hasUnsavedChanges && (
                      <p className="text-sm text-orange-600 dark:text-orange-400 font-semibold flex items-center gap-2">
                        <AlertCircle className="w-4 h-4" />
                        Mudan√ßas n√£o salvas
                      </p>
                    )}
                    <Button
                      type="button"
                      onClick={saveAllStep2Fields}
                      className={cn(
                        "font-bold",
                        hasUnsavedChanges 
                          ? "bg-orange-600 hover:bg-orange-700 text-white animate-pulse" 
                          : "bg-green-600 hover:bg-green-700 text-white"
                      )}
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Caracter√≠sticas
                    </Button>
                  </div>
                </div>
              </>
            )}

            {/* STEP 3: C√îMODOS E FOTOS */}
            {currentStep === 3 && !isLoading && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-2">
                      üè† C√¥modos e Fotos
                    </h2>
                    <p className="text-sm text-gray-500 dark:text-gray-400">
                      Adicione c√¥modos, configure tipos, adicione fotos e organize com tags
                    </p>
                  </div>

                  {/* Bot√£o Adicionar C√¥modo */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={addRoom}
                      className="bg-blue-600 hover:bg-blue-700 text-white"
                    >
                      <Plus className="w-4 h-4 mr-2" /> Adicionar C√¥modo
                    </Button>
                  </div>

                  {/* Resumo dos C√¥modos */}
                  {rooms.length > 0 && (
                    <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                      <div className="flex items-center gap-4 text-sm text-blue-900 dark:text-blue-100">
                        <div className="flex items-center gap-2">
                          <Check className="w-4 h-4" />
                          <span className="font-medium">{rooms.length} c√¥modo(s)</span>
                        </div>
                        <div className="flex items-center gap-2">
                          <ImageIcon className="w-4 h-4" />
                          <span>{rooms.reduce((acc, r) => acc + r.photos.length, 0)} foto(s)</span>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Lista de C√¥modos */}
                  {rooms.length === 0 ? (
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-12 text-center">
                      <ImageIcon className="w-16 h-16 mx-auto mb-4 text-gray-400 dark:text-gray-600" />
                      <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">
                        Nenhum c√¥modo adicionado
                      </h3>
                      <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        Adicione c√¥modos para configurar tipos, camas e fotos
                      </p>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {rooms.map((room, index) => (
                        <div key={room.id} className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 space-y-4">
                          <div className="flex items-center justify-between">
                            <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100">
                              C√¥modo #{index + 1}
                            </h3>
                            <Button
                              type="button"
                              variant="outline"
                              size="sm"
                              onClick={() => removeRoom(index)}
                              className="text-red-600 hover:text-red-700 hover:bg-red-50"
                            >
                              <Trash2 className="w-4 h-4" />
                            </Button>
                          </div>

                          {/* Tipo de C√¥modo */}
                          <div>
                            <Label className="text-sm font-medium mb-2">Tipo de C√¥modo</Label>
                            <Select
                              value={room.type || undefined}
                              onValueChange={(value) => {
                                try {
                                  console.log('üè† [SELECT] Tipo selecionado:', value);
                                  console.log('üè† [SELECT] Index do c√¥modo:', index);
                                  console.log('üè† [SELECT] C√¥modo atual:', room);
                                  
                                  if (!value) {
                                    console.error('‚ùå [SELECT] Valor vazio recebido');
                                    return;
                                  }
                                  
                                  const roomType = ROOM_TYPES.find(rt => rt.id === value);
                                  console.log('üè† [SELECT] RoomType encontrado:', roomType);
                                  
                                  if (!roomType) {
                                    console.error('‚ùå [SELECT] Tipo de c√¥modo n√£o encontrado:', value);
                                    toast.error(`Tipo de c√¥modo inv√°lido: ${value}`);
                                    return;
                                  }
                                  
                                  updateRoom(index, {
                                    type: value,
                                    typeName: roomType.name,
                                  });
                                } catch (error) {
                                  console.error('‚ùå [SELECT] Erro ao mudar tipo:', error);
                                  toast.error('Erro ao selecionar tipo de c√¥modo');
                                }
                              }}
                            >
                              <SelectTrigger>
                                <SelectValue placeholder="Selecione o tipo" />
                              </SelectTrigger>
                              <SelectContent>
                                {ROOM_TYPES.map(rt => (
                                  <SelectItem key={rt.id} value={rt.id}>
                                    {rt.icon} {rt.name}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          {/* Nome Personalizado (se tipo = "outras") */}
                          {room.type === 'outras' && (
                            <div>
                              <Label className="text-sm font-medium mb-2">Nome Personalizado</Label>
                              <Select
                                value={room.customName || undefined}
                                onValueChange={(value) => updateRoom(index, { customName: value })}
                              >
                                <SelectTrigger>
                                  <SelectValue placeholder="Selecione ou especifique" />
                                </SelectTrigger>
                                <SelectContent>
                                  {CUSTOM_SPACE_NAMES.map(name => (
                                    <SelectItem key={name} value={name}>{name}</SelectItem>
                                  ))}
                                </SelectContent>
                              </Select>
                            </div>
                          )}

                          {/* C√¥modo Compartilhado */}
                          <div className="flex items-center gap-2">
                            <Checkbox
                              id={`shared-${room.id}`}
                              checked={room.isShared}
                              onCheckedChange={(checked) => updateRoom(index, { isShared: !!checked })}
                            />
                            <Label htmlFor={`shared-${room.id}`} className="text-sm cursor-pointer">
                              C√¥modo compartilhado
                            </Label>
                          </div>

                          {/* Camas (se for quarto/sala) */}
                          {room.type && (ROOM_TYPES.find(rt => rt.id === room.type)?.category === 'bedroom' || 
                                        ROOM_TYPES.find(rt => rt.id === room.type)?.category === 'living') && (
                            <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
                              <Label className="text-sm font-medium mb-3 block">Camas</Label>
                              <div className="grid grid-cols-2 gap-3">
                                {BED_TYPES.map(bed => (
                                  <div key={bed.id} className="flex items-center justify-between bg-gray-50 dark:bg-gray-900 p-2 rounded">
                                    <span className="text-xs">{bed.icon} {bed.name}</span>
                                    <div className="flex items-center gap-1">
                                      <Button
                                        type="button"
                                        variant="outline"
                                        size="icon"
                                        className="h-6 w-6"
                                        onClick={() => updateBedCount(index, bed.id, -1)}
                                      >
                                        -
                                      </Button>
                                      <span className="text-xs w-6 text-center">{room.beds[bed.id] || 0}</span>
                                      <Button
                                        type="button"
                                        variant="outline"
                                        size="icon"
                                        className="h-6 w-6"
                                        onClick={() => updateBedCount(index, bed.id, 1)}
                                      >
                                        +
                                      </Button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {/* Fotos do C√¥modo */}
                          <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
                            <div className="flex items-center justify-between mb-3">
                              <Label className="text-sm font-medium">
                                Fotos ({room.photos.length})
                                {selectedPhotos.length > 0 && selectedRoomIndex === index && (
                                  <span className="text-xs ml-2 text-blue-600 dark:text-blue-400">
                                    ({selectedPhotos.length} selecionada{selectedPhotos.length > 1 ? 's' : ''})
                                  </span>
                                )}
                              </Label>
                              <div className="flex gap-2">
                                {room.photos.length > 0 && selectedRoomIndex === index && (
                                  <>
                                    {selectedPhotos.length > 0 ? (
                                      <Button
                                        type="button"
                                        size="sm"
                                        variant="outline"
                                        onClick={deselectAllPhotos}
                                      >
                                        Limpar Sele√ß√£o
                                      </Button>
                                    ) : (
                                      <Button
                                        type="button"
                                        size="sm"
                                        variant="outline"
                                        onClick={selectAllPhotos}
                                      >
                                        Selecionar Todas
                                      </Button>
                                    )}
                                    {selectedPhotos.length > 0 && (
                                      <Button
                                        type="button"
                                        size="sm"
                                        onClick={() => setShowTagsModal(true)}
                                      >
                                        Adicionar Tags ({selectedPhotos.length})
                                      </Button>
                                    )}
                                  </>
                                )}
                                <input
                                  type="file"
                                  multiple
                                  accept="image/*"
                                  id={`photo-upload-${room.id}`}
                                  className="hidden"
                                  onChange={(e) => handlePhotoUpload(e)}
                                />
                                <Button
                                  type="button"
                                  size="sm"
                                  variant="outline"
                                  onClick={() => {
                                    console.log('üîò [BUTTON] Bot√£o clicado - Setando roomIndex:', index, 'para room:', room.id, room.typeName);
                                    setSelectedRoomIndex(index);
                                    document.getElementById(`photo-upload-${room.id}`)?.click();
                                  }}
                                  disabled={uploadingPhotos}
                                  className={uploadingPhotos ? 'opacity-50 cursor-not-allowed' : ''}
                                >
                                  <Plus className="w-4 h-4 mr-2" />
                                  {uploadingPhotos ? '‚è≥ Enviando...' : 'Adicionar Fotos'}
                                </Button>
                              </div>
                            </div>

                            {room.photos.length > 0 ? (
                              <div className="grid grid-cols-4 gap-2">
                                {room.photos.map(photo => (
                                  <div key={photo.id} className="relative group">
                                    {/* Checkbox de Sele√ß√£o */}
                                    {selectedRoomIndex === index && (
                                      <Checkbox
                                        checked={selectedPhotos.includes(photo.id)}
                                        onCheckedChange={() => togglePhotoSelection(photo.id)}
                                        className="absolute top-1 left-1 z-10 opacity-0 group-hover:opacity-100 bg-white dark:bg-gray-800 border-2"
                                      />
                                    )}
                                    <img
                                      src={photo.url}
                                      alt=""
                                      className={`w-full h-24 object-cover rounded border ${
                                        selectedPhotos.includes(photo.id) && selectedRoomIndex === index
                                          ? 'border-blue-500 border-2'
                                          : 'border-gray-200 dark:border-gray-700'
                                      }`}
                                      onClick={() => selectedRoomIndex === index && togglePhotoSelection(photo.id)}
                                      style={{ cursor: selectedRoomIndex === index ? 'pointer' : 'default' }}
                                    />
                                    <Button
                                      type="button"
                                      size="icon"
                                      variant="destructive"
                                      className="absolute top-1 right-1 h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity"
                                      onClick={() => deletePhoto(photo.id)}
                                    >
                                      <Trash2 className="w-3 h-3" />
                                    </Button>
                                    {photo.tags.length > 0 && (
                                      <div className="absolute bottom-1 left-1 flex gap-1">
                                        {photo.tags.slice(0, 2).map((tag, i) => (
                                          <Badge key={i} variant="secondary" className="text-[10px] h-4 px-1 flex items-center gap-0.5">
                                            <span className="truncate max-w-[60px]">{tag}</span>
                                            <button
                                              onClick={(e) => {
                                                e.stopPropagation();
                                                removePhotoTag(photo.id, tag);
                                              }}
                                              className="hover:bg-gray-300 dark:hover:bg-gray-600 rounded-full ml-0.5"
                                            >
                                              <X className="h-2 w-2" />
                                            </button>
                                          </Badge>
                                        ))}
                                        {photo.tags.length > 2 && (
                                          <Badge className="text-[10px] h-4 px-1">+{photo.tags.length - 2}</Badge>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div className="text-center py-6 text-gray-400 dark:text-gray-600 text-sm">
                                Nenhuma foto adicionada
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Bot√£o Salvar C√¥modos */}
                  {rooms.length > 0 && (
                    <div className="flex justify-end">
                      <Button
                        type="button"
                        onClick={saveRoomsData}
                        className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                      >
                        <Save className="w-4 h-4 mr-2" /> Salvar C√¥modos
                      </Button>
                    </div>
                  )}

                  {/* TESTE: Debug do array rooms */}
                  {rooms.length > 0 && (
                    <div className="bg-gray-50 dark:bg-gray-900 p-4 rounded text-xs">
                      <p className="font-mono text-gray-600 dark:text-gray-400">
                        <strong>Debug:</strong> {JSON.stringify(rooms, null, 2).substring(0, 500)}...
                      </p>
                    </div>
                  )}
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button
                    variant="outline"
                    onClick={() => setCurrentStep(2)}
                  >
                    Anterior
                  </Button>
                  
                  <div className="flex items-center gap-3">
                    <Button
                      type="button"
                      onClick={saveRooms}
                      className="bg-green-600 hover:bg-green-700 text-white"
                    >
                      <Save className="w-4 h-4 mr-2" />
                      SALVAR C√îMODOS
                    </Button>
                    <Button
                      onClick={() => setCurrentStep(4)}
                    >
                      Pr√≥ximo
                    </Button>
                  </div>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 04 - TOUR VISUAL (GALERIA E FOTO DE CAPA) */}
            {/* ================================================================ */}
            {currentStep === 4 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Tour Virtual - Galeria de Fotos</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Visualize todas as fotos e escolha a foto de capa que aparecer√° em destaque
                    </p>
                  </div>

                  {/* Estat√≠sticas */}
                  <div className="grid grid-cols-3 gap-4">
                    <Card>
                      <CardContent className="pt-6">
                        <div className="text-center">
                          <p className="text-3xl font-bold">
                            {rooms.reduce((total, room) => total + room.photos.length, 0)}
                          </p>
                          <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            Fotos Totais
                          </p>
                        </div>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="pt-6">
                        <div className="text-center">
                          <p className="text-3xl font-bold">{rooms.length}</p>
                          <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            C√¥modos
                          </p>
                        </div>
                      </CardContent>
                    </Card>
                    <Card>
                      <CardContent className="pt-6">
                        <div className="text-center">
                          <p className="text-3xl font-bold">{coverPhotoId ? '1' : '0'}</p>
                          <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            Foto de Capa
                          </p>
                        </div>
                      </CardContent>
                    </Card>
                  </div>

                  {/* Preview da Foto de Capa */}
                  {(() => {
                    const coverPhoto = rooms
                      .flatMap((room) =>
                        room.photos.map((photo) => ({
                          ...photo,
                          roomName: room.typeName || room.customName || 'Sem nome',
                        }))
                      )
                      .find((photo) => photo.id === coverPhotoId);

                    return coverPhoto ? (
                      <Card className="border-2 border-yellow-500 shadow-lg">
                        <CardContent className="p-6">
                          <div className="flex items-start gap-6">
                            <div className="flex-shrink-0">
                              <Badge className="bg-yellow-500 text-black font-bold mb-3">
                                <Star className="h-4 w-4 mr-2 fill-current" />
                                FOTO DE CAPA
                              </Badge>
                              <div className="relative w-80 h-60 rounded-lg overflow-hidden shadow-xl">
                                <img
                                  src={coverPhoto.url}
                                  alt="Foto de Capa"
                                  className="w-full h-full object-cover"
                                />
                              </div>
                            </div>
                            <div className="flex-1 space-y-3">
                              <div>
                                <h3 className="text-lg font-semibold mb-1">Foto em Destaque</h3>
                                <p className="text-sm text-gray-600 dark:text-gray-400">
                                  Esta √© a foto que aparecer√° como capa do seu an√∫ncio nas listagens e buscas
                                </p>
                              </div>
                              <div className="flex items-center gap-2">
                                <Badge variant="secondary">
                                  {coverPhoto.roomName}
                                </Badge>
                                {coverPhoto.tags && coverPhoto.tags.length > 0 && (
                                  <>
                                    {coverPhoto.tags.slice(0, 3).map((tag, i) => (
                                      <Badge key={i} variant="outline">
                                        {tag}
                                      </Badge>
                                    ))}
                                    {coverPhoto.tags.length > 3 && (
                                      <Badge variant="outline">
                                        +{coverPhoto.tags.length - 3} mais
                                      </Badge>
                                    )}
                                  </>
                                )}
                              </div>
                              <div className="flex gap-2 pt-2">
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={() => setSelectedPhotoPreview(coverPhoto)}
                                >
                                  <Eye className="h-4 w-4 mr-2" />
                                  Visualizar em Tela Cheia
                                </Button>
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={() => {
                                    setCoverPhotoId(null);
                                    setHasUnsavedChanges(true);
                                    toast.info('Foto de capa removida. Selecione outra abaixo.');
                                  }}
                                >
                                  <X className="h-4 w-4 mr-2" />
                                  Remover Capa
                                </Button>
                              </div>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    ) : rooms.some((r) => r.photos.length > 0) ? (
                      <Card className="border-2 border-dashed border-yellow-400 bg-yellow-50 dark:bg-yellow-950/20">
                        <CardContent className="py-8 text-center">
                          <Star className="h-12 w-12 mx-auto mb-3 text-yellow-500" />
                          <h3 className="text-lg font-semibold mb-2">Nenhuma foto de capa selecionada</h3>
                          <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Clique no √≠cone de estrela em qualquer foto abaixo para defini-la como capa
                          </p>
                          <Badge variant="outline" className="text-xs">
                            A primeira foto ser√° usada automaticamente se nenhuma for selecionada
                          </Badge>
                        </CardContent>
                      </Card>
                    ) : null;
                  })()}

                  {/* Filtro por C√¥modo */}
                  {rooms.length > 0 && (
                    <div className="flex items-center gap-3 flex-wrap">
                      <span className="text-sm font-medium">Filtrar por c√¥modo:</span>
                      <Button
                        size="sm"
                        variant={filterRoom === 'all' ? 'default' : 'outline'}
                        onClick={() => setFilterRoom('all')}
                      >
                        Todas ({rooms.reduce((total, r) => total + r.photos.length, 0)})
                      </Button>
                      {rooms.map((room) => (
                        <Button
                          key={room.id}
                          size="sm"
                          variant={filterRoom === room.id ? 'default' : 'outline'}
                          onClick={() => setFilterRoom(room.id)}
                        >
                          {room.typeName || 'Sem nome'} ({room.photos.length})
                        </Button>
                      ))}
                    </div>
                  )}

                  {/* Galeria de Fotos */}
                  {rooms.length === 0 || rooms.every((r) => r.photos.length === 0) ? (
                    <Card className="border-2 border-dashed">
                      <CardContent className="flex flex-col items-center justify-center py-12">
                        <ImageIcon className="h-12 w-12 text-gray-400 mb-4" />
                        <p className="text-gray-600 dark:text-gray-400 mb-2">
                          Nenhuma foto adicionada ainda
                        </p>
                        <p className="text-sm text-gray-500 dark:text-gray-500">
                          Volte ao Step 03 para adicionar fotos aos c√¥modos
                        </p>
                      </CardContent>
                    </Card>
                  ) : (
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                      {rooms
                        .filter((room) => filterRoom === 'all' || filterRoom === room.id)
                        .flatMap((room) =>
                          room.photos.map((photo) => ({
                            ...photo,
                            roomName: room.typeName || room.customName || 'Sem nome',
                            roomId: room.id,
                          }))
                        )
                        .map((photo) => (
                          <div
                            key={photo.id}
                            className={`relative group rounded-lg overflow-hidden border-2 transition-all cursor-pointer ${
                              coverPhotoId === photo.id
                                ? 'border-yellow-500 shadow-lg'
                                : 'border-gray-200 dark:border-gray-700'
                            }`}
                          >
                            {/* Badge de Foto de Capa */}
                            {coverPhotoId === photo.id && (
                              <div className="absolute top-2 right-2 z-10">
                                <Badge className="bg-yellow-500 text-black font-bold">
                                  <Star className="h-3 w-3 mr-1 fill-current" />
                                  CAPA
                                </Badge>
                              </div>
                            )}

                            {/* Badge do C√¥modo */}
                            <div className="absolute top-2 left-2 z-10">
                              <Badge variant="secondary" className="text-xs">
                                {photo.roomName}
                              </Badge>
                            </div>

                            {/* Imagem */}
                            <div
                              className="aspect-square relative"
                              onClick={() => setSelectedPhotoPreview(photo)}
                            >
                              <img
                                src={photo.url}
                                alt={photo.roomName}
                                className="w-full h-full object-cover"
                              />

                              {/* Overlay de A√ß√µes (hover) */}
                              <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                <Button
                                  size="sm"
                                  variant="secondary"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setSelectedPhotoPreview(photo);
                                  }}
                                >
                                  <Eye className="h-4 w-4" />
                                </Button>
                                <Button
                                  size="sm"
                                  variant={coverPhotoId === photo.id ? 'default' : 'secondary'}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setCoverPhotoId(photo.id);
                                    setHasUnsavedChanges(true);
                                    toast.success('Foto de capa selecionada!');
                                  }}
                                >
                                  <Star className="h-4 w-4" />
                                </Button>
                              </div>
                            </div>

                            {/* Tags */}
                            {photo.tags && photo.tags.length > 0 && (
                              <div className="absolute bottom-2 left-2 flex gap-1">
                                {photo.tags.slice(0, 2).map((tag, i) => (
                                  <Badge key={i} variant="outline" className="text-[10px] bg-white/90 dark:bg-gray-800/90">
                                    {tag.length > 10 ? tag.substring(0, 10) + '...' : tag}
                                  </Badge>
                                ))}
                                {photo.tags.length > 2 && (
                                  <Badge variant="outline" className="text-[10px] bg-white/90 dark:bg-gray-800/90">
                                    +{photo.tags.length - 2}
                                  </Badge>
                                )}
                              </div>
                            )}
                          </div>
                        ))}
                    </div>
                  )}

                  {/* Bot√£o Salvar */}
                  {rooms.some((r) => r.photos.length > 0) && (
                    <div className="flex justify-end">
                      <Button
                        type="button"
                        onClick={saveTourVisual}
                        className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                      >
                        <Save className="w-4 h-4 mr-2" /> Salvar Foto de Capa
                      </Button>
                    </div>
                  )}
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(3)}>
                    Anterior
                  </Button>

                  <Button onClick={() => setCurrentStep(5)}>Pr√≥ximo</Button>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 05 - AMENIDADES DO LOCAL */}
            {/* ================================================================ */}
            {currentStep === 5 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Comodidades do Local</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Selecione as amenidades dispon√≠veis no local (pr√©dio, condom√≠nio, hotel)
                    </p>
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* COLUNA ESQUERDA - Amenidades Tick√°veis (2/3) */}
                    <div className="lg:col-span-2 space-y-4">
                      {/* Busca */}
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          placeholder="Filtro para pesquisar na lista de cada aba"
                          value={searchAmenities}
                          onChange={(e) => setSearchAmenities(e.target.value)}
                          className="pl-10"
                        />
                      </div>

                      {/* Categorias de Amenidades */}
                      {LOCATION_AMENITIES.map((category) => {
                        const filteredAmenities = category.amenities.filter((amenity) =>
                          amenity.name.toLowerCase().includes(searchAmenities.toLowerCase())
                        );

                        if (filteredAmenities.length === 0) return null;

                        const isCollapsed = collapsedCategories[category.id] || false;

                        return (
                          <Card key={category.id}>
                            <CardContent className="pt-6">
                              <div
                                className="flex items-center justify-between mb-4 cursor-pointer"
                                onClick={() => {
                                  setCollapsedCategories({
                                    ...collapsedCategories,
                                    [category.id]: !isCollapsed
                                  });
                                }}
                              >
                                <h3 className="font-semibold flex items-center gap-2">
                                  <ChevronDown
                                    className={`h-5 w-5 transition-transform duration-200 ${
                                      isCollapsed ? '-rotate-90' : ''
                                    }`}
                                  />
                                  <span className="text-2xl">{category.icon}</span>
                                  {category.name}
                                </h3>
                                <Badge variant="outline">
                                  {locationAmenities.filter((id) =>
                                    category.amenities.some((a) => a.id === id)
                                  ).length} / {filteredAmenities.length}
                                </Badge>
                              </div>

                              {!isCollapsed && (
                                <div className="grid grid-cols-2 gap-3">
                                  {filteredAmenities.map((amenity) => (
                                    <div
                                      key={amenity.id}
                                      className="flex items-center space-x-2"
                                    >
                                      <Checkbox
                                        id={`amenity-${amenity.id}`}
                                        checked={locationAmenities.includes(amenity.id)}
                                        onCheckedChange={(checked) => {
                                          if (checked) {
                                            setLocationAmenities([...locationAmenities, amenity.id]);
                                          } else {
                                            setLocationAmenities(
                                              locationAmenities.filter((id) => id !== amenity.id)
                                            );
                                          }
                                          setHasUnsavedChanges(true);
                                        }}
                                      />
                                      <Label
                                        htmlFor={`amenity-${amenity.id}`}
                                        className="text-sm cursor-pointer"
                                      >
                                        {amenity.name}
                                      </Label>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </CardContent>
                          </Card>
                        );
                      })}
                    </div>

                    {/* COLUNA DIREITA - Amenidades Especiais (1/3) */}
                    <div className="space-y-4">
                      {/* Check-in/Check-out */}
                      <Card>
                        <CardContent className="pt-6">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <Clock className="h-5 w-5 text-blue-600" />
                              <h3 className="font-semibold">Check-in/Check-out</h3>
                            </div>
                            <Button
                              size="sm"
                              variant="link"
                              className="text-blue-600"
                            >
                              Salvar
                            </Button>
                          </div>
                          <p className="text-xs text-gray-500 mb-3">
                            Hor√°rios flex√≠veis de entrada/sa√≠da
                          </p>
                          <div className="flex gap-2">
                            <Button
                              size="sm"
                              variant={checkInCheckout.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setCheckInCheckout({ ...checkInCheckout, enabled: true });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              Sim
                            </Button>
                            <Button
                              size="sm"
                              variant={!checkInCheckout.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setCheckInCheckout({ enabled: false, details: '' });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              N√£o
                            </Button>
                          </div>
                        </CardContent>
                      </Card>

                      {/* Estacionamento */}
                      <Card>
                        <CardContent className="pt-6">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <Car className="h-5 w-5 text-blue-600" />
                              <h3 className="font-semibold">Estacionamento</h3>
                            </div>
                            <Button
                              size="sm"
                              variant="link"
                              className="text-blue-600"
                            >
                              Salvar
                            </Button>
                          </div>
                          <p className="text-xs text-gray-500 mb-3">
                            No local, pr√≥ximo ou reserva antecipada
                          </p>
                          <div className="flex gap-2">
                            <Button
                              size="sm"
                              variant={parking.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setParking({ ...parking, enabled: true });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              Sim
                            </Button>
                            <Button
                              size="sm"
                              variant={!parking.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setParking({ enabled: false, type: '', details: '' });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              N√£o
                            </Button>
                          </div>
                        </CardContent>
                      </Card>

                      {/* Internet em Cabo */}
                      <Card>
                        <CardContent className="pt-6">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <Cable className="h-5 w-5 text-blue-600" />
                              <h3 className="font-semibold">Internet em Cabo</h3>
                            </div>
                            <Button
                              size="sm"
                              variant="link"
                              className="text-blue-600"
                            >
                              Salvar
                            </Button>
                          </div>
                          <p className="text-xs text-gray-500 mb-3">
                            Conex√£o com fio, informar mais detalhes
                          </p>
                          <div className="flex gap-2">
                            <Button
                              size="sm"
                              variant={cableInternet.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setCableInternet({ enabled: true });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              Sim
                            </Button>
                            <Button
                              size="sm"
                              variant={!cableInternet.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setCableInternet({ enabled: false });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              N√£o
                            </Button>
                          </div>
                        </CardContent>
                      </Card>

                      {/* Internet Wi-Fi */}
                      <Card>
                        <CardContent className="pt-6">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <Wifi className="h-5 w-5 text-blue-600" />
                              <h3 className="font-semibold">Internet Wi-Fi</h3>
                            </div>
                            <Button
                              size="sm"
                              variant="link"
                              className="text-blue-600"
                            >
                              Salvar
                            </Button>
                          </div>
                          <p className="text-xs text-gray-500 mb-3">
                            Conex√£o sem fio, informar mais detalhes
                          </p>
                          <div className="flex gap-2">
                            <Button
                              size="sm"
                              variant={wifiInternet.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setWifiInternet({ enabled: true });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              Sim
                            </Button>
                            <Button
                              size="sm"
                              variant={!wifiInternet.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setWifiInternet({ enabled: false });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              N√£o
                            </Button>
                          </div>
                        </CardContent>
                      </Card>

                      {/* Recep√ß√£o 24 horas */}
                      <Card>
                        <CardContent className="pt-6">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <Clock className="h-5 w-5 text-blue-600" />
                              <h3 className="font-semibold">Recep√ß√£o 24 horas</h3>
                            </div>
                            <Button
                              size="sm"
                              variant="link"
                              className="text-blue-600"
                            >
                              Salvar
                            </Button>
                          </div>
                          <p className="text-xs text-gray-500 mb-3">
                            Atendimento 24h, informar mais detalhes
                          </p>
                          <div className="flex gap-2">
                            <Button
                              size="sm"
                              variant={reception24h.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setReception24h({ ...reception24h, enabled: true });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              Sim
                            </Button>
                            <Button
                              size="sm"
                              variant={!reception24h.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setReception24h({ enabled: false, details: '' });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              N√£o
                            </Button>
                          </div>
                        </CardContent>
                      </Card>
                    </div>
                  </div>

                  {/* Bot√£o Salvar */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={saveLocationAmenities}
                      className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Amenidades
                    </Button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(4)}>
                    Anterior
                  </Button>

                  <Button onClick={() => setCurrentStep(6)}>Pr√≥ximo</Button>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 06 - AMENIDADES DA ACOMODA√á√ÉO */}
            {/* ================================================================ */}
            {currentStep === 6 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Amenidades da Acomoda√ß√£o</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Selecione as amenidades dispon√≠veis dentro da acomoda√ß√£o (quarto, apartamento, casa)
                    </p>
                  </div>

                  {/* Busca */}
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <Input
                      placeholder="Filtro para pesquisar na lista de cada aba"
                      value={searchListingAmenities}
                      onChange={(e) => setSearchListingAmenities(e.target.value)}
                      className="pl-10"
                    />
                  </div>

                  {/* Categorias de Amenidades */}
                  <div className="space-y-4">
                    {LISTING_AMENITIES.map((category) => {
                      const filteredAmenities = category.amenities.filter((amenity) =>
                        amenity.name.toLowerCase().includes(searchListingAmenities.toLowerCase())
                      );

                      if (filteredAmenities.length === 0) return null;

                      const isCollapsed = collapsedListingCategories[category.id] || false;

                      return (
                        <Card key={category.id}>
                          <CardContent className="pt-6">
                            <div
                              className="flex items-center justify-between mb-4 cursor-pointer"
                              onClick={() => {
                                setCollapsedListingCategories({
                                  ...collapsedListingCategories,
                                  [category.id]: !isCollapsed
                                });
                              }}
                            >
                              <h3 className="font-semibold flex items-center gap-2">
                                <ChevronDown
                                  className={`h-5 w-5 transition-transform duration-200 ${
                                    isCollapsed ? '-rotate-90' : ''
                                  }`}
                                />
                                <span className="text-2xl">{category.icon}</span>
                                {category.name}
                              </h3>
                              <Badge variant="outline">
                                {listingAmenities.filter((id) =>
                                  category.amenities.some((a) => a.id === id)
                                ).length} / {filteredAmenities.length}
                              </Badge>
                            </div>

                            {!isCollapsed && (
                              <div className="grid grid-cols-2 gap-3">
                                {filteredAmenities.map((amenity) => (
                                  <div
                                    key={amenity.id}
                                    className="flex items-center space-x-2"
                                  >
                                    <Checkbox
                                      id={`listing-amenity-${amenity.id}`}
                                      checked={listingAmenities.includes(amenity.id)}
                                      onCheckedChange={(checked) => {
                                        if (checked) {
                                          setListingAmenities([...listingAmenities, amenity.id]);
                                        } else {
                                          setListingAmenities(
                                            listingAmenities.filter((id) => id !== amenity.id)
                                          );
                                        }
                                        setHasUnsavedChanges(true);
                                      }}
                                    />
                                    <Label
                                      htmlFor={`listing-amenity-${amenity.id}`}
                                      className="text-sm cursor-pointer"
                                    >
                                      {amenity.name}
                                    </Label>
                                  </div>
                                ))}
                              </div>
                            )}
                          </CardContent>
                        </Card>
                      );
                    })}
                  </div>

                  {/* Bot√£o Salvar */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={saveListingAmenities}
                      className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Amenidades
                    </Button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(5)}>
                    Anterior
                  </Button>

                  <Button onClick={() => setCurrentStep(7)}>Pr√≥ximo</Button>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 06 - AMENIDADES DA ACOMODA√á√ÉO */}
            {/* ================================================================ */}
            {currentStep === 6 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Amenidades da Acomoda√ß√£o</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Selecione as amenidades dispon√≠veis dentro da acomoda√ß√£o (quarto, apartamento, casa)
                    </p>
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* COLUNA ESQUERDA - Amenidades Tick√°veis (2/3) */}
                    <div className="lg:col-span-2 space-y-4">
                      {/* Busca */}
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          placeholder="Filtro para pesquisar na lista de cada aba"
                          value={searchListingAmenities}
                          onChange={(e) => setSearchListingAmenities(e.target.value)}
                          className="pl-10"
                        />
                      </div>

                      {/* Categorias de Amenidades */}
                      {LISTING_AMENITIES.map((category) => {
                        const filteredAmenities = category.amenities.filter((amenity) =>
                          amenity.name.toLowerCase().includes(searchListingAmenities.toLowerCase())
                        );

                        if (filteredAmenities.length === 0) return null;

                        const isCollapsed = collapsedListingCategories[category.id] || false;

                        return (
                          <Card key={category.id}>
                            <CardContent className="pt-6">
                              <div
                                className="flex items-center justify-between mb-4 cursor-pointer"
                                onClick={() => {
                                  setCollapsedListingCategories({
                                    ...collapsedListingCategories,
                                    [category.id]: !isCollapsed
                                  });
                                }}
                              >
                                <h3 className="font-semibold flex items-center gap-2">
                                  <ChevronDown
                                    className={`h-5 w-5 transition-transform duration-200 ${
                                      isCollapsed ? '-rotate-90' : ''
                                    }`}
                                  />
                                  <span className="text-2xl">{category.icon}</span>
                                  {category.name}
                                </h3>
                                <Badge variant="outline">
                                  {listingAmenities.filter((id) =>
                                    category.amenities.some((a) => a.id === id)
                                  ).length} / {filteredAmenities.length}
                                </Badge>
                              </div>

                              {!isCollapsed && (
                                <div className="grid grid-cols-2 gap-3">
                                  {filteredAmenities.map((amenity) => (
                                    <div
                                      key={amenity.id}
                                      className="flex items-center space-x-2"
                                    >
                                      <Checkbox
                                        id={`listing-amenity-${amenity.id}`}
                                        checked={listingAmenities.includes(amenity.id)}
                                        onCheckedChange={(checked) => {
                                          if (checked) {
                                            setListingAmenities([...listingAmenities, amenity.id]);
                                          } else {
                                            setListingAmenities(
                                              listingAmenities.filter((id) => id !== amenity.id)
                                            );
                                          }
                                          setHasUnsavedChanges(true);
                                        }}
                                      />
                                      <Label
                                        htmlFor={`listing-amenity-${amenity.id}`}
                                        className="text-sm cursor-pointer"
                                      >
                                        {amenity.name}
                                      </Label>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </CardContent>
                          </Card>
                        );
                      })}
                    </div>

                    {/* COLUNA DIREITA - Campos Especiais (1/3) */}
                    <div className="space-y-4">
                      {/* √Årea em m¬≤ */}
                      <Card>
                        <CardContent className="pt-6">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <Home className="h-5 w-5 text-blue-600" />
                              <h3 className="font-semibold">√Årea</h3>
                            </div>
                            <Button
                              size="sm"
                              variant="link"
                              className="text-blue-600"
                            >
                              Salvar
                            </Button>
                          </div>
                          <p className="text-xs text-gray-500 mb-3">
                            Qual a metragem da acomoda√ß√£o? Coloque apenas o n√∫mero em metros quadrados
                          </p>
                          <div className="flex gap-2 mb-3">
                            <Button
                              size="sm"
                              variant={areaM2.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setAreaM2({ ...areaM2, enabled: true });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              Sim
                            </Button>
                            <Button
                              size="sm"
                              variant={!areaM2.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setAreaM2({ enabled: false, value: '' });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              N√£o
                            </Button>
                          </div>
                          {areaM2.enabled && (
                            <Input
                              type="number"
                              placeholder="m¬≤"
                              value={areaM2.value}
                              onChange={(e) => {
                                setAreaM2({ ...areaM2, value: e.target.value });
                                setHasUnsavedChanges(true);
                              }}
                            />
                          )}
                        </CardContent>
                      </Card>

                      {/* Garagem Gratuita */}
                      <Card>
                        <CardContent className="pt-6">
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <Car className="h-5 w-5 text-blue-600" />
                              <h3 className="font-semibold">Garagem Gratuita</h3>
                            </div>
                            <Button
                              size="sm"
                              variant="link"
                              className="text-blue-600"
                            >
                              Salvar
                            </Button>
                          </div>
                          <p className="text-xs text-gray-500 mb-3">
                            Esta op√ß√£o n√£o vale para Booking. Para oferecer garagem no canal, marque estacionamento nas suas amenities do local
                          </p>
                          <div className="flex gap-2 mb-3">
                            <Button
                              size="sm"
                              variant={garagemGratuita.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setGaragemGratuita({ ...garagemGratuita, enabled: true });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              Sim
                            </Button>
                            <Button
                              size="sm"
                              variant={!garagemGratuita.enabled ? 'default' : 'outline'}
                              onClick={() => {
                                setGaragemGratuita({ enabled: false, quantity: '' });
                                setHasUnsavedChanges(true);
                              }}
                              className="flex-1"
                            >
                              N√£o
                            </Button>
                          </div>
                          {garagemGratuita.enabled && (
                            <Input
                              type="number"
                              placeholder="Quantidade"
                              value={garagemGratuita.quantity}
                              onChange={(e) => {
                                setGaragemGratuita({ ...garagemGratuita, quantity: e.target.value });
                                setHasUnsavedChanges(true);
                              }}
                            />
                          )}
                        </CardContent>
                      </Card>
                    </div>
                  </div>

                  {/* Bot√£o Salvar */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={saveListingAmenities}
                      className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Amenidades
                    </Button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(5)}>
                    Anterior
                  </Button>

                  <Button onClick={() => setCurrentStep(7)}>Pr√≥ximo</Button>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 07 - DESCRI√á√ÉO */}
            {/* ================================================================ */}
            {currentStep === 7 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Descri√ß√£o</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Descreva sua propriedade em 3 idiomas
                    </p>
                  </div>

                  {/* T√≠tulo do An√∫ncio */}
                  <Card>
                    <CardContent className="pt-6">
                      <div className="flex items-center justify-between mb-4">
                        <div>
                          <h3 className="font-semibold text-lg">T√≠tulo do An√∫ncio</h3>
                          <p className="text-sm text-gray-500">
                            T√≠tulo que aparecer√° nos an√∫ncios. <strong>Airbnb limita a 50 caracteres</strong> - o que passar ser√° cortado.
                          </p>
                        </div>
                        <span className="text-sm text-gray-500">0/50</span>
                      </div>
                      
                      <div className="flex gap-2 mb-3 border-b">
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'pt'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('pt')}
                        >
                          üáßüá∑ PT
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'en'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('en')}
                        >
                          üá∫üá∏ EN
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'es'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('es')}
                        >
                          üá™üá∏ ES
                        </button>
                      </div>

                      <Input
                        placeholder="Ex: Apartamento aconchegante no centro da cidade"
                        value={descricaoTitulo[activeDescTab]}
                        onChange={(e) => {
                          setDescricaoTitulo({ ...descricaoTitulo, [activeDescTab]: e.target.value });
                          setHasUnsavedChanges(true);
                        }}
                        maxLength={50}
                      />
                    </CardContent>
                  </Card>

                  {/* Campos Fixos Obrigat√≥rios */}
                  <Card className="border-blue-200 bg-blue-50/50">
                    <CardContent className="pt-6">
                      <div className="flex items-start gap-3 mb-4">
                        <AlertCircle className="h-5 w-5 text-blue-600 mt-0.5" />
                        <div>
                          <h3 className="font-semibold">Campos Fixos Obrigat√≥rios</h3>
                          <p className="text-sm text-gray-600">6 campos padr√£o para todas as plataformas (sem emojis)</p>
                        </div>
                      </div>
                      
                      <div className="text-sm text-gray-600">
                        <div className="flex items-center justify-between py-2 border-b">
                          <span>0 de 6 campos fixos preenchidos</span>
                          <span>0 de 0 campos personalizados</span>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Notas gerais */}
                  <Card>
                    <CardContent className="pt-6">
                      <div className="mb-4">
                        <Label className="text-base font-semibold">Notas gerais *</Label>
                      </div>
                      
                      <div className="flex gap-2 mb-3 border-b">
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'pt'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('pt')}
                        >
                          üáßüá∑ PT
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'en'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('en')}
                        >
                          üá∫üá∏ EN
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'es'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('es')}
                        >
                          üá™üá∏ ES
                        </button>
                      </div>

                      <Textarea
                        placeholder="Informe detalhes adicionais que seus h√≥spedes devem saber sobre o seu espa√ßo"
                        value={notasGerais[activeDescTab]}
                        onChange={(e) => {
                          setNotasGerais({ ...notasGerais, [activeDescTab]: e.target.value });
                          setHasUnsavedChanges(true);
                        }}
                        className="min-h-[100px] resize-none"
                        maxLength={5000}
                      />
                      <div className="flex items-center justify-between mt-2">
                        <span className="text-xs text-red-500">‚ùå Emojis n√£o permitidos</span>
                        <span className="text-xs text-gray-500">0/5000</span>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Sobre o espa√ßo */}
                  <Card>
                    <CardContent className="pt-6">
                      <div className="mb-4">
                        <Label className="text-base font-semibold">Sobre o espa√ßo *</Label>
                      </div>
                      
                      <div className="flex gap-2 mb-3 border-b">
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'pt'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('pt')}
                        >
                          üáßüá∑ PT
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'en'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('en')}
                        >
                          üá∫üá∏ EN
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'es'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('es')}
                        >
                          üá™üá∏ ES
                        </button>
                      </div>

                      <Textarea
                        placeholder="O que torna seu espa√ßo especial?\nO que contribuir√° para que seus h√≥spedes se sintam confort√°veis em sua acomoda√ß√£o?"
                        value={sobreEspaco[activeDescTab]}
                        onChange={(e) => {
                          setSobreEspaco({ ...sobreEspaco, [activeDescTab]: e.target.value });
                          setHasUnsavedChanges(true);
                        }}
                        className="min-h-[100px] resize-none"
                        maxLength={5000}
                      />
                      <div className="flex items-center justify-between mt-2">
                        <span className="text-xs text-red-500">‚ùå Emojis n√£o permitidos</span>
                        <span className="text-xs text-gray-500">0/5000</span>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Sobre o acesso ao espa√ßo */}
                  <Card>
                    <CardContent className="pt-6">
                      <div className="mb-4">
                        <Label className="text-base font-semibold">Sobre o acesso ao espa√ßo *</Label>
                      </div>
                      
                      <div className="flex gap-2 mb-3 border-b">
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'pt'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('pt')}
                        >
                          üáßüá∑ PT
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'en'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('en')}
                        >
                          üá∫üá∏ EN
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'es'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('es')}
                        >
                          üá™üá∏ ES
                        </button>
                      </div>

                      <Textarea
                        placeholder="Seus h√≥spedes ter√£o acesso liberado a todas as depend√™ncias da acomoda√ß√£o?\nSe for o caso, coloque tamb√©m informa√ß√µes referentes √† restri√ß√£o do condom√≠nio."
                        value={sobreAcesso[activeDescTab]}
                        onChange={(e) => {
                          setSobreAcesso({ ...sobreAcesso, [activeDescTab]: e.target.value });
                          setHasUnsavedChanges(true);
                        }}
                        className="min-h-[100px] resize-none"
                        maxLength={5000}
                      />
                      <div className="flex items-center justify-between mt-2">
                        <span className="text-xs text-red-500">‚ùå Emojis n√£o permitidos</span>
                        <span className="text-xs text-gray-500">0/5000</span>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Sobre intera√ß√£o com anfitri√£o */}
                  <Card>
                    <CardContent className="pt-6">
                      <div className="mb-4">
                        <Label className="text-base font-semibold">Sobre intera√ß√£o com anfitri√£o *</Label>
                      </div>
                      
                      <div className="flex gap-2 mb-3 border-b">
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'pt'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('pt')}
                        >
                          üáßüá∑ PT
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'en'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('en')}
                        >
                          üá∫üá∏ EN
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'es'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('es')}
                        >
                          üá™üá∏ ES
                        </button>
                      </div>

                      <Textarea
                        placeholder="Como ser√° a intera√ß√£o com o anfitri√£o durante a estada?\nHaver√° contato em algum momento?"
                        value={sobreAnfitriao[activeDescTab]}
                        onChange={(e) => {
                          setSobreAnfitriao({ ...sobreAnfitriao, [activeDescTab]: e.target.value });
                          setHasUnsavedChanges(true);
                        }}
                        className="min-h-[100px] resize-none"
                        maxLength={5000}
                      />
                      <div className="flex items-center justify-between mt-2">
                        <span className="text-xs text-red-500">‚ùå Emojis n√£o permitidos</span>
                        <span className="text-xs text-gray-500">0/5000</span>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Descri√ß√£o do bairro */}
                  <Card>
                    <CardContent className="pt-6">
                      <div className="mb-4">
                        <Label className="text-base font-semibold">Descri√ß√£o do bairro *</Label>
                      </div>
                      
                      <div className="flex gap-2 mb-3 border-b">
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'pt'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('pt')}
                        >
                          üáßüá∑ PT
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'en'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('en')}
                        >
                          üá∫üá∏ EN
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'es'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('es')}
                        >
                          üá™üá∏ ES
                        </button>
                      </div>

                      <Textarea
                        placeholder="Como √© o bairro ou os arredores do seu an√∫ncio?\nColoque sugest√µes sobre o que os h√≥spedes podem fazer por arredores do local."
                        value={descricaoBairro[activeDescTab]}
                        onChange={(e) => {
                          setDescricaoBairro({ ...descricaoBairro, [activeDescTab]: e.target.value });
                          setHasUnsavedChanges(true);
                        }}
                        className="min-h-[100px] resize-none"
                        maxLength={5000}
                      />
                      <div className="flex items-center justify-between mt-2">
                        <span className="text-xs text-red-500">‚ùå Emojis n√£o permitidos</span>
                        <span className="text-xs text-gray-500">0/5000</span>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Informa√ß√µes sobre locomo√ß√£o */}
                  <Card>
                    <CardContent className="pt-6">
                      <div className="mb-4">
                        <Label className="text-base font-semibold">Informa√ß√µes sobre locomo√ß√£o *</Label>
                      </div>
                      
                      <div className="flex gap-2 mb-3 border-b">
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'pt'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('pt')}
                        >
                          üáßüá∑ PT
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'en'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('en')}
                        >
                          üá∫üá∏ EN
                        </button>
                        <button
                          className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                            activeDescTab === 'es'
                              ? 'border-blue-600 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                          onClick={() => setActiveDescTab('es')}
                        >
                          üá™üá∏ ES
                        </button>
                      </div>

                      <Textarea
                        placeholder="Como chegar na propriedade?\nH√° op√ß√µes de transporte p√∫blico? Estacionamento inclu√≠do no local ou nos arredores?\nQual a dist√¢ncia do seu an√∫ncio em rela√ß√£o ao aeroporto ou as principais rodovias mais pr√≥ximas?"
                        value={infoLocomocao[activeDescTab]}
                        onChange={(e) => {
                          setInfoLocomocao({ ...infoLocomocao, [activeDescTab]: e.target.value });
                          setHasUnsavedChanges(true);
                        }}
                        className="min-h-[120px] resize-none"
                        maxLength={5000}
                      />
                      <div className="flex items-center justify-between mt-2">
                        <span className="text-xs text-red-500">‚ùå Emojis n√£o permitidos</span>
                        <span className="text-xs text-gray-500">0/5000</span>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Resumo do Conte√∫do */}
                  <Card className="border-blue-200 bg-blue-50/50">
                    <CardContent className="pt-6">
                      <div className="flex items-start gap-3">
                        <AlertCircle className="h-5 w-5 text-blue-600 mt-0.5" />
                        <div className="space-y-2">
                          <h3 className="font-semibold">Resumo do Conte√∫do</h3>
                          <div className="space-y-1 text-sm">
                            <div className="flex items-center gap-2">
                              <CheckCircle2 className="h-4 w-4 text-green-600" />
                              <span>0 de 6 campos fixos preenchidos</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <CheckCircle2 className="h-4 w-4 text-green-600" />
                              <span>0 de 0 campos personalizados preenchidos</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <CheckCircle2 className="h-4 w-4 text-green-600" />
                              <span>Conte√∫do dispon√≠vel em 3 idiomas (PT, EN, ES)</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Bot√£o Salvar */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={saveDescricao}
                      className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Descri√ß√£o
                    </Button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(6)}>
                    Anterior
                  </Button>

                  <Button onClick={() => {
                    toast.success('üéâ Wizard conclu√≠do! Redirecionando...');
                    setTimeout(() => navigate('/dashboard/anuncios'), 1500);
                  }}>
                    Finalizar
                  </Button>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 08 - CONFIGURA√á√ÉO DE RELACIONAMENTO */}
            {/* ================================================================ */}
            {currentStep === 8 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Configura√ß√£o de Relacionamento</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Configurar titular, remunera√ß√µes e comunica√ß√£o
                    </p>
                  </div>

                  {/* Responsabilidade Legal */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Responsabilidade Legal</h3>
                      <p className="text-sm text-gray-600 mb-4">
                        Defina o titular do im√≥vel e o respons√°vel operacional pela gest√£o das reservas.
                      </p>
                      
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <Label>Titular do Im√≥vel *</Label>
                          <Select value={titularImovel} onValueChange={(value) => { setTitularImovel(value); setHasUnsavedChanges(true); }}>
                            <SelectTrigger>
                              <SelectValue placeholder="Selecione o titular" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="nao_definido">N√£o definido</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>
                        
                        <div>
                          <Label>Administrador do Im√≥vel</Label>
                          <Select value={administradorImovel} onValueChange={(value) => { setAdministradorImovel(value); setHasUnsavedChanges(true); }}>
                            <SelectTrigger>
                              <SelectValue placeholder="N√£o definido" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="nao_definido">N√£o definido</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Modalidade Contratual */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Modalidade Contratual</h3>
                      
                      <div className="space-y-4">
                        <div>
                          <Label>Data de Cadastro no Sistema</Label>
                          <Popover>
                            <PopoverTrigger asChild>
                              <Button variant="outline" className="w-full justify-start text-left">
                                <CalendarIcon className="mr-2 h-4 w-4" />
                                {dataCadastro ? format(dataCadastro, 'dd/MM/yyyy', { locale: ptBR }) : 'Selecione uma data'}
                              </Button>
                            </PopoverTrigger>
                            <PopoverContent className="w-auto p-0">
                              <Calendar
                                mode="single"
                                selected={dataCadastro}
                                onSelect={(date) => { setDataCadastro(date); setHasUnsavedChanges(true); }}
                                initialFocus
                              />
                            </PopoverContent>
                          </Popover>
                        </div>

                        <div>
                          <Label>Repasse de Propriedade (Subloca√ß√£o)</Label>
                          <p className="text-xs text-gray-500 mb-2">Este im√≥vel √© gerenciado atrav√©s de subloca√ß√£o ou repasse?</p>
                          <div className="flex gap-2">
                            <Button
                              type="button"
                              variant={isSublocacao ? "default" : "outline"}
                              onClick={() => { setIsSublocacao(true); setHasUnsavedChanges(true); }}
                              className="flex-1"
                            >
                              Sim
                            </Button>
                            <Button
                              type="button"
                              variant={!isSublocacao ? "default" : "outline"}
                              onClick={() => { setIsSublocacao(false); setHasUnsavedChanges(true); }}
                              className="flex-1"
                            >
                              N√£o
                            </Button>
                          </div>
                        </div>

                        <div>
                          <Label>Exclusividade</Label>
                          <div className="flex gap-2">
                            <Button
                              type="button"
                              variant={isExclusivo ? "default" : "outline"}
                              onClick={() => { setIsExclusivo(true); setHasUnsavedChanges(true); }}
                              className="flex-1"
                            >
                              Sim
                            </Button>
                            <Button
                              type="button"
                              variant={!isExclusivo ? "default" : "outline"}
                              onClick={() => { setIsExclusivo(false); setHasUnsavedChanges(true); }}
                              className="flex-1"
                            >
                              N√£o
                            </Button>
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Vig√™ncia do Contrato */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Vig√™ncia do Contrato</h3>
                      
                      <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                          <Label>Data de In√≠cio</Label>
                          <Popover>
                            <PopoverTrigger asChild>
                              <Button variant="outline" className="w-full justify-start">
                                <CalendarIcon className="mr-2 h-4 w-4" />
                                {dataInicioContrato ? format(dataInicioContrato, 'dd/MM/yyyy', { locale: ptBR }) : 'Selecione'}
                              </Button>
                            </PopoverTrigger>
                            <PopoverContent className="w-auto p-0">
                              <Calendar
                                mode="single"
                                selected={dataInicioContrato}
                                onSelect={(date) => { setDataInicioContrato(date); setHasUnsavedChanges(true); }}
                                initialFocus
                              />
                            </PopoverContent>
                          </Popover>
                        </div>

                        <div>
                          <Label>Data de Fim</Label>
                          <Popover>
                            <PopoverTrigger asChild>
                              <Button variant="outline" className="w-full justify-start">
                                <CalendarIcon className="mr-2 h-4 w-4" />
                                {dataFimContrato ? format(dataFimContrato, 'dd/MM/yyyy', { locale: ptBR }) : 'Selecione'}
                              </Button>
                            </PopoverTrigger>
                            <PopoverContent className="w-auto p-0">
                              <Calendar
                                mode="single"
                                selected={dataFimContrato}
                                onSelect={(date) => { setDataFimContrato(date); setHasUnsavedChanges(true); }}
                                initialFocus
                              />
                            </PopoverContent>
                          </Popover>
                        </div>
                      </div>

                      <div className="flex items-center space-x-2">
                        <Checkbox
                          id="bloquear-calendario"
                          checked={bloquearCalendarioAposFim}
                          onCheckedChange={(checked) => {
                            setBloquearCalendarioAposFim(checked as boolean);
                            setHasUnsavedChanges(true);
                          }}
                        />
                        <Label htmlFor="bloquear-calendario" className="text-sm cursor-pointer">
                          Bloquear calend√°rio ap√≥s t√©rmino do contrato
                        </Label>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Remunera√ß√£o da Gest√£o */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Remunera√ß√£o da Gest√£o</h3>
                      
                      <div className="space-y-4">
                        <div>
                          <Label>Modelo de Comiss√£o</Label>
                          <div className="flex gap-2">
                            <Button
                              type="button"
                              variant={modeloComissao === 'global' ? "default" : "outline"}
                              onClick={() => { setModeloComissao('global'); setHasUnsavedChanges(true); }}
                              className="flex-1"
                            >
                              Global
                            </Button>
                            <Button
                              type="button"
                              variant={modeloComissao === 'individual' ? "default" : "outline"}
                              onClick={() => { setModeloComissao('individual'); setHasUnsavedChanges(true); }}
                              className="flex-1"
                            >
                              Individual
                            </Button>
                          </div>
                        </div>

                        <div>
                          <Label>Tipo de Comiss√£o</Label>
                          <Select value={tipoComissao} onValueChange={(value: any) => { setTipoComissao(value); setHasUnsavedChanges(true); }}>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="percentage">Porcentagem</SelectItem>
                              <SelectItem value="fixed_monthly">Valor Fixo Mensal</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        <div>
                          <Label>Percentual de Comiss√£o (%)</Label>
                          <Input
                            type="number"
                            value={percentualComissao}
                            onChange={(e) => { setPercentualComissao(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0"
                          />
                        </div>

                        <div>
                          <Label>Base de C√°lculo</Label>
                          <Select value={baseCalculoComissao} onValueChange={(value: any) => { setBaseCalculoComissao(value); setHasUnsavedChanges(true); }}>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="gross_daily">Di√°ria Bruta</SelectItem>
                              <SelectItem value="total_daily">Di√°ria Total</SelectItem>
                              <SelectItem value="accommodation_source">Origem Acomoda√ß√£o</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        <div className="space-y-2">
                          <div className="flex items-center space-x-2">
                            <Checkbox
                              id="considerar-taxas"
                              checked={considerarTaxasCanais}
                              onCheckedChange={(checked) => {
                                setConsiderarTaxasCanais(checked as boolean);
                                setHasUnsavedChanges(true);
                              }}
                            />
                            <Label htmlFor="considerar-taxas" className="text-sm cursor-pointer">
                              Considerar taxas dos canais
                            </Label>
                          </div>

                          <div className="flex items-center space-x-2">
                            <Checkbox
                              id="deduzir-taxas"
                              checked={deduzirTaxasCanais}
                              onCheckedChange={(checked) => {
                                setDeduzirTaxasCanais(checked as boolean);
                                setHasUnsavedChanges(true);
                              }}
                            />
                            <Label htmlFor="deduzir-taxas" className="text-sm cursor-pointer">
                              Deduzir taxas dos canais
                            </Label>
                          </div>

                          <div className="flex items-center space-x-2">
                            <Checkbox
                              id="transferencia-exclusiva"
                              checked={permitirTransferenciaExclusiva}
                              onCheckedChange={(checked) => {
                                setPermitirTransferenciaExclusiva(checked as boolean);
                                setHasUnsavedChanges(true);
                              }}
                            />
                            <Label htmlFor="transferencia-exclusiva" className="text-sm cursor-pointer">
                              Permitir transfer√™ncia exclusiva
                            </Label>
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Encargos Adicionais */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Encargos Adicionais</h3>
                      
                      <div>
                        <Label>Modo de Cobran√ßa de Energia</Label>
                        <div className="flex gap-2">
                          <Button
                            type="button"
                            variant={modoCobrancaEnergia === 'global' ? "default" : "outline"}
                            onClick={() => { setModoCobrancaEnergia('global'); setHasUnsavedChanges(true); }}
                            className="flex-1"
                          >
                            Global
                          </Button>
                          <Button
                            type="button"
                            variant={modoCobrancaEnergia === 'individual' ? "default" : "outline"}
                            onClick={() => { setModoCobrancaEnergia('individual'); setHasUnsavedChanges(true); }}
                            className="flex-1"
                          >
                            Individual
                          </Button>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Bot√£o Salvar */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={saveRelacionamento}
                      className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Configura√ß√£o
                    </Button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(7)}>
                    Anterior
                  </Button>

                  <Button onClick={() => setCurrentStep(9)}>Pr√≥ximo</Button>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 09 - PRE√áOS LOCA√á√ÉO E VENDA */}
            {/* ================================================================ */}
            {currentStep === 9 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Pre√ßos Loca√ß√£o e Venda</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Configure os valores para loca√ß√£o residencial e/ou venda
                    </p>
                  </div>

                  {/* Tipo de Neg√≥cio */}
                  <Card>
                    <CardContent className="pt-6">
                      <Label className="text-base font-semibold mb-4 block">Tipo de Neg√≥cio</Label>
                      <div className="flex gap-2">
                        <Button
                          type="button"
                          variant={tipoNegocio === 'aluguel' ? "default" : "outline"}
                          onClick={() => { setTipoNegocio('aluguel'); setHasUnsavedChanges(true); }}
                          className="flex-1"
                        >
                          Aluguel
                        </Button>
                        <Button
                          type="button"
                          variant={tipoNegocio === 'venda' ? "default" : "outline"}
                          onClick={() => { setTipoNegocio('venda'); setHasUnsavedChanges(true); }}
                          className="flex-1"
                        >
                          Venda
                        </Button>
                        <Button
                          type="button"
                          variant={tipoNegocio === 'ambos' ? "default" : "outline"}
                          onClick={() => { setTipoNegocio('ambos'); setHasUnsavedChanges(true); }}
                          className="flex-1"
                        >
                          Ambos
                        </Button>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Valores de Aluguel */}
                  {(tipoNegocio === 'aluguel' || tipoNegocio === 'ambos') && (
                    <Card>
                      <CardContent className="pt-6">
                        <h3 className="font-semibold text-lg mb-4">Valores de Aluguel</h3>
                        
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <Label>Valor do Aluguel (R$)</Label>
                            <Input
                              type="number"
                              value={valorAluguel}
                              onChange={(e) => { setValorAluguel(Number(e.target.value)); setHasUnsavedChanges(true); }}
                              placeholder="0.00"
                            />
                          </div>

                          <div>
                            <Label>IPTU Mensal (R$)</Label>
                            <Input
                              type="number"
                              value={valorIptu}
                              onChange={(e) => { setValorIptu(Number(e.target.value)); setHasUnsavedChanges(true); }}
                              placeholder="0.00"
                            />
                          </div>

                          <div>
                            <Label>Condom√≠nio (R$)</Label>
                            <Input
                              type="number"
                              value={valorCondominio}
                              onChange={(e) => { setValorCondominio(Number(e.target.value)); setHasUnsavedChanges(true); }}
                              placeholder="0.00"
                            />
                          </div>

                          <div>
                            <Label>Taxa de Servi√ßo (R$)</Label>
                            <Input
                              type="number"
                              value={taxaServico}
                              onChange={(e) => { setTaxaServico(Number(e.target.value)); setHasUnsavedChanges(true); }}
                              placeholder="0.00"
                            />
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Valores de Venda */}
                  {(tipoNegocio === 'venda' || tipoNegocio === 'ambos') && (
                    <Card>
                      <CardContent className="pt-6">
                        <h3 className="font-semibold text-lg mb-4">Valores de Venda</h3>
                        
                        <div className="grid grid-cols-2 gap-4 mb-4">
                          <div>
                            <Label>Valor de Venda (R$)</Label>
                            <Input
                              type="number"
                              value={valorVenda}
                              onChange={(e) => { setValorVenda(Number(e.target.value)); setHasUnsavedChanges(true); }}
                              placeholder="0.00"
                            />
                          </div>

                          <div>
                            <Label>IPTU Anual (R$)</Label>
                            <Input
                              type="number"
                              value={iptuAnual}
                              onChange={(e) => { setIptuAnual(Number(e.target.value)); setHasUnsavedChanges(true); }}
                              placeholder="0.00"
                            />
                          </div>
                        </div>

                        <div className="space-y-2">
                          <div className="flex items-center space-x-2">
                            <Checkbox
                              id="aceita-financiamento"
                              checked={aceitaFinanciamento}
                              onCheckedChange={(checked) => {
                                setAceitaFinanciamento(checked as boolean);
                                setHasUnsavedChanges(true);
                              }}
                            />
                            <Label htmlFor="aceita-financiamento" className="cursor-pointer">
                              Aceita financiamento banc√°rio
                            </Label>
                          </div>

                          <div className="flex items-center space-x-2">
                            <Checkbox
                              id="aceita-permuta"
                              checked={aceitaPermuta}
                              onCheckedChange={(checked) => {
                                setAceitaPermuta(checked as boolean);
                                setHasUnsavedChanges(true);
                              }}
                            />
                            <Label htmlFor="aceita-permuta" className="cursor-pointer">
                              Aceita permuta
                            </Label>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Bot√£o Salvar */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={savePrecosLocacaoVenda}
                      className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Pre√ßos
                    </Button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(8)}>
                    Anterior
                  </Button>
                  <Button onClick={() => setCurrentStep(10)}>Pr√≥ximo</Button>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 10 - CONFIGURA√á√ÉO DE PRE√áO TEMPORADA */}
            {/* ================================================================ */}
            {currentStep === 10 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Configura√ß√£o de Pre√ßo Temporada</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Configure pre√ßos base, descontos e taxas para loca√ß√£o por temporada
                    </p>
                  </div>

                  {/* Modo de Configura√ß√£o */}
                  <Card>
                    <CardContent className="pt-6">
                      <Label className="text-base font-semibold mb-4 block">Modo de Configura√ß√£o</Label>
                      <div className="flex gap-2">
                        <Button
                          type="button"
                          variant={modoConfigPreco === 'global' ? "default" : "outline"}
                          onClick={() => { setModoConfigPreco('global'); setHasUnsavedChanges(true); }}
                          className="flex-1"
                        >
                          Global
                        </Button>
                        <Button
                          type="button"
                          variant={modoConfigPreco === 'individual' ? "default" : "outline"}
                          onClick={() => { setModoConfigPreco('individual'); setHasUnsavedChanges(true); }}
                          className="flex-1"
                        >
                          Individual por Canal
                        </Button>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Regi√£o e Moeda */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Regi√£o e Moeda</h3>
                      
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <Label>Regi√£o</Label>
                          <Select value={regiao} onValueChange={(value) => { setRegiao(value); setHasUnsavedChanges(true); }}>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="BR">Brasil</SelectItem>
                              <SelectItem value="US">Estados Unidos</SelectItem>
                              <SelectItem value="EU">Europa</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>

                        <div>
                          <Label>Moeda</Label>
                          <Select value={moeda} onValueChange={(value) => { setMoeda(value); setHasUnsavedChanges(true); }}>
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="BRL">R$ Real</SelectItem>
                              <SelectItem value="USD">$ D√≥lar</SelectItem>
                              <SelectItem value="EUR">‚Ç¨ Euro</SelectItem>
                            </SelectContent>
                          </Select>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Descontos */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Descontos por Perman√™ncia</h3>
                      
                      <div className="grid grid-cols-3 gap-4">
                        <div>
                          <Label>Longa Estadia (%)</Label>
                          <Input
                            type="number"
                            value={descontoLongaEstadia}
                            onChange={(e) => { setDescontoLongaEstadia(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0"
                          />
                        </div>

                        <div>
                          <Label>Desconto Semanal (%)</Label>
                          <Input
                            type="number"
                            value={descontoSemanal}
                            onChange={(e) => { setDescontoSemanal(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0"
                          />
                        </div>

                        <div>
                          <Label>Desconto Mensal (%)</Label>
                          <Input
                            type="number"
                            value={descontoMensal}
                            onChange={(e) => { setDescontoMensal(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0"
                          />
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Dep√≥sito e Precifica√ß√£o Din√¢mica */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Dep√≥sito e Precifica√ß√£o</h3>
                      
                      <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                          <Label>Valor do Dep√≥sito</Label>
                          <Input
                            type="number"
                            value={valorDeposito}
                            onChange={(e) => { setValorDeposito(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0.00"
                          />
                        </div>
                      </div>

                      <div className="flex items-center space-x-2">
                        <Checkbox
                          id="precificacao-dinamica"
                          checked={usarPrecificacaoDinamica}
                          onCheckedChange={(checked) => {
                            setUsarPrecificacaoDinamica(checked as boolean);
                            setHasUnsavedChanges(true);
                          }}
                        />
                        <Label htmlFor="precificacao-dinamica" className="cursor-pointer">
                          Usar precifica√ß√£o din√¢mica (ajuste autom√°tico por demanda)
                        </Label>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Taxas */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Taxas Adicionais</h3>
                      
                      <div className="grid grid-cols-3 gap-4">
                        <div>
                          <Label>Taxa de Limpeza</Label>
                          <Input
                            type="number"
                            value={taxaLimpeza}
                            onChange={(e) => { setTaxaLimpeza(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0.00"
                          />
                        </div>

                        <div>
                          <Label>Taxa Pet</Label>
                          <Input
                            type="number"
                            value={taxaPet}
                            onChange={(e) => { setTaxaPet(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0.00"
                          />
                        </div>

                        <div>
                          <Label>Taxa Servi√ßos Extras</Label>
                          <Input
                            type="number"
                            value={taxaServicosExtras}
                            onChange={(e) => { setTaxaServicosExtras(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0.00"
                          />
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Bot√£o Salvar */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={saveConfigPrecoTemporada}
                      className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Configura√ß√£o
                    </Button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(9)}>
                    Anterior
                  </Button>
                  <Button onClick={() => setCurrentStep(11)}>Pr√≥ximo</Button>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 11 - PRECIFICA√á√ÉO INDIVIDUAL */}
            {/* ================================================================ */}
            {currentStep === 11 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Precifica√ß√£o Individual</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Configure pre√ßos espec√≠ficos por per√≠odo, dia da semana e datas especiais
                    </p>
                  </div>

                  {/* Pre√ßo Base */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Pre√ßo Base por Noite</h3>
                      
                      <div>
                        <Label>Valor por Noite</Label>
                        <Input
                          type="number"
                          value={precoBaseNoite}
                          onChange={(e) => { setPrecoBaseNoite(Number(e.target.value)); setHasUnsavedChanges(true); }}
                          placeholder="0.00"
                        />
                      </div>
                    </CardContent>
                  </Card>

                  {/* Descontos por Perman√™ncia */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Descontos por Perman√™ncia</h3>
                      
                      <div className="grid grid-cols-3 gap-4">
                        <div>
                          <Label>2+ Noites (%)</Label>
                          <Input
                            type="number"
                            value={descontoPermanencia2Noites}
                            onChange={(e) => { setDescontoPermanencia2Noites(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0"
                          />
                        </div>

                        <div>
                          <Label>7+ Noites (%)</Label>
                          <Input
                            type="number"
                            value={descontoPermanencia7Noites}
                            onChange={(e) => { setDescontoPermanencia7Noites(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0"
                          />
                        </div>

                        <div>
                          <Label>30+ Noites (%)</Label>
                          <Input
                            type="number"
                            value={descontoPermanencia30Noites}
                            onChange={(e) => { setDescontoPermanencia30Noites(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0"
                          />
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Nota sobre funcionalidades avan√ßadas */}
                  <Card className="bg-blue-50 dark:bg-blue-950/20">
                    <CardContent className="pt-6">
                      <div className="flex gap-3">
                        <div className="text-blue-600 dark:text-blue-400">
                          ‚ÑπÔ∏è
                        </div>
                        <div>
                          <h3 className="font-semibold mb-2">Funcionalidades Avan√ßadas</h3>
                          <p className="text-sm text-gray-700 dark:text-gray-300">
                            A configura√ß√£o de per√≠odos sazonais, pre√ßos por dia da semana e datas especiais 
                            estar√° dispon√≠vel em breve. Por enquanto, use o pre√ßo base e descontos gerais.
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Bot√£o Salvar */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={savePrecificacaoIndividual}
                      className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Precifica√ß√£o
                    </Button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(10)}>
                    Anterior
                  </Button>
                  <Button onClick={() => setCurrentStep(12)}>Pr√≥ximo</Button>
                </div>
              </>
            )}

            {/* ================================================================ */}
            {/* STEP 12 - PRE√áOS DERIVADOS */}
            {/* ================================================================ */}
            {currentStep === 12 && (
              <>
                <div className="space-y-6">
                  <div>
                    <h2 className="text-2xl font-bold mb-2">Pre√ßos Derivados</h2>
                    <p className="text-gray-600 dark:text-gray-400">
                      Configure taxas por h√≥spedes extras e valores para crian√ßas
                    </p>
                  </div>

                  {/* Varia√ß√£o por H√≥spedes */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Cobran√ßa por H√≥spedes</h3>
                      
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <Label>Varia√ß√£o por H√≥spede (%)</Label>
                          <Input
                            type="number"
                            value={variacaoPorHospedes}
                            onChange={(e) => { setVariacaoPorHospedes(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0"
                          />
                          <p className="text-xs text-gray-500 mt-1">Acr√©scimo percentual por h√≥spede adicional</p>
                        </div>

                        <div>
                          <Label>Taxa H√≥spede Extra (R$)</Label>
                          <Input
                            type="number"
                            value={taxaHospedeExtra}
                            onChange={(e) => { setTaxaHospedeExtra(Number(e.target.value)); setHasUnsavedChanges(true); }}
                            placeholder="0.00"
                          />
                          <p className="text-xs text-gray-500 mt-1">Valor fixo por h√≥spede adicional por noite</p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Cobran√ßa para Crian√ßas */}
                  <Card>
                    <CardContent className="pt-6">
                      <h3 className="font-semibold text-lg mb-4">Cobran√ßa para Crian√ßas</h3>
                      
                      <div className="mb-4">
                        <div className="flex items-center space-x-2">
                          <Checkbox
                            id="cobrar-criancas"
                            checked={cobrarCriancas}
                            onCheckedChange={(checked) => {
                              setCobrarCriancas(checked as boolean);
                              setHasUnsavedChanges(true);
                            }}
                          />
                          <Label htmlFor="cobrar-criancas" className="cursor-pointer">
                            Cobrar diferenciado para crian√ßas
                          </Label>
                        </div>
                      </div>

                      {cobrarCriancas && (
                        <div className="grid grid-cols-3 gap-4">
                          <div>
                            <Label>Idade M√≠nima</Label>
                            <Input
                              type="number"
                              value={idadeMinimaCrianca}
                              onChange={(e) => { setIdadeMinimaCrianca(Number(e.target.value)); setHasUnsavedChanges(true); }}
                              placeholder="0"
                            />
                          </div>

                          <div>
                            <Label>Idade M√°xima</Label>
                            <Input
                              type="number"
                              value={idadeMaximaCrianca}
                              onChange={(e) => { setIdadeMaximaCrianca(Number(e.target.value)); setHasUnsavedChanges(true); }}
                              placeholder="12"
                            />
                          </div>

                          <div>
                            <Label>Desconto (%)</Label>
                            <Input
                              type="number"
                              value={descontoCrianca}
                              onChange={(e) => { setDescontoCrianca(Number(e.target.value)); setHasUnsavedChanges(true); }}
                              placeholder="0"
                            />
                          </div>
                        </div>
                      )}
                    </CardContent>
                  </Card>

                  {/* Bot√£o Salvar */}
                  <div className="flex justify-end">
                    <Button
                      type="button"
                      onClick={savePrecosDerviados}
                      className="bg-green-600 hover:bg-green-700 text-white font-bold px-8"
                    >
                      <Save className="w-4 h-4 mr-2" /> Salvar Pre√ßos Derivados
                    </Button>
                  </div>
                </div>

                {/* Footer Actions */}
                <div className="flex items-center justify-between mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                  <Button variant="outline" onClick={() => setCurrentStep(11)}>
                    Anterior
                  </Button>
                  <Button onClick={() => toast.success('Wizard financeiro completo!')}>
                    Finalizar
                  </Button>
                </div>
              </>
            )}
          </div>
        </div>
      </div>

      {/* Modal de Preview de Foto */}
      {selectedPhotoPreview && (
        <div 
          className="fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4"
          onClick={() => setSelectedPhotoPreview(null)}
        >
          <div className="relative max-w-5xl w-full">
            <Button
              size="icon"
              variant="secondary"
              className="absolute top-4 right-4 z-10"
              onClick={() => setSelectedPhotoPreview(null)}
            >
              <X className="h-4 w-4" />
            </Button>
            <img
              src={selectedPhotoPreview.url}
              alt="Preview"
              className="w-full h-auto max-h-[90vh] object-contain rounded-lg"
            />
            <div className="absolute bottom-4 left-4 right-4 bg-black/80 p-4 rounded-lg">
              <div className="flex items-center justify-between">
                <div>
                  <Badge variant="secondary" className="mb-2">
                    {selectedPhotoPreview.roomName}
                  </Badge>
                  {selectedPhotoPreview.tags && selectedPhotoPreview.tags.length > 0 && (
                    <div className="flex gap-1 mt-2">
                      {selectedPhotoPreview.tags.map((tag, i) => (
                        <Badge key={i} variant="outline">
                          {tag}
                        </Badge>
                      ))}
                    </div>
                  )}
                </div>
                <Button
                  variant={coverPhotoId === selectedPhotoPreview.id ? 'default' : 'secondary'}
                  onClick={(e) => {
                    e.stopPropagation();
                    setCoverPhotoId(selectedPhotoPreview.id);
                    setHasUnsavedChanges(true);
                    toast.success('Foto de capa selecionada!');
                  }}
                >
                  <Star className="h-4 w-4 mr-2" />
                  {coverPhotoId === selectedPhotoPreview.id ? 'Foto de Capa' : 'Definir como Capa'}
                </Button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Modal de Tags */}
      {showTagsModal && (
        <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
          <Card className="w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
            <CardContent className="p-6 flex flex-col gap-4 flex-1 overflow-hidden">
              <div>
                <h3 className="text-lg font-semibold">Adicionar Tags</h3>
                <p className="text-sm text-muted-foreground">
                  Selecione as tags para adicionar √†s {selectedPhotos.length} foto(s) selecionada(s)
                </p>
              </div>
              <Separator />
              <ScrollArea className="flex-1">
                <TagsSelector
                  onApply={(tags) => applyTagsToSelected(tags)}
                  onCancel={() => setShowTagsModal(false)}
                />
              </ScrollArea>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  );
};

// ============================================================================
// TAGS SELECTOR COMPONENT
// ============================================================================

function TagsSelector({
  onApply,
  onCancel,
}: {
  onApply: (tags: string[]) => void;
  onCancel: () => void;
}) {
  const [selectedTags, setSelectedTags] = useState<string[]>([]);
  const [searchQuery, setSearchQuery] = useState('');

  const filteredTags = PHOTO_TAGS.filter((tag) =>
    tag.toLowerCase().includes(searchQuery.toLowerCase())
  );

  const toggleTag = (tag: string) => {
    setSelectedTags((prev) => {
      const newTags = prev.includes(tag) ? prev.filter((t) => t !== tag) : [...prev, tag];
      return newTags;
    });
  };

  return (
    <div className="space-y-4">
      <Input
        placeholder="Buscar tags (ex: vista, piscina, quarto)..."
        value={searchQuery}
        onChange={(e) => setSearchQuery(e.target.value)}
      />

      <div className="space-y-2">
        {filteredTags.length > 0 ? (
          filteredTags.map((tag) => (
            <div
              key={tag}
              className={`flex items-center gap-2 p-2 rounded-lg border cursor-pointer hover:bg-muted ${
                selectedTags.includes(tag) ? 'bg-primary/10 border-primary' : ''
              }`}
              onClick={() => toggleTag(tag)}
            >
              <Checkbox checked={selectedTags.includes(tag)} />
              <span className="text-sm">{tag}</span>
              {selectedTags.includes(tag) && <Check className="h-4 w-4 ml-auto text-primary" />}
            </div>
          ))
        ) : (
          <div className="text-center py-8 text-muted-foreground">
            <p>Nenhuma tag encontrada para &quot;{searchQuery}&quot;</p>
          </div>
        )}
      </div>

      <div className="flex gap-2 pt-4 border-t">
        <Button
          variant="outline"
          onClick={onCancel}
          className="flex-1"
        >
          Cancelar
        </Button>
        <Button
          onClick={() => onApply(selectedTags)}
          disabled={selectedTags.length === 0}
          className="flex-1"
        >
          Aplicar {selectedTags.length > 0 && `(${selectedTags.length})`}
        </Button>
      </div>
    </div>
  );
}

export default NovoAnuncio;
