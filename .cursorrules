# Rendizy AI Assistant Rules

## ‚ö†Ô∏è CRITICAL ADRs - MANDATORY READING

### ADR #1: Edge Functions Architecture
üìÑ **Read**: `docs/ADR_EDGE_FUNCTIONS_ARQUITETURA_CENTRALIZADA.md`

**ABSOLUTE RULES:**
- NEVER create new folders in `supabase/functions/`
- ONLY TWO functions allowed: `rendizy-server` and `rendizy-public`
- ALL new features MUST be added as ROUTES in `rendizy-server`
- NEVER "separate to organize" - this caused 20+ days of webhook failures

### ADR #2: StaysNet Webhooks Reference
üìÑ **Read**: `docs/ADR_STAYSNET_WEBHOOK_REFERENCE.md`

## Critical Zones - DO NOT MODIFY WITHOUT EXPLICIT USER APPROVAL

### 1. Property Loading (App.tsx::loadProperties)
- DO NOT alter the fetch logic for `properties/lista`
- DO NOT add filters that may exclude properties
- DO NOT modify setProperties() or setSelectedProperties() without validation
- DO NOT remove diagnostic logs marked with [ZONA_CRITICA]
- ALWAYS keep the validation: if apiProperties.length === 0 && anuncios.length > 0, don't clear

### 2. Anuncios Listing Route (routes-properties.ts::/lista)
- DO NOT add filters that may exclude valid announcements
- DO NOT alter .eq('organization_id', organizationId)
- DO NOT remove fields from the select statement
- DO NOT add .limit() without explicit reason
- ALWAYS log organization_id at the start of the route

### 3. Multi-Tenancy (utils-multi-tenant.ts)
- DO NOT alter RENDIZY_MASTER_ORG_ID
- DO NOT modify getOrganizationIdForRequest logic

### 4. Reservations (routes-reservations.ts)
- DO NOT alter .eq('organization_id', organizationId) filter
- DO NOT modify input/output contract without creating v2
- DO NOT remove date validation (check_in, check_out)
- DO NOT alter calculateNights logic
- ALWAYS keep contract lock header in file
- ALWAYS maintain tenant isolation - reservations must never leak

### 5. Guests (routes-guests.ts)
- DO NOT alter .eq('organization_id', organizationId) filter
- DO NOT remove data sanitization (CPF, email, phone)
- DO NOT expose sensitive data (full CPF) in public listings
- ALWAYS sanitize inputs with sanitize* functions
- ALWAYS maintain tenant isolation

### 6. Calendar (routes-calendar.ts)
- DO NOT alter organization_id filter
- DO NOT modify date overlap logic without tests
- DO NOT remove existing filter params (startDate, endDate, propertyIds)
- DO NOT break return contract that external sites consume
- ALWAYS maintain consistency with reservations and blocks tables

### 7. Blocks (routes-blocks.ts)
- DO NOT alter organization_id filter
- DO NOT remove date overlap validation
- DO NOT allow blocks without valid property_id
- ALWAYS apply tenancyMiddleware to all routes
- ALWAYS use sqlToBlock mapper for SQL data

## Before Modifying Critical Code
1. ASK the user for explicit approval
2. EXPLAIN the impact of proposed changes
3. PRESERVE all diagnostic logs
4. DO NOT remove blocking comments (‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê...‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê)

## Code Markers
- [ZONA_CRITICA] = critical zone, do not modify without approval
- üîí PROTE√á√ÉO: = critical validation, do not remove
- üö® ALERTA: = error log, must be preserved
