<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Consulta Direta - Supabase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4ec9b0;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .status {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .loading {
            background: #264f78;
            color: #fff;
        }
        
        .success {
            background: #0e639c;
            color: #fff;
        }
        
        .error {
            background: #f14c4c;
            color: #fff;
        }
        
        .section {
            background: #252526;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4ec9b0;
            border-radius: 4px;
        }
        
        .section h2 {
            color: #4ec9b0;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .field {
            margin-bottom: 10px;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 3px;
        }
        
        .field-name {
            color: #9cdcfe;
            font-weight: bold;
        }
        
        .field-value {
            color: #ce9178;
            margin-left: 10px;
        }
        
        .empty {
            color: #f14c4c;
            font-style: italic;
        }
        
        .has-data {
            color: #4ec9b0;
        }
        
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            color: #d4d4d4;
            border: 1px solid #3e3e42;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .photo-item {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #3e3e42;
        }
        
        .photo-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 3px;
            margin-bottom: 5px;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            background: #264f78;
            color: #fff;
            border-radius: 3px;
            font-size: 11px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .badge.success {
            background: #0e639c;
        }
        
        .badge.warning {
            background: #bf8803;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç CONSULTA DIRETA - SUPABASE DATABASE</h1>
        
        <div id="status" class="status loading">
            ‚è≥ Consultando banco de dados...
        </div>
        
        <div id="results"></div>
    </div>

    <script type="module">
        // Importar configura√ß√µes do Supabase
        const projectId = 'uzdpaacxayfrnznjcmgj';
        const publicAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6ZHBhYWN4YXlmcm56bmpjbWdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAxNDc0NzcsImV4cCI6MjA0NTcyMzQ3N30.gD2DolP3fVnzLXMYmQlIlnwG9Qsph4Zbi-UpcczkKhw';
        
        const propertyId = 'acc_97239cad-4b8d-46c0-82a3-28673ae4cfc1';
        
        async function consultarBanco() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            try {
                console.log('üîç Consultando im√≥vel:', propertyId);
                
                const url = `https://${projectId}.supabase.co/functions/v1/make-server-67caf26a/properties/${propertyId}`;
                console.log('üåê URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${publicAnonKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Status HTTP:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('üì¶ Resposta completa:', result);
                
                if (!result.success || !result.data) {
                    throw new Error('Im√≥vel n√£o encontrado no banco de dados');
                }
                
                const data = result.data;
                
                // Atualizar status
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ DADOS ENCONTRADOS NO SUPABASE';
                
                // Montar HTML com os resultados
                let html = '';
                
                // ========== RESUMO GERAL ==========
                html += '<div class="section">';
                html += '<h2>üìä RESUMO GERAL</h2>';
                
                const hasName = !!data.name;
                const hasPhotos = data.photos && Array.isArray(data.photos) && data.photos.length > 0;
                const hasCoverPhoto = !!data.coverPhoto;
                const hasLocationAmenities = data.locationAmenities && data.locationAmenities.length > 0;
                const hasListingAmenities = data.listingAmenities && data.listingAmenities.length > 0;
                const hasContentPhotos = data.contentPhotos?.photos && data.contentPhotos.photos.length > 0;
                
                html += `<div class="field">`;
                html += `<span class="field-name">Nome:</span>`;
                html += `<span class="field-value ${hasName ? 'has-data' : 'empty'}">${hasName ? '‚úÖ TEM (' + data.name + ')' : '‚ùå VAZIO'}</span>`;
                html += `</div>`;
                
                html += `<div class="field">`;
                html += `<span class="field-name">Fotos (photos):</span>`;
                html += `<span class="field-value ${hasPhotos ? 'has-data' : 'empty'}">${hasPhotos ? '‚úÖ TEM (' + data.photos.length + ' fotos)' : '‚ùå VAZIO'}</span>`;
                html += `</div>`;
                
                html += `<div class="field">`;
                html += `<span class="field-name">Foto de Capa:</span>`;
                html += `<span class="field-value ${hasCoverPhoto ? 'has-data' : 'empty'}">${hasCoverPhoto ? '‚úÖ TEM' : '‚ùå VAZIO'}</span>`;
                html += `</div>`;
                
                html += `<div class="field">`;
                html += `<span class="field-name">Amenities do Local:</span>`;
                html += `<span class="field-value ${hasLocationAmenities ? 'has-data' : 'empty'}">${hasLocationAmenities ? '‚úÖ TEM (' + data.locationAmenities.length + ' itens)' : '‚ùå VAZIO'}</span>`;
                html += `</div>`;
                
                html += `<div class="field">`;
                html += `<span class="field-name">Amenities do An√∫ncio:</span>`;
                html += `<span class="field-value ${hasListingAmenities ? 'has-data' : 'empty'}">${hasListingAmenities ? '‚úÖ TEM (' + data.listingAmenities.length + ' itens)' : '‚ùå VAZIO'}</span>`;
                html += `</div>`;
                
                if (hasContentPhotos) {
                    html += `<div class="field">`;
                    html += `<span class="field-name">‚ö†Ô∏è ContentPhotos (aninhado):</span>`;
                    html += `<span class="field-value" style="color: #bf8803;">‚ö†Ô∏è TEM (' + data.contentPhotos.photos.length + ' fotos em estrutura aninhada - PROBLEMA!)</span>`;
                    html += `</div>`;
                }
                
                html += '</div>';
                
                // ========== DADOS B√ÅSICOS ==========
                html += '<div class="section">';
                html += '<h2>üìù DADOS B√ÅSICOS</h2>';
                html += `<div class="field"><span class="field-name">ID:</span><span class="field-value">${data.id || 'N/A'}</span></div>`;
                html += `<div class="field"><span class="field-name">Nome:</span><span class="field-value ${data.name ? '' : 'empty'}">${data.name || '‚ùå VAZIO'}</span></div>`;
                html += `<div class="field"><span class="field-name">C√≥digo:</span><span class="field-value">${data.code || 'N/A'}</span></div>`;
                html += `<div class="field"><span class="field-name">Tipo:</span><span class="field-value">${data.type || 'N/A'}</span></div>`;
                html += `<div class="field"><span class="field-name">Status:</span><span class="field-value">${data.status || 'N/A'}</span></div>`;
                html += `<div class="field"><span class="field-name">Endere√ßo:</span><span class="field-value">${data.address || 'N/A'}</span></div>`;
                html += `<div class="field"><span class="field-name">Cidade:</span><span class="field-value">${data.city || 'N/A'}</span></div>`;
                html += `<div class="field"><span class="field-name">Estado:</span><span class="field-value">${data.state || 'N/A'}</span></div>`;
                html += '</div>';
                
                // ========== FOTOS ==========
                if (hasPhotos) {
                    html += '<div class="section">';
                    html += `<h2>üì∏ FOTOS (${data.photos.length})</h2>`;
                    html += '<div class="photo-grid">';
                    
                    data.photos.forEach((photo, index) => {
                        const photoUrl = typeof photo === 'string' ? photo : photo.url;
                        const isCover = typeof photo === 'object' && photo.isCover;
                        const category = typeof photo === 'object' ? photo.category : null;
                        
                        html += '<div class="photo-item">';
                        html += `<img src="${photoUrl}" alt="Foto ${index + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27150%27 height=%27100%27%3E%3Crect fill=%27%23333%27 width=%27150%27 height=%27100%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 fill=%27%23999%27%3EErro%3C/text%3E%3C/svg%3E'">`;
                        html += `<div style="font-size: 11px;">`;
                        html += `#${index + 1}`;
                        if (isCover) html += ` <span class="badge warning">‚≠ê CAPA</span>`;
                        if (category) html += `<br>${category}`;
                        html += `</div>`;
                        html += '</div>';
                    });
                    
                    html += '</div>';
                    html += '</div>';
                }
                
                // ========== CONTENTPHOTOS ANINHADO ==========
                if (hasContentPhotos) {
                    html += '<div class="section" style="border-left-color: #bf8803;">';
                    html += `<h2>‚ö†Ô∏è CONTENTPHOTOS - ESTRUTURA ANINHADA (${data.contentPhotos.photos.length})</h2>`;
                    html += '<p style="color: #bf8803; margin-bottom: 15px;">PROBLEMA: Fotos em contentPhotos.photos em vez de photos (campo raiz)</p>';
                    html += '<div class="photo-grid">';
                    
                    data.contentPhotos.photos.forEach((photo, index) => {
                        html += '<div class="photo-item" style="border-color: #bf8803;">';
                        html += `<img src="${photo.url}" alt="Foto aninhada ${index + 1}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27150%27 height=%27100%27%3E%3Crect fill=%27%23bf8803%27 width=%27150%27 height=%27100%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 fill=%27%23fff%27%3EBlob%3C/text%3E%3C/svg%3E'">`;
                        html += `<div style="font-size: 11px;">`;
                        html += `#${index + 1}`;
                        if (photo.isCover) html += ` <span class="badge warning">‚≠ê CAPA</span>`;
                        if (photo.category) html += `<br>${photo.category}`;
                        html += `</div>`;
                        html += '</div>';
                    });
                    
                    html += '</div>';
                    html += '</div>';
                }
                
                // ========== AMENITIES DO LOCAL ==========
                html += '<div class="section">';
                html += '<h2>üè¢ AMENIDADES DO LOCAL</h2>';
                if (hasLocationAmenities) {
                    html += '<div>';
                    data.locationAmenities.forEach(amenity => {
                        html += `<span class="badge success">‚úÖ ${amenity}</span>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p class="empty">‚ùå Nenhuma amenidade do local cadastrada</p>';
                }
                html += '</div>';
                
                // ========== AMENITIES DO AN√öNCIO ==========
                html += '<div class="section">';
                html += '<h2>üè† AMENIDADES DO AN√öNCIO</h2>';
                if (hasListingAmenities) {
                    html += '<div>';
                    data.listingAmenities.forEach(amenity => {
                        html += `<span class="badge success">‚úÖ ${amenity}</span>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p class="empty">‚ùå Nenhuma amenidade do an√∫ncio cadastrada</p>';
                }
                html += '</div>';
                
                // ========== JSON COMPLETO ==========
                html += '<div class="section">';
                html += '<h2>üíª JSON COMPLETO DO BANCO DE DADOS</h2>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                html += '</div>';
                
                // ========== DIAGN√ìSTICO ==========
                html += '<div class="section">';
                html += '<h2>üéØ DIAGN√ìSTICO E A√á√ïES</h2>';
                
                if (!hasPhotos && hasContentPhotos) {
                    html += '<div class="field">';
                    html += '<p style="color: #bf8803; margin-bottom: 10px;"><strong>‚ö†Ô∏è PROBLEMA IDENTIFICADO:</strong></p>';
                    html += '<p>As fotos est√£o na estrutura aninhada <code>contentPhotos.photos</code> em vez de estarem no campo raiz <code>photos</code>.</p>';
                    html += '<p style="margin-top: 10px;"><strong>SOLU√á√ÉO:</strong> Re-salve o im√≥vel. A v1.0.103.313 j√° corrige isso automaticamente no backend.</p>';
                    html += '</div>';
                }
                
                if (!hasLocationAmenities) {
                    html += '<div class="field">';
                    html += '<p style="color: #f14c4c;"><strong>‚ùå PROBLEMA:</strong> Amenidades do local n√£o foram salvas. Preencha o Step 3 do wizard.</p>';
                    html += '</div>';
                }
                
                if (!hasListingAmenities) {
                    html += '<div class="field">';
                    html += '<p style="color: #f14c4c;"><strong>‚ùå PROBLEMA:</strong> Amenidades do an√∫ncio n√£o foram salvas. Preencha o Step 4 do wizard.</p>';
                    html += '</div>';
                }
                
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå ERRO: ' + error.message;
                
                resultsDiv.innerHTML = `
                    <div class="section" style="border-left-color: #f14c4c;">
                        <h2>‚ùå ERRO NA CONSULTA</h2>
                        <pre>${error.message}\n\n${error.stack || ''}</pre>
                    </div>
                `;
            }
        }
        
        // Executar consulta automaticamente
        consultarBanco();
    </script>
</body>
</html>
