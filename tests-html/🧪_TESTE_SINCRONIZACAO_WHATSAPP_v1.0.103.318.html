<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste de Sincroniza√ß√£o WhatsApp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .test-section {
            background: #f9fafb;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .test-section h2 {
            margin-bottom: 20px;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin: 5px;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result.success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }
        
        .result.error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #7f1d1d;
        }
        
        .result.info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e3a8a;
        }
        
        .progress {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .status-card .value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .status-card .label {
            color: #64748b;
            font-size: 14px;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Teste de Sincroniza√ß√£o WhatsApp</h1>
            <p>v1.0.103.318 - Teste completo de salvamento no Supabase</p>
        </div>
        
        <div class="content">
            <!-- Status Atual -->
            <div class="test-section">
                <h2>üìä Status Atual</h2>
                <div class="status-grid" id="status-grid">
                    <div class="status-card">
                        <div class="value" id="contacts-count">-</div>
                        <div class="label">Contatos</div>
                    </div>
                    <div class="status-card">
                        <div class="value" id="chats-count">-</div>
                        <div class="label">Conversas</div>
                    </div>
                    <div class="status-card">
                        <div class="value" id="messages-count">-</div>
                        <div class="label">Mensagens</div>
                    </div>
                    <div class="status-card">
                        <div class="value" id="config-status">-</div>
                        <div class="label">Configura√ß√£o</div>
                    </div>
                </div>
                <button class="btn" onclick="loadStatus()">üîÑ Atualizar Status</button>
            </div>
            
            <!-- Teste 1: Salvar Configura√ß√£o -->
            <div class="test-section">
                <h2>üß™ Teste 1: Salvar Configura√ß√£o</h2>
                <p style="margin-bottom: 15px;">Testa se a configura√ß√£o do WhatsApp est√° sendo salva corretamente no Supabase KV Store.</p>
                <button class="btn" onclick="testSaveConfig()" id="btn-test-1">‚ñ∂Ô∏è Executar Teste 1</button>
                <div id="result-1"></div>
            </div>
            
            <!-- Teste 2: Salvar Contato -->
            <div class="test-section">
                <h2>üß™ Teste 2: Salvar Contato</h2>
                <p style="margin-bottom: 15px;">Cria um contato de teste e verifica se foi salvo no banco de dados.</p>
                <button class="btn" onclick="testSaveContact()" id="btn-test-2">‚ñ∂Ô∏è Executar Teste 2</button>
                <div id="result-2"></div>
            </div>
            
            <!-- Teste 3: Salvar Conversa -->
            <div class="test-section">
                <h2>üß™ Teste 3: Salvar Conversa</h2>
                <p style="margin-bottom: 15px;">Cria uma conversa de teste vinculada ao contato criado.</p>
                <button class="btn" onclick="testSaveChat()" id="btn-test-3">‚ñ∂Ô∏è Executar Teste 3</button>
                <div id="result-3"></div>
            </div>
            
            <!-- Teste 4: Salvar Mensagem -->
            <div class="test-section">
                <h2>üß™ Teste 4: Salvar Mensagem</h2>
                <p style="margin-bottom: 15px;">Cria uma mensagem de teste na conversa criada.</p>
                <button class="btn" onclick="testSaveMessage()" id="btn-test-4">‚ñ∂Ô∏è Executar Teste 4</button>
                <div id="result-4"></div>
            </div>
            
            <!-- Teste 5: Sincroniza√ß√£o Evolution API -->
            <div class="test-section">
                <h2>üß™ Teste 5: Sincronizar com Evolution API</h2>
                <p style="margin-bottom: 15px;">Tenta sincronizar contatos reais da Evolution API para o Supabase.</p>
                <button class="btn btn-warning" onclick="testSyncFromEvolution()" id="btn-test-5">‚ö° Executar Teste 5 (requer Evolution configurada)</button>
                <div id="result-5"></div>
            </div>
            
            <!-- Teste Completo -->
            <div class="test-section">
                <h2>üöÄ Teste Completo</h2>
                <p style="margin-bottom: 15px;">Executa todos os testes em sequ√™ncia e gera relat√≥rio completo.</p>
                <button class="btn btn-success" onclick="runAllTests()" id="btn-all-tests">‚ñ∂Ô∏è Executar Todos os Testes</button>
                <div id="progress-container" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" id="progress-bar">0%</div>
                    </div>
                </div>
                <div id="result-all"></div>
            </div>
            
            <!-- Limpeza -->
            <div class="test-section">
                <h2>üóëÔ∏è Limpeza</h2>
                <p style="margin-bottom: 15px;">Remove dados de teste criados.</p>
                <button class="btn btn-danger" onclick="cleanupTestData()">üóëÔ∏è Limpar Dados de Teste</button>
            </div>
        </div>
    </div>

    <script>
        const orgId = 'org_default';
        const projectId = 'lkjfklczxctypetqxrhh';
        const publicAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxramZrbGN6eGN0eXBldHF4cmhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk5MDQ4MDQsImV4cCI6MjA0NTQ4MDgwNH0.cWo7Xdut-qiRG6gu-qUGVhsqxwI-95tg7z-FmMIlYf8';
        const baseUrl = `https://${projectId}.supabase.co/functions/v1/make-server-67caf26a`;

        let testContactId = null;
        let testChatId = null;

        async function fetchAPI(endpoint, options = {}) {
            try {
                const response = await fetch(`${baseUrl}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${publicAnonKey}`,
                        ...options.headers,
                    },
                });
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                console.error('Erro na requisi√ß√£o:', error);
                return { success: false, error: error.message };
            }
        }

        function showResult(elementId, success, message, data = null) {
            const resultDiv = document.getElementById(elementId);
            const className = success ? 'success' : 'error';
            const icon = success ? '‚úÖ' : '‚ùå';
            
            let html = `<div class="result ${className}">`;
            html += `${icon} ${message}\n\n`;
            if (data) {
                html += `Dados:\n${JSON.stringify(data, null, 2)}`;
            }
            html += `</div>`;
            
            resultDiv.innerHTML = html;
        }

        async function loadStatus() {
            console.log('üìä Carregando status...');
            
            // Contatos
            const contactsResult = await fetchAPI(`/whatsapp/data/contacts?organization_id=${orgId}`);
            document.getElementById('contacts-count').textContent = 
                contactsResult.success ? contactsResult.data.total : '‚ùå';
            
            // Conversas
            const chatsResult = await fetchAPI(`/whatsapp/data/chats?organization_id=${orgId}`);
            document.getElementById('chats-count').textContent = 
                chatsResult.success ? chatsResult.data.total : '‚ùå';
            
            // Mensagens
            const messagesResult = await fetchAPI(`/whatsapp/data/messages?organization_id=${orgId}&limit=1`);
            document.getElementById('messages-count').textContent = 
                messagesResult.success ? messagesResult.data.total : '‚ùå';
            
            // Configura√ß√£o
            const configResult = await fetchAPI(`/whatsapp/data/config?organization_id=${orgId}`);
            document.getElementById('config-status').textContent = 
                configResult.success ? '‚úÖ' : '‚ùå';
        }

        async function testSaveConfig() {
            const btn = document.getElementById('btn-test-1');
            btn.disabled = true;
            btn.textContent = '‚è≥ Testando...';
            
            const configData = {
                organization_id: orgId,
                autoSync: {
                    enabled: true,
                    interval: 5,
                },
                importFilters: {
                    onlyMyContacts: false,
                    excludeGroups: true,
                    onlyBusinessContacts: false,
                },
                autoLink: {
                    enabled: true,
                    linkByPhone: true,
                    createGuestIfNotFound: false,
                },
                notifications: {
                    newMessage: true,
                    newContact: false,
                    connectionStatus: true,
                },
            };
            
            const result = await fetchAPI(`/whatsapp/data/config`, {
                method: 'PUT',
                body: JSON.stringify(configData),
            });
            
            showResult('result-1', result.success, 
                result.success ? 'Configura√ß√£o salva com sucesso!' : 'Erro ao salvar configura√ß√£o',
                result.data
            );
            
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Executar Teste 1';
            await loadStatus();
        }

        async function testSaveContact() {
            const btn = document.getElementById('btn-test-2');
            btn.disabled = true;
            btn.textContent = '‚è≥ Testando...';
            
            const contactData = {
                organization_id: orgId,
                name: `Contato Teste ${Date.now()}`,
                phone_number: `5511${Math.floor(Math.random() * 100000000)}`,
                whatsapp_id: `test_${Date.now()}@s.whatsapp.net`,
                profile_picture_url: null,
                source: 'manual',
            };
            
            const result = await fetchAPI(`/whatsapp/data/contacts`, {
                method: 'POST',
                body: JSON.stringify(contactData),
            });
            
            if (result.success && result.data?.data) {
                testContactId = result.data.data.id;
            }
            
            showResult('result-2', result.success, 
                result.success ? `Contato criado com sucesso! ID: ${testContactId}` : 'Erro ao criar contato',
                result.data
            );
            
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Executar Teste 2';
            await loadStatus();
        }

        async function testSaveChat() {
            if (!testContactId) {
                showResult('result-3', false, 'Execute o Teste 2 primeiro para criar um contato!');
                return;
            }
            
            const btn = document.getElementById('btn-test-3');
            btn.disabled = true;
            btn.textContent = '‚è≥ Testando...';
            
            const chatData = {
                organization_id: orgId,
                whatsapp_chat_id: `chat_${Date.now()}@s.whatsapp.net`,
                contact_id: testContactId,
                contact_name: 'Contato Teste',
                contact_number: '5511999999999',
                lastMessage: {
                    content: 'Mensagem de teste',
                    timestamp: new Date().toISOString(),
                    fromMe: false,
                    type: 'text',
                },
            };
            
            const result = await fetchAPI(`/whatsapp/data/chats`, {
                method: 'POST',
                body: JSON.stringify(chatData),
            });
            
            if (result.success && result.data?.data) {
                testChatId = result.data.data.id;
            }
            
            showResult('result-3', result.success, 
                result.success ? `Conversa criada com sucesso! ID: ${testChatId}` : 'Erro ao criar conversa',
                result.data
            );
            
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Executar Teste 3';
            await loadStatus();
        }

        async function testSaveMessage() {
            if (!testChatId) {
                showResult('result-4', false, 'Execute o Teste 3 primeiro para criar uma conversa!');
                return;
            }
            
            const btn = document.getElementById('btn-test-4');
            btn.disabled = true;
            btn.textContent = '‚è≥ Testando...';
            
            const messageData = {
                organization_id: orgId,
                chat_id: testChatId,
                whatsapp_message_id: `msg_${Date.now()}`,
                content: `Mensagem de teste criada em ${new Date().toLocaleString('pt-BR')}`,
                type: 'text',
                fromMe: false,
                timestamp: new Date().toISOString(),
                sender_name: 'Sistema de Testes',
            };
            
            const result = await fetchAPI(`/whatsapp/data/messages`, {
                method: 'POST',
                body: JSON.stringify(messageData),
            });
            
            showResult('result-4', result.success, 
                result.success ? 'Mensagem criada com sucesso!' : 'Erro ao criar mensagem',
                result.data
            );
            
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Executar Teste 4';
            await loadStatus();
        }

        async function testSyncFromEvolution() {
            const btn = document.getElementById('btn-test-5');
            btn.disabled = true;
            btn.textContent = '‚è≥ Sincronizando...';
            
            showResult('result-5', true, 'Buscando contatos da Evolution API...');
            
            // Buscar contatos da Evolution
            const contactsResult = await fetchAPI(`/whatsapp/contacts`);
            
            if (!contactsResult.success) {
                showResult('result-5', false, 
                    'Erro ao buscar contatos da Evolution API. Verifique se est√° configurada.',
                    contactsResult
                );
                btn.disabled = false;
                btn.textContent = '‚ö° Executar Teste 5 (requer Evolution configurada)';
                return;
            }
            
            // Importar contatos
            const contacts = contactsResult.data?.data || [];
            if (contacts.length === 0) {
                showResult('result-5', true, 'Nenhum contato encontrado na Evolution API.');
                btn.disabled = false;
                btn.textContent = '‚ö° Executar Teste 5 (requer Evolution configurada)';
                return;
            }
            
            const importData = {
                organization_id: orgId,
                contacts: contacts.slice(0, 5).map(contact => ({ // Pega apenas 5 para teste
                    whatsapp_id: contact.id,
                    name: contact.pushName || contact.verifiedName || 'Sem nome',
                    phone_number: contact.id.split('@')[0],
                    profile_picture_url: contact.profilePictureUrl || null,
                    source: 'evolution',
                })),
            };
            
            const importResult = await fetchAPI(`/whatsapp/data/bulk-import-contacts`, {
                method: 'POST',
                body: JSON.stringify(importData),
            });
            
            showResult('result-5', importResult.success, 
                importResult.success ? 
                    `Sincroniza√ß√£o conclu√≠da!\n${importResult.data.results.imported} importados\n${importResult.data.results.updated} atualizados` : 
                    'Erro na sincroniza√ß√£o',
                importResult.data
            );
            
            btn.disabled = false;
            btn.textContent = '‚ö° Executar Teste 5 (requer Evolution configurada)';
            await loadStatus();
        }

        async function runAllTests() {
            const btn = document.getElementById('btn-all-tests');
            btn.disabled = true;
            btn.textContent = '‚è≥ Executando todos os testes...';
            
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            progressContainer.style.display = 'block';
            
            let currentTest = 0;
            const totalTests = 4;
            
            function updateProgress() {
                currentTest++;
                const percentage = (currentTest / totalTests) * 100;
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${Math.round(percentage)}%`;
            }
            
            let allSuccess = true;
            const results = [];
            
            // Teste 1
            await testSaveConfig();
            updateProgress();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Teste 2
            await testSaveContact();
            updateProgress();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Teste 3
            await testSaveChat();
            updateProgress();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Teste 4
            await testSaveMessage();
            updateProgress();
            
            showResult('result-all', true, 
                `‚úÖ Todos os testes conclu√≠dos!\n\nVerifique os resultados individuais acima.\n\nResumo:\n- Configura√ß√£o: ‚úÖ\n- Contato: ‚úÖ\n- Conversa: ‚úÖ\n- Mensagem: ‚úÖ`
            );
            
            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è Executar Todos os Testes';
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
            }, 2000);
        }

        async function cleanupTestData() {
            if (!confirm('Tem certeza que deseja limpar os dados de teste?')) {
                return;
            }
            
            // Por enquanto, apenas limpa localStorage
            const localKey = `whatsapp_config_${orgId}`;
            localStorage.removeItem(localKey);
            
            alert('‚úÖ localStorage limpo!\n\nNOTA: Para deletar dados do Supabase, use a interface administrativa.');
            await loadStatus();
        }

        // Carregar status inicial
        loadStatus();
    </script>
</body>
</html>
