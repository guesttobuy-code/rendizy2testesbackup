<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste An√∫ncio Ultimate - Campo por Campo</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 2rem;
    }
    h1 {
      color: #1a202c;
      margin-bottom: 0.5rem;
      font-size: 2rem;
    }
    .subtitle {
      color: #718096;
      margin-bottom: 2rem;
      font-size: 0.95rem;
    }
    .status-card {
      background: #f7fafc;
      border-left: 4px solid #4299e1;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-radius: 4px;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      color: #2d3748;
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    input, textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }
    textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.875rem 2rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .result {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .result.success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }
    .result.error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }
    .result pre {
      margin-top: 0.5rem;
      background: rgba(0,0,0,0.05);
      padding: 0.75rem;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85rem;
    }
    .test-section {
      background: #edf2f7;
      padding: 1.5rem;
      border-radius: 8px;
      margin-top: 2rem;
    }
    .test-section h3 {
      color: #2d3748;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }
    .btn-secondary {
      background: #48bb78;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéØ Teste An√∫ncio Ultimate</h1>
    <p class="subtitle">Valida√ß√£o campo-por-campo com persist√™ncia SQL garantida</p>

    <div class="status-card">
      <strong>Status da Infraestrutura:</strong>
      <div id="infraStatus">Verificando...</div>
    </div>

    <div class="form-group">
      <label for="title">Campo 1: T√≠tulo do An√∫ncio</label>
      <input 
        type="text" 
        id="title" 
        placeholder="Ex: Apartamento na Praia - Guaruj√°"
        value="Teste Campo Title - " 
      />
    </div>

    <div class="form-group">
      <label for="description">Campo 2: Descri√ß√£o</label>
      <textarea 
        id="description" 
        placeholder="Descri√ß√£o completa do im√≥vel..."
      >Teste de descri√ß√£o campo-por-campo com persist√™ncia SQL garantida.</textarea>
    </div>

    <button class="btn" onclick="testarSalvarCampo()" id="btnSalvar">
      üíæ Salvar Campos no SQL (via Edge Function)
    </button>

    <div id="result"></div>

    <div class="test-section">
      <h3>üîç Testar Recupera√ß√£o</h3>
      <div class="form-group">
        <label for="anuncioId">ID do An√∫ncio (copie do resultado acima)</label>
        <input type="text" id="anuncioId" placeholder="UUID do an√∫ncio">
      </div>
      <button class="btn btn-secondary" onclick="testarRecuperacao()">
        üì• Recuperar An√∫ncio do SQL
      </button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://odcgnzfremrqnvtitpcc.supabase.co';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kY2duemZyZW1ycW52dGl0cGNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM3NTEwMjQsImV4cCI6MjA0OTMyNzAyNH0.eoCUAU9TMSvj3SvQdGgYvxFXSq6uO8lxQpv_2g4CiWo';

    let currentAnuncioId = null;

    // Verificar infraestrutura
    async function verificarInfra() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/anuncios_ultimate?select=id&limit=1`, {
          headers: {
            'apikey': ANON_KEY,
            'Authorization': `Bearer ${ANON_KEY}`
          }
        });
        
        if (res.ok) {
          document.getElementById('infraStatus').innerHTML = 
            '‚úÖ Tabela <code>anuncios_ultimate</code> existe e est√° acess√≠vel!';
        } else if (res.status === 404 || res.status === 406) {
          const text = await res.text();
          document.getElementById('infraStatus').innerHTML = 
            `‚ùå Tabela n√£o encontrada. Erro: ${text}`;
        } else {
          document.getElementById('infraStatus').innerHTML = 
            `‚ö†Ô∏è Status HTTP ${res.status} - verificar permiss√µes RLS`;
        }
      } catch (err) {
        document.getElementById('infraStatus').innerHTML = 
          `‚ùå Erro de rede: ${err.message}`;
      }
    }

    async function testarSalvarCampo() {
      const btn = document.getElementById('btnSalvar');
      const resultDiv = document.getElementById('result');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Salvando no SQL...';
      resultDiv.innerHTML = '';

      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;

      try {
        // Salvar title
        const timestamp = Date.now();
        const res1 = await fetch(`${SUPABASE_URL}/functions/v1/anuncio-ultimate/save-field`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': ANON_KEY
          },
          body: JSON.stringify({
            anuncio_id: currentAnuncioId,
            field: 'title',
            value: title,
            idempotency_key: `title-${timestamp}`
          })
        });

        const data1 = await res1.json();
        
        if (!res1.ok) {
          throw new Error(`Erro ao salvar title: ${JSON.stringify(data1)}`);
        }

        currentAnuncioId = data1.anuncio?.id;
        document.getElementById('anuncioId').value = currentAnuncioId;

        // Salvar description
        const res2 = await fetch(`${SUPABASE_URL}/functions/v1/anuncio-ultimate/save-field`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': ANON_KEY
          },
          body: JSON.stringify({
            anuncio_id: currentAnuncioId,
            field: 'description',
            value: description,
            idempotency_key: `description-${timestamp}`
          })
        });

        const data2 = await res2.json();
        
        if (!res2.ok) {
          throw new Error(`Erro ao salvar description: ${JSON.stringify(data2)}`);
        }

        resultDiv.innerHTML = `
          <div class="result success">
            <strong>‚úÖ SUCESSO! Campos salvos no SQL</strong>
            <pre>${JSON.stringify(data2.anuncio, null, 2)}</pre>
            <p style="margin-top: 1rem;"><strong>ID:</strong> ${currentAnuncioId}</p>
          </div>
        `;

      } catch (err) {
        resultDiv.innerHTML = `
          <div class="result error">
            <strong>‚ùå ERRO ao salvar:</strong>
            <pre>${err.message}</pre>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üíæ Salvar Campos no SQL (via Edge Function)';
      }
    }

    async function testarRecuperacao() {
      const anuncioId = document.getElementById('anuncioId').value;
      const resultDiv = document.getElementById('result');

      if (!anuncioId) {
        resultDiv.innerHTML = `
          <div class="result error">
            <strong>‚ùå Digite um ID de an√∫ncio</strong>
          </div>
        `;
        return;
      }

      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/anuncio-ultimate/${anuncioId}`, {
          headers: {
            'apikey': ANON_KEY
          }
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(JSON.stringify(data));
        }

        resultDiv.innerHTML = `
          <div class="result success">
            <strong>‚úÖ An√∫ncio recuperado do SQL:</strong>
            <pre>${JSON.stringify(data.anuncio, null, 2)}</pre>
          </div>
        `;

        // Preencher campos com dados recuperados
        if (data.anuncio?.data) {
          if (data.anuncio.data.title) {
            document.getElementById('title').value = data.anuncio.data.title;
          }
          if (data.anuncio.data.description) {
            document.getElementById('description').value = data.anuncio.data.description;
          }
        }

      } catch (err) {
        resultDiv.innerHTML = `
          <div class="result error">
            <strong>‚ùå Erro ao recuperar:</strong>
            <pre>${err.message}</pre>
          </div>
        `;
      }
    }

    // Verificar ao carregar
    verificarInfra();
  </script>
</body>
</html>
