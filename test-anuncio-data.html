<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test An√∫ncio Data</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .field {
            margin: 10px 0;
            padding: 10px;
            background: #1e1e1e;
            border-left: 3px solid #007acc;
        }
        .field-name {
            color: #9cdcfe;
            font-weight: bold;
        }
        .field-value {
            color: #ce9178;
            margin-left: 20px;
        }
        .missing {
            color: #f48771;
            border-left-color: #f48771;
        }
        .present {
            color: #4ec9b0;
            border-left-color: #4ec9b0;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #1177bb;
        }
        pre {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            color: #d4d4d4;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.ok {
            background: #0e7c45;
            color: white;
        }
        .status.missing {
            background: #a1260d;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #4ec9b0;
        }
    </style>
</head>
<body>
    <h1>üîç Teste de Dados do An√∫ncio</h1>
    
    <div>
        <button onclick="loadData()">üîÑ Carregar Dados</button>
        <button onclick="testSave()">üíæ Testar Salvamento</button>
    </div>

    <div id="loading" class="loading" style="display: none;">
        Carregando dados do banco...
    </div>

    <div id="results"></div>

    <script>
        const SUPABASE_URL = 'https://oalqkctksrcdsufobfzx.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hbHFrY3Rrc3JjZHN1Zm9iZnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQwMjc4OTEsImV4cCI6MjA0OTYwMzg5MX0.qSwfGdX_wXn_YFEIkQp-3SgAJFZyYH-SWGDOoLvBGkE';

        async function loadData() {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            loading.style.display = 'block';
            results.innerHTML = '';

            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/anuncios_ultimate?select=*&order=created_at.desc&limit=1`, {
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const anuncios = await res.json();
                
                loading.style.display = 'none';

                if (!anuncios || anuncios.length === 0) {
                    results.innerHTML = '<div class="section"><h2>‚ùå Nenhum an√∫ncio encontrado</h2></div>';
                    return;
                }

                const anuncio = anuncios[0];
                displayResults(anuncio);

            } catch (error) {
                loading.style.display = 'none';
                results.innerHTML = `<div class="section"><h2>‚ùå Erro ao carregar: ${error.message}</h2></div>`;
            }
        }

        function displayResults(anuncio) {
            const results = document.getElementById('results');
            const data = anuncio.data || {};

            // Campos que devem existir
            const requiredFields = {
                'title': 'T√≠tulo/Identifica√ß√£o',
                'internalId': 'ID Interno (para card)',
                'address': 'Endere√ßo (objeto)',
                'bedrooms': 'Quartos',
                'bathrooms': 'Banheiros',
                'beds': 'Camas',
                'guests': 'H√≥spedes'
            };

            let html = `
                <div class="section">
                    <h2>üìä An√∫ncio ID: ${anuncio.id}</h2>
                    <p>Criado em: ${new Date(anuncio.created_at).toLocaleString('pt-BR')}</p>
                    <p>Status: <span class="status ${anuncio.status || 'missing'}">${anuncio.status || 'n√£o definido'}</span></p>
                </div>

                <div class="section">
                    <h2>‚úÖ Campos Obrigat√≥rios</h2>
            `;

            let allPresent = true;

            for (const [field, label] of Object.entries(requiredFields)) {
                const exists = data[field] !== undefined && data[field] !== null;
                const value = data[field];
                
                if (!exists) allPresent = false;

                html += `
                    <div class="field ${exists ? 'present' : 'missing'}">
                        <span class="field-name">${label} (${field}):</span>
                        <span class="status ${exists ? 'ok' : 'missing'}">${exists ? '‚úì OK' : '‚úó FALTA'}</span>
                        <div class="field-value">${exists ? JSON.stringify(value, null, 2) : 'undefined'}</div>
                    </div>
                `;
            }

            html += '</div>';

            // Dados completos
            html += `
                <div class="section">
                    <h2>üìù Dados Completos (JSON)</h2>
                    <pre>${JSON.stringify(anuncio, null, 2)}</pre>
                </div>
            `;

            // Diagn√≥stico
            html += `
                <div class="section">
                    <h2>üî¨ Diagn√≥stico</h2>
                    ${allPresent 
                        ? '<p style="color: #4ec9b0;">‚úÖ Todos os campos est√£o presentes! O card deve funcionar.</p>'
                        : '<p style="color: #f48771;">‚ùå Campos faltando! O wizard N√ÉO est√° salvando corretamente.</p>'
                    }
                </div>
            `;

            results.innerHTML = html;
        }

        async function testSave() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="section"><h2>üß™ Testando salvamento...</h2></div>';

            try {
                // Buscar o primeiro an√∫ncio
                const res = await fetch(`${SUPABASE_URL}/rest/v1/anuncios_ultimate?select=*&order=created_at.desc&limit=1`, {
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const anuncios = await res.json();
                if (!anuncios || anuncios.length === 0) {
                    results.innerHTML = '<div class="section"><h2>‚ùå Nenhum an√∫ncio para testar</h2></div>';
                    return;
                }

                const anuncioId = anuncios[0].id;

                // Testar salvamento do internalId
                const testUrl = `${SUPABASE_URL}/functions/v1/rendizy-server/anuncios-ultimate/save-field`;
                
                const testData = {
                    anuncio_id: anuncioId,
                    field: 'internalId',
                    value: 'TESTE ' + new Date().toLocaleTimeString()
                };

                const saveRes = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ANON_KEY}`
                    },
                    body: JSON.stringify(testData)
                });

                const saveResult = await saveRes.json();

                results.innerHTML = `
                    <div class="section">
                        <h2>üß™ Resultado do Teste de Salvamento</h2>
                        <p><strong>Status HTTP:</strong> ${saveRes.status} ${saveRes.ok ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>Campo testado:</strong> internalId</p>
                        <p><strong>Valor enviado:</strong> ${testData.value}</p>
                        <pre>${JSON.stringify(saveResult, null, 2)}</pre>
                        ${saveRes.ok 
                            ? '<p style="color: #4ec9b0;">‚úÖ Salvamento funcionou! Clique em "Carregar Dados" para ver o resultado.</p>'
                            : '<p style="color: #f48771;">‚ùå Erro no salvamento! Verifique o RPC function.</p>'
                        }
                    </div>
                `;

            } catch (error) {
                results.innerHTML = `<div class="section"><h2>‚ùå Erro no teste: ${error.message}</h2></div>`;
            }
        }

        // Carregar automaticamente ao abrir
        window.onload = () => loadData();
    </script>
</body>
</html>
